(()=>{"use strict";const e=window.React,t=window.wp.element,l=window.wp.hooks,i=window.wp.compose,a=window.wp.blockEditor,o=window.wp.components,n=window.wp.i18n,r=window.wp.date,s=window.wp.data,c=["core/group"],u=({label:t,variant:l="",screenReaderText:i=""})=>{const a=["visibloc-status-badge"];return"string"==typeof l&&l.trim()&&a.push(`visibloc-status-badge--${l.trim()}`),(0,e.createElement)("span",{className:a.join(" ")},t,i?(0,e.createElement)("span",{className:"screen-reader-text"},i):null)},b=e=>Array.isArray(e)?Array.from(new Set(e.map(e=>"string"==typeof e?e.trim():"").filter(Boolean))):[],d=b("object"==typeof VisiBlocData&&null!==VisiBlocData&&Array.isArray(VisiBlocData.supportedBlocks)?VisiBlocData.supportedBlocks:c),m=d.length>0?d:c,p=b((0,l.applyFilters)("visiblocSupportedBlocks",m)),g=p.length>0?p:m,v=e=>g.includes(e),f="function"==typeof r.__experimentalGetSettings?(0,r.__experimentalGetSettings)():{},{formats:_={}}=f||{},y="string"==typeof _.date&&_.date.trim()?_.date:"F j, Y",h="string"==typeof _.time&&_.time.trim()?_.time:"H:i",j="string"==typeof _.datetime&&_.datetime.trim()?_.datetime:`${y} ${h}`.trim(),k=(e=>{if(!e||"object"!=typeof e)return!1;if("boolean"==typeof e.twelveHourTime)return e.twelveHourTime;const{formats:t}=e;if(t&&"object"==typeof t){const{time:e}=t;if("string"==typeof e&&e.trim())return/a(?!\\)/i.test(e)}return!1})(f),E=(()=>{if(!f||"object"!=typeof f)return"UTC";const{timezone:e,timezoneAbbr:t,gmt_offset:l}=f;if(e&&"object"==typeof e){if("string"==typeof e.string&&e.string.trim())return e.string.trim();if("string"==typeof e.abbr&&e.abbr.trim())return e.abbr.trim()}if("string"==typeof e&&e.trim())return e.trim();if("string"==typeof t&&t.trim())return t.trim();return(e=>{if("number"!=typeof e||Number.isNaN(e))return"";if(0===e)return"UTC";const t=e>0?"+":"-",l=Math.abs(e),i=Math.round(60*l),a=Math.floor(i/60),o=i%60;return`UTC${t}${String(a).padStart(2,"0")}:${String(o).padStart(2,"0")}`})(l)||"UTC"})(),C=e=>e?"function"==typeof r.dateI18n?(0,r.dateI18n)(j,e):(0,r.format)(j,e):null,B=()=>(0,r.format)("Y-m-d\\TH:i:s",new Date),w=e=>{if(!e)return null;const t=new Date(e);return Number.isNaN(t.getTime())?null:t},x={id:"all",label:(0,n.__)("Visible sur tous les appareils","visi-bloc-jlg")},T=[{id:"show-only",label:(0,n.__)("Afficher uniquement","visi-bloc-jlg"),options:[{id:"desktop-only",label:(0,n.__)("Desktop","visi-bloc-jlg"),icon:"desktop"},{id:"tablet-only",label:(0,n.__)("Tablette","visi-bloc-jlg"),icon:"tablet"},{id:"mobile-only",label:(0,n.__)("Mobile","visi-bloc-jlg"),icon:"smartphone"}]},{id:"hide-on",label:(0,n.__)("Masquer sur","visi-bloc-jlg"),options:[{id:"hide-on-desktop",label:(0,n.__)("Desktop","visi-bloc-jlg"),icon:"desktop"},{id:"hide-on-tablet",label:(0,n.__)("Tablette","visi-bloc-jlg"),icon:"tablet"},{id:"hide-on-mobile",label:(0,n.__)("Mobile","visi-bloc-jlg"),icon:"smartphone"}]}],A=T.reduce((e,t)=>t&&Array.isArray(t.options)?e.concat(t.options):e,[]),N=["post_type","taxonomy","template","recurring_schedule"],S=Object.freeze({logic:"AND",rules:[]}),D=Object.freeze({frequency:"daily",days:[],startTime:"08:00",endTime:"17:00"}),F=e=>{if("object"!=typeof VisiBlocData||null===VisiBlocData)return[];const t=VisiBlocData[e];return Array.isArray(t)?t:[]},V=e=>{if("object"!=typeof VisiBlocData||null===VisiBlocData)return null;const t=VisiBlocData[e];return t&&"object"==typeof t?t:null},H=e=>{if(!e||"object"!=typeof e)return!1;const t=void 0===e.fallbackEnabled||Boolean(e.fallbackEnabled),l="string"==typeof e.fallbackBehavior?e.fallbackBehavior:"inherit";if(!t)return!1;if("text"===l)return("string"==typeof e.fallbackCustomText?e.fallbackCustomText:"").trim().length>0;if("block"===l)return Boolean(e.fallbackBlockId);const i=V("fallbackSettings")||{};return Boolean(i&&i.hasContent)},O=(()=>{const e=F("daysOfWeek"),t=new Map;return e.forEach(e=>{e&&"object"==typeof e&&"string"==typeof e.value&&t.set(e.value,e.label||e.value)}),t})(),q=()=>`rule-${Math.random().toString(36).slice(2)}-${Date.now()}`,R=e=>{if(!Array.isArray(e)||!e.length)return"";const t=e.find(e=>e&&void 0!==e.value);if(!t)return"";const l=void 0===t.value||null===t.value?"":t.value;return String(l)},$=e=>{switch(e){case"taxonomy":return(()=>{const e=F("taxonomies").find(e=>e&&"string"==typeof e.slug);return{id:q(),type:"taxonomy",operator:"in",taxonomy:e?e.slug:"",terms:[]}})();case"template":return(()=>{const e=F("templates");return{id:q(),type:"template",operator:"is",value:R(e)}})();case"recurring_schedule":return{id:q(),type:"recurring_schedule",operator:"matches",...D};default:return(()=>{const e=F("postTypes");return{id:q(),type:"post_type",operator:"is",value:R(e)}})()}},I=e=>{if(!e||"object"!=typeof e)return null;const{type:t}=e;if(!N.includes(t))return null;const l={id:"string"==typeof e.id&&e.id?e.id:q(),type:t};return"post_type"===t?(l.operator="is_not"===e.operator?"is_not":"is",l.value="string"==typeof e.value?e.value:"",l):"taxonomy"===t?(l.operator="not_in"===e.operator?"not_in":"in",l.taxonomy="string"==typeof e.taxonomy?e.taxonomy:"",l.terms=Array.isArray(e.terms)?e.terms.map(e=>"string"==typeof e||"number"==typeof e?String(e):"").filter(Boolean):[],l):"template"===t?(l.operator="is_not"===e.operator?"is_not":"is",l.value="string"==typeof e.value?e.value:"",l):(l.operator="matches",l.frequency="weekly"===e.frequency?"weekly":"daily",l.days=Array.isArray(e.days)?e.days.map(e=>"string"==typeof e?e:"").filter(e=>O.has(e)):[],l.startTime="string"==typeof e.startTime?e.startTime:D.startTime,l.endTime="string"==typeof e.endTime?e.endTime:D.endTime,l)},L=e=>e&&"object"==typeof e?{logic:"OR"===e.logic?"OR":"AND",rules:Array.isArray(e.rules)?e.rules.map(I).filter(Boolean):[]}:{logic:S.logic,rules:[...S.rules]},M=(0,i.createHigherOrderComponent)(l=>i=>{if(!v(i.name))return(0,e.createElement)(l,{...i});const{attributes:r,setAttributes:s,isSelected:c}=i,{isHidden:u,deviceVisibility:b,isSchedulingEnabled:d,publishStartDate:m,publishEndDate:p,visibilityRoles:g,advancedVisibility:f,fallbackEnabled:_=!0,fallbackBehavior:y="inherit",fallbackCustomText:h="",fallbackBlockId:j}=r,S=L(f),D=V("fallbackSettings")||{},H=Boolean(D&&D.hasContent),q=D&&"string"==typeof D.summary?D.summary:"",R=F("fallbackBlocks").filter(e=>e&&"object"==typeof e).map(e=>{const t="number"==typeof e.value?e.value:parseInt(e.value,10),l=Number.isNaN(t)?0:t;return{value:String(l),label:"string"==typeof e.label&&e.label.trim()?e.label:`#${l}`}}),M=[{value:"inherit",label:(0,n.__)("Utiliser le repli global","visi-bloc-jlg")},{value:"text",label:(0,n.__)("Texte personnalisé","visi-bloc-jlg")},{value:"block",label:(0,n.__)("Bloc réutilisable","visi-bloc-jlg")}],z=e=>{const t=L({...S}),l=e(t)||t;s({advancedVisibility:L(l)})},P=(e,t)=>{const l=e?[...g,t]:g.filter(e=>e!==t);s({visibilityRoles:l})};let U=(0,n.__)("Aucune programmation.","visi-bloc-jlg");const G=(0,n.sprintf)((0,n.__)("Fuseau horaire : %s","visi-bloc-jlg"),E),J=w(m),Y=w(p),Q=d&&!!J&&!!Y&&Y.getTime()<J.getTime();if(d){const e=C(m),t=C(p);
/* translators: 1: Start date, 2: end date. */
U=e&&t?(0,n.sprintf)((0,n.__)("Du %s au %s.","visi-bloc-jlg"),e,t):e?(0,n.sprintf)((0,n.__)("À partir du %s.","visi-bloc-jlg"),e):t?(0,n.sprintf)((0,n.__)("Jusqu'au %s.","visi-bloc-jlg"),t):(0,n.__)("Activée, mais sans date définie.","visi-bloc-jlg"),Q&&(U=(0,n.__)("Dates de programmation invalides.","visi-bloc-jlg"))}const W=(0,n.__)("Inactif","visi-bloc-jlg"),K=(l,i)=>(0,e.createElement)(t.Fragment,null,(0,e.createElement)("span",null,l),(0,e.createElement)("span",{className:"components-panel__summary"},i&&String(i).trim()?i:W)),X=(()=>{if(!b||b===x.id)return"";const e=T.find(e=>!!Array.isArray(e.options)&&e.options.some(e=>e.id===b)),t=A.find(e=>e.id===b);return t?e?`${e.label} – ${t.label}`:t.label:""})(),Z=d?Q?(0,n.__)("Erreur de dates","visi-bloc-jlg"):m&&p?(0,n.__)("Plage définie","visi-bloc-jlg"):m||p?(0,n.__)("Date définie","visi-bloc-jlg"):(0,n.__)("Programmation active","visi-bloc-jlg"):"",ee=(()=>{const e=Array.from(new Set((g||[]).filter(Boolean))).length;return e?(0,n.sprintf)((0,n._n)("%d rôle","%d rôles",e,"visi-bloc-jlg"),e):""})(),te=(()=>{const e=Array.isArray(S.rules)?S.rules.length:0;if(!e)return"";const t="OR"===S.logic?(0,n.__)("OU","visi-bloc-jlg"):(0,n.__)("ET","visi-bloc-jlg");return(0,n.sprintf)((0,n._n)("%1$d règle %2$s","%1$d règles %2$s",e,"visi-bloc-jlg"),e,t)})(),le=(()=>{if(!_)return"";const e={inherit:(0,n.__)("Global","visi-bloc-jlg"),text:(0,n.__)("Texte","visi-bloc-jlg"),block:(0,n.__)("Bloc","visi-bloc-jlg")};return"block"!==y||j?e[y]||e.inherit:(0,n.__)("Bloc","visi-bloc-jlg")})();return(0,e.createElement)(t.Fragment,null,(0,e.createElement)(l,{...i}),c&&(0,e.createElement)(t.Fragment,null,(0,e.createElement)(a.BlockControls,null,(0,e.createElement)(o.ToolbarGroup,null,(0,e.createElement)(o.ToolbarButton,{icon:"visibility",label:(0,n.__)("Rendre visible","visi-bloc-jlg"),onClick:()=>s({isHidden:!1}),isActive:!1===u}),(0,e.createElement)(o.ToolbarButton,{icon:"hidden",label:(0,n.__)("Rendre caché","visi-bloc-jlg"),onClick:()=>s({isHidden:!0}),isActive:!0===u}))),(0,e.createElement)(a.InspectorControls,null,(0,e.createElement)(o.PanelBody,{title:K((0,n.__)("Contrôles de Visibilité","visi-bloc-jlg"),X),initialOpen:!0},(0,e.createElement)(o.BaseControl,{label:(0,n.__)("Visibilité par Appareil","visi-bloc-jlg")},(0,e.createElement)("div",{className:"visi-bloc-device-toggle-groups"},T.map(t=>{const l=t.options.some(e=>e.id===b);return(0,e.createElement)("div",{key:t.id,className:"visi-bloc-device-toggle-group"},(0,e.createElement)(o.BaseControl.VisualLabel,null,t.label),(0,e.createElement)(o.ToggleGroupControl,{className:"visi-bloc-device-toggle",isBlock:!0,isDeselectable:!0,value:l?b:void 0,onChange:e=>s({deviceVisibility:e||x.id})},t.options.map(t=>(0,e.createElement)(o.ToggleGroupControlOptionIcon,{key:t.id,value:t.id,icon:t.icon,label:t.label}))))}),(0,e.createElement)(o.Button,{className:"visi-bloc-device-toggle-reset",variant:"link",isLink:!0,onClick:()=>s({deviceVisibility:x.id}),disabled:b===x.id},x.label)))),(0,e.createElement)(o.PanelBody,{title:K((0,n.__)("Programmation","visi-bloc-jlg"),Z),initialOpen:!1,className:"visi-bloc-panel-schedule"},(0,e.createElement)(o.ToggleControl,{label:(0,n.__)("Activer la programmation","visi-bloc-jlg"),checked:d,onChange:()=>s({isSchedulingEnabled:!d})}),d&&(0,e.createElement)("div",null,(0,e.createElement)("p",{style:{fontStyle:"italic",color:"#555"}},U),Q&&(0,e.createElement)(o.Notice,{status:"error",isDismissible:!1},(0,n.__)("La date de fin doit être postérieure à la date de début.","visi-bloc-jlg")),(0,e.createElement)("p",{style:{fontStyle:"italic",color:"#555"}},G),(0,e.createElement)(o.CheckboxControl,{label:(0,n.__)("Définir une date de début","visi-bloc-jlg"),checked:!!m,onChange:e=>{s({publishStartDate:e?B():void 0})}}),!!m&&(0,e.createElement)("div",{className:"visi-bloc-datepicker-wrapper"},(0,e.createElement)(o.DateTimePicker,{currentDate:m,onChange:e=>s({publishStartDate:e}),is12Hour:k})),(0,e.createElement)(o.CheckboxControl,{label:(0,n.__)("Définir une date de fin","visi-bloc-jlg"),checked:!!p,onChange:e=>{s({publishEndDate:e?B():void 0})}}),!!p&&(0,e.createElement)("div",{className:"visi-bloc-datepicker-wrapper"},(0,e.createElement)(o.DateTimePicker,{currentDate:p,onChange:e=>s({publishEndDate:e}),is12Hour:k})))),(0,e.createElement)(o.PanelBody,{title:K((0,n.__)("Visibilité par Rôle","visi-bloc-jlg"),ee),initialOpen:!1},(0,e.createElement)("p",null,(0,n.__)("N'afficher que pour les rôles sélectionnés. Laisser vide pour afficher à tout le monde.","visi-bloc-jlg")),(0,e.createElement)(o.CheckboxControl,{label:(0,n.__)("Visiteurs Déconnectés","visi-bloc-jlg"),checked:g.includes("logged-out"),onChange:e=>P(e,"logged-out")}),(0,e.createElement)(o.CheckboxControl,{label:(0,n.__)("Utilisateurs Connectés (tous)","visi-bloc-jlg"),checked:g.includes("logged-in"),onChange:e=>P(e,"logged-in")}),(0,e.createElement)("hr",null),Object.entries(VisiBlocData.roles||{}).sort(([,e],[,t])=>String(e).localeCompare(String(t))).map(([t,l])=>(0,e.createElement)(o.CheckboxControl,{key:t,label:l,checked:g.includes(t),onChange:e=>P(e,t)}))),(0,e.createElement)(o.PanelBody,{title:K((0,n.__)("Règles de visibilité avancées","visi-bloc-jlg"),te),initialOpen:!1},(0,e.createElement)(SelectControl,{label:(0,n.__)("Logique entre les règles","visi-bloc-jlg"),value:S.logic,options:[{value:"AND",label:(0,n.__)("Toutes les règles doivent être vraies (ET)","visi-bloc-jlg")},{value:"OR",label:(0,n.__)("Au moins une règle doit être vraie (OU)","visi-bloc-jlg")}],onChange:e=>z(t=>({...t,logic:"OR"===e?"OR":"AND"}))}),S.rules.map((t,l)=>((t,l)=>{const i=e=>{z(i=>{const a=[...i.rules];return a[l]=I({...t,...e}),{...i,rules:a}})},a=(0,e.createElement)(o.Flex,{align:"center",wrap:!0},(0,e.createElement)(o.FlexBlock,null,(0,e.createElement)(SelectControl,{label:(0,n.__)("Type de règle","visi-bloc-jlg"),value:t.type,options:[{value:"post_type",label:(0,n.__)("Type de contenu","visi-bloc-jlg")},{value:"taxonomy",label:(0,n.__)("Taxonomie","visi-bloc-jlg")},{value:"template",label:(0,n.__)("Modèle de page","visi-bloc-jlg")},{value:"recurring_schedule",label:(0,n.__)("Horaire récurrent","visi-bloc-jlg")}],onChange:e=>{N.includes(e)&&z(t=>{const i=[...t.rules],a=$(e);return i[l]=a,{...t,rules:i}})}})),(0,e.createElement)(o.FlexItem,null,(0,e.createElement)(o.Button,{isDestructive:!0,variant:"tertiary",onClick:()=>{z(e=>{const t=e.rules.filter((e,t)=>t!==l);return{...e,rules:t}})}},(0,n.__)("Supprimer","visi-bloc-jlg"))));if("post_type"===t.type){const l=F("postTypes").map(e=>({value:e.value,label:e.label}));return(0,e.createElement)("div",{key:t.id,className:"visibloc-advanced-rule"},a,(0,e.createElement)(SelectControl,{label:(0,n.__)("Condition","visi-bloc-jlg"),value:t.operator,options:[{value:"is",label:(0,n.__)("Est","visi-bloc-jlg")},{value:"is_not",label:(0,n.__)("N’est pas","visi-bloc-jlg")}],onChange:e=>i({operator:e})}),(0,e.createElement)(SelectControl,{label:(0,n.__)("Type de contenu","visi-bloc-jlg"),value:t.value,options:l,onChange:e=>i({value:e})}))}if("taxonomy"===t.type){const l=F("taxonomies"),r=l.find(e=>e.slug===t.taxonomy),s=l.map(e=>({value:e.slug,label:e.label})),c=(r&&Array.isArray(r.terms)?r.terms:[]).map(e=>({value:e.value,label:e.label})),u=(e,l)=>{const a=String(l),o=e?[...t.terms,a]:t.terms.filter(e=>e!==a);i({terms:o})};return(0,e.createElement)("div",{key:t.id,className:"visibloc-advanced-rule"},a,(0,e.createElement)(SelectControl,{label:(0,n.__)("Taxonomie","visi-bloc-jlg"),value:t.taxonomy,options:s,onChange:e=>i({taxonomy:e,terms:[]})}),(0,e.createElement)(SelectControl,{label:(0,n.__)("Condition","visi-bloc-jlg"),value:t.operator,options:[{value:"in",label:(0,n.__)("Inclut au moins un terme","visi-bloc-jlg")},{value:"not_in",label:(0,n.__)("Exclut tous les termes","visi-bloc-jlg")}],onChange:e=>i({operator:e})}),c.length>0?(0,e.createElement)("div",{className:"visibloc-advanced-rule__terms"},c.map(l=>(0,e.createElement)(o.CheckboxControl,{key:l.value,label:l.label,checked:t.terms.includes(l.value),onChange:e=>u(e,l.value)}))):(0,e.createElement)("p",{className:"components-help-text"},(0,n.__)("Aucun terme disponible pour cette taxonomie.","visi-bloc-jlg")))}if("template"===t.type){const l=F("templates").map(e=>({value:e.value,label:e.label}));return(0,e.createElement)("div",{key:t.id,className:"visibloc-advanced-rule"},a,(0,e.createElement)(SelectControl,{label:(0,n.__)("Condition","visi-bloc-jlg"),value:t.operator,options:[{value:"is",label:(0,n.__)("Est","visi-bloc-jlg")},{value:"is_not",label:(0,n.__)("N’est pas","visi-bloc-jlg")}],onChange:e=>i({operator:e})}),(0,e.createElement)(SelectControl,{label:(0,n.__)("Modèle","visi-bloc-jlg"),value:t.value,options:l,onChange:e=>i({value:e})}))}const r=e=>t=>{const l=t&&t.target?t.target.value:"",a="string"==typeof l?l:"";i({[e]:a})};return(0,e.createElement)("div",{key:t.id,className:"visibloc-advanced-rule"},a,(0,e.createElement)(SelectControl,{label:(0,n.__)("Fréquence","visi-bloc-jlg"),value:t.frequency,options:[{value:"daily",label:(0,n.__)("Quotidien","visi-bloc-jlg")},{value:"weekly",label:(0,n.__)("Hebdomadaire","visi-bloc-jlg")}],onChange:e=>i({frequency:e,days:"weekly"===e?t.days:[]})}),(0,e.createElement)(o.Flex,{gap:"small"},(0,e.createElement)(o.FlexBlock,null,(0,e.createElement)(o.BaseControl,{label:(0,n.__)("Heure de début","visi-bloc-jlg")},(0,e.createElement)("input",{type:"time",value:t.startTime||"",onChange:r("startTime"),className:"components-text-control__input"}))),(0,e.createElement)(o.FlexBlock,null,(0,e.createElement)(o.BaseControl,{label:(0,n.__)("Heure de fin","visi-bloc-jlg")},(0,e.createElement)("input",{type:"time",value:t.endTime||"",onChange:r("endTime"),className:"components-text-control__input"})))),"weekly"===t.frequency&&O.size>0&&(0,e.createElement)("div",{className:"visibloc-advanced-rule__days"},(0,e.createElement)("p",{className:"components-base-control__label"},(0,n.__)("Jours actifs","visi-bloc-jlg")),Array.from(O.entries()).map(([l,a])=>(0,e.createElement)(o.CheckboxControl,{key:l,label:a,checked:t.days.includes(l),onChange:e=>((e,l)=>{const a=e?[...new Set([...t.days,l])]:t.days.filter(e=>e!==l);i({days:a})})(e,l)}))))})(t,l)),(0,e.createElement)(o.Button,{variant:"secondary",onClick:()=>z(e=>({...e,rules:[...e.rules,$("post_type")]}))},(0,n.__)("Ajouter une règle","visi-bloc-jlg")),(0,e.createElement)("p",{className:"components-help-text"},(0,n.__)("Ces règles permettent d’affiner la visibilité selon le contexte du contenu, le modèle ou un horaire récurrent.","visi-bloc-jlg"))),(0,e.createElement)(o.PanelBody,{title:K((0,n.__)("Contenu de repli","visi-bloc-jlg"),le),initialOpen:!1},(0,e.createElement)(o.ToggleControl,{label:(0,n.__)("Activer le repli pour ce bloc","visi-bloc-jlg"),checked:_,onChange:()=>s({fallbackEnabled:!_})}),!_&&(0,e.createElement)(o.Notice,{status:"info",isDismissible:!1},(0,n.__)("Aucun contenu de repli ne sera affiché si ce bloc est masqué.","visi-bloc-jlg")),_&&(0,e.createElement)(t.Fragment,null,(0,e.createElement)(SelectControl,{label:(0,n.__)("Source du repli","visi-bloc-jlg"),value:y,options:M,onChange:e=>s({fallbackBehavior:M.some(t=>t.value===e)?e:"inherit"})}),"inherit"===y&&(H?(0,e.createElement)(o.Notice,{status:"info",isDismissible:!1},q?(0,n.sprintf)((0,n.__)("Repli global : %s","visi-bloc-jlg"),q):(0,n.__)("Un repli global est configuré.","visi-bloc-jlg")):(0,e.createElement)(o.Notice,{status:"warning",isDismissible:!1},(0,n.__)("Aucun repli global n’est actuellement défini.","visi-bloc-jlg"))),"text"===y&&(0,e.createElement)(o.TextareaControl,{label:(0,n.__)("Texte affiché en repli","visi-bloc-jlg"),help:(0,n.__)("Ce texte remplace le bloc lorsque les visiteurs n’y ont pas accès.","visi-bloc-jlg"),value:h,onChange:e=>s({fallbackCustomText:e})}),"block"===y&&(0,e.createElement)(t.Fragment,null,(0,e.createElement)(SelectControl,{label:(0,n.__)("Bloc réutilisable à afficher","visi-bloc-jlg"),value:j?String(j):"",options:[{value:"",label:(0,n.__)("— Sélectionnez un bloc —","visi-bloc-jlg")},...R],onChange:e=>{const t=parseInt(e,10);s({fallbackBlockId:Number.isNaN(t)?0:t})},disabled:!R.length}),!R.length&&(0,e.createElement)(o.Notice,{status:"warning",isDismissible:!1},(0,n.__)("Aucun bloc réutilisable publié n’est disponible.","visi-bloc-jlg"))))))))},"withVisibilityControls"),z=new Map,P=new Map;let U=null;function G(){const e=(0,s.select)("core/edit-post");return!!e&&("function"==typeof e.isListViewOpened?e.isListViewOpened():"function"==typeof e.isFeatureActive&&e.isFeatureActive("listView"))}function J(){if("undefined"==typeof document)return void(U=null);const e=new Map;P.forEach((t,l)=>{const i=document.querySelector(`.block-editor-list-view__block[data-block="${l}"]`);i?(t.isHidden?i.classList.add("bloc-editeur-cache"):i.classList.remove("bloc-editeur-cache"),t.hasFallback?i.classList.add("bloc-editeur-repli"):i.classList.remove("bloc-editeur-repli")):e.set(l,t)}),P.clear(),e.size&&e.forEach((e,t)=>{P.set(t,e)}),U=P.size&&G()?window.requestAnimationFrame(()=>{J()}):null}function Y(e,t){const l=P.get(e);l&&l.isHidden===t.isHidden&&l.hasFallback===t.hasFallback||(P.set(e,t),U||(U=window.requestAnimationFrame(()=>{J()})))}(0,l.addFilter)("blocks.registerBlockType","visi-bloc-jlg/add-visibility-attributes",function(e,t){return v(t)?(e.attributes={...e.attributes,isHidden:{type:"boolean",default:!1},deviceVisibility:{type:"string",default:"all"},isSchedulingEnabled:{type:"boolean",default:!1},publishStartDate:{type:"string"},publishEndDate:{type:"string"},visibilityRoles:{type:"array",default:[]},advancedVisibility:{type:"object",default:S},fallbackEnabled:{type:"boolean",default:!0},fallbackBehavior:{type:"string",default:"inherit"},fallbackCustomText:{type:"string",default:""},fallbackBlockId:{type:"number"}},e):e}),(0,l.addFilter)("editor.BlockEdit","visi-bloc-jlg/with-visibility-controls",M),(0,l.addFilter)("blocks.getSaveContent.extraProps","visi-bloc-jlg/add-save-classes",function(e,t,l){if(!v(t.name)||!l)return e;const{deviceVisibility:i}=l,a=[e.className,i&&"all"!==i?`vb-${i}`:""].filter(Boolean).join(" ");return{...e,className:a}}),(0,l.addFilter)("editor.BlockListBlock","visi-bloc-jlg/add-editor-status-badges",(0,i.createHigherOrderComponent)(l=>i=>{const a="string"==typeof i.className?i.className:"",o=a.includes("bloc-editeur-cache"),r=a.includes("bloc-editeur-repli");if(!o&&!r)return(0,e.createElement)(l,{...i});const s=(0,e.createElement)(l,{...i}),c=t.Children.toArray(s.props.children),b=[];return o&&b.push((0,e.createElement)(u,{key:"visibloc-hidden-badge",label:(0,n.__)("Bloc masqué","visi-bloc-jlg"),variant:"hidden",screenReaderText:(0,n.__)("Ce bloc est masqué pour les visiteurs du site.","visi-bloc-jlg")})),r&&b.push((0,e.createElement)(u,{key:"visibloc-fallback-badge",label:(0,n.__)("Repli actif","visi-bloc-jlg"),variant:"fallback",screenReaderText:(0,n.__)("Le contenu de repli est affiché à la place du bloc original.","visi-bloc-jlg")})),(0,t.cloneElement)(s,s.props,[...b,...c])},"withVisibilityStatusBadges")),(0,l.addFilter)("editor.BlockListBlock.props","visi-bloc-jlg/add-editor-canvas-classes",function(e,t){if(!v(t.name)||!t.attributes)return e;const{isHidden:l}=t.attributes,i=H(t.attributes),a=[e.className,l?"bloc-editeur-cache":"",i?"bloc-editeur-repli":""].filter(Boolean).join(" ");return{...e,className:a}});let Q=G();(0,s.subscribe)(function(){const e=G();!function(){const e=(0,s.select)("core/block-editor");if(!e)return;const t=e.getBlockOrder();if(!t.length)return;const l=[...t],i=new Set;for(;l.length;){const t=l.pop(),a=e.getBlock(t);if(a){if(v(a.name)){const e=Boolean(a.attributes.isHidden),l=H(a.attributes),o=z.get(t)||{};o.isHidden===e&&o.hasFallback===l||Y(t,{isHidden:e,hasFallback:l}),z.set(t,{isHidden:e,hasFallback:l}),i.add(t)}a.innerBlocks&&a.innerBlocks.length&&a.innerBlocks.forEach(e=>{e&&e.clientId&&l.push(e.clientId)})}}i.size!==z.size&&Array.from(z.keys()).forEach(e=>{i.has(e)||(z.delete(e),P.delete(e))})}(),e&&!Q&&function(){if(!P.size)return;const e=Array.from(P.entries());P.clear(),U&&(window.cancelAnimationFrame(U),U=null),e.forEach(([e,t])=>{Y(e,t)})}(),Q=e})})();