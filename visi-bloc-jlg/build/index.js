(()=>{"use strict";const e=window.React,t=window.wp.element,i=window.wp.hooks,l=window.wp.compose,n=window.wp.blockEditor,o=window.wp.components,r=window.wp.i18n,a=window.wp.date,s=window.wp.data,c=["core/group"],u=e=>Array.isArray(e)?Array.from(new Set(e.map(e=>"string"==typeof e?e.trim():"").filter(Boolean))):[],d=u("object"==typeof VisiBlocData&&null!==VisiBlocData&&Array.isArray(VisiBlocData.supportedBlocks)?VisiBlocData.supportedBlocks:c),b=d.length>0?d:c,m=u((0,i.applyFilters)("visiblocSupportedBlocks",b)),p=m.length>0?m:b,f=e=>p.includes(e),g="function"==typeof a.__experimentalGetSettings?(0,a.__experimentalGetSettings)():{},{formats:v={}}=g||{},h="string"==typeof v.date&&v.date.trim()?v.date:"F j, Y",_="string"==typeof v.time&&v.time.trim()?v.time:"H:i",y="string"==typeof v.datetime&&v.datetime.trim()?v.datetime:`${h} ${_}`.trim(),w=(e=>{if(!e||"object"!=typeof e)return!1;if("boolean"==typeof e.twelveHourTime)return e.twelveHourTime;const{formats:t}=e;if(t&&"object"==typeof t){const{time:e}=t;if("string"==typeof e&&e.trim())return/a(?!\\)/i.test(e)}return!1})(g),k=(()=>{if(!g||"object"!=typeof g)return"UTC";const{timezone:e,timezoneAbbr:t,gmt_offset:i}=g;if(e&&"object"==typeof e){if("string"==typeof e.string&&e.string.trim())return e.string.trim();if("string"==typeof e.abbr&&e.abbr.trim())return e.abbr.trim()}if("string"==typeof e&&e.trim())return e.trim();if("string"==typeof t&&t.trim())return t.trim();return(e=>{if("number"!=typeof e||Number.isNaN(e))return"";if(0===e)return"UTC";const t=e>0?"+":"-",i=Math.abs(e),l=Math.round(60*i),n=Math.floor(l/60),o=l%60;return`UTC${t}${String(n).padStart(2,"0")}:${String(o).padStart(2,"0")}`})(i)||"UTC"})(),E=e=>e?"function"==typeof a.dateI18n?(0,a.dateI18n)(y,e):(0,a.format)(y,e):null,j=()=>(0,a.format)("Y-m-d\\TH:i:s",new Date),C=e=>{if(!e)return null;const t=new Date(e);return Number.isNaN(t.getTime())?null:t},B=[{label:(0,r.__)("Visible sur tous les appareils","visi-bloc-jlg"),value:"all"},{label:(0,r.__)("--- Afficher uniquement sur ---","visi-bloc-jlg"),value:"separator-show",disabled:!0},{label:(0,r.__)("Desktop Uniquement","visi-bloc-jlg"),value:"desktop-only"},{label:(0,r.__)("Tablette Uniquement","visi-bloc-jlg"),value:"tablet-only"},{label:(0,r.__)("Mobile Uniquement","visi-bloc-jlg"),value:"mobile-only"},{label:(0,r.__)("--- Cacher sur ---","visi-bloc-jlg"),value:"separator-hide",disabled:!0},{label:(0,r.__)("Caché sur Desktop","visi-bloc-jlg"),value:"hide-on-desktop"},{label:(0,r.__)("Caché sur Tablette","visi-bloc-jlg"),value:"hide-on-tablet"},{label:(0,r.__)("Caché sur Mobile","visi-bloc-jlg"),value:"hide-on-mobile"}],D=(0,l.createHigherOrderComponent)(i=>l=>{if(!f(l.name))return(0,e.createElement)(i,{...l});const{attributes:a,setAttributes:s,isSelected:c}=l,{isHidden:u,deviceVisibility:d,isSchedulingEnabled:b,publishStartDate:m,publishEndDate:p,visibilityRoles:g}=a,v=(e,t)=>{const i=e?[...g,t]:g.filter(e=>e!==t);s({visibilityRoles:i})};let h=(0,r.__)("Aucune programmation.","visi-bloc-jlg");const _=(0,r.sprintf)((0,r.__)("Fuseau horaire : %s","visi-bloc-jlg"),k),y=C(m),D=C(p),S=b&&!!y&&!!D&&D.getTime()<y.getTime();if(b){const e=E(m),t=E(p);
/* translators: 1: Start date, 2: end date. */
h=e&&t?(0,r.sprintf)((0,r.__)("Du %s au %s.","visi-bloc-jlg"),e,t):e?(0,r.sprintf)((0,r.__)("À partir du %s.","visi-bloc-jlg"),e):t?(0,r.sprintf)((0,r.__)("Jusqu'au %s.","visi-bloc-jlg"),t):(0,r.__)("Activée, mais sans date définie.","visi-bloc-jlg"),S&&(h=(0,r.__)("Dates de programmation invalides.","visi-bloc-jlg"))}return(0,e.createElement)(t.Fragment,null,(0,e.createElement)(i,{...l}),c&&(0,e.createElement)(t.Fragment,null,(0,e.createElement)(n.BlockControls,null,(0,e.createElement)(o.ToolbarGroup,null,(0,e.createElement)(o.ToolbarButton,{icon:"visibility",label:(0,r.__)("Rendre visible","visi-bloc-jlg"),onClick:()=>s({isHidden:!1}),isActive:!1===u}),(0,e.createElement)(o.ToolbarButton,{icon:"hidden",label:(0,r.__)("Rendre caché","visi-bloc-jlg"),onClick:()=>s({isHidden:!0}),isActive:!0===u}))),(0,e.createElement)(n.InspectorControls,null,(0,e.createElement)(o.PanelBody,{title:(0,r.__)("Contrôles de Visibilité","visi-bloc-jlg"),initialOpen:!0},(0,e.createElement)(o.SelectControl,{label:(0,r.__)("Visibilité par Appareil","visi-bloc-jlg"),value:d,options:B,onChange:e=>s({deviceVisibility:e})})),(0,e.createElement)(o.PanelBody,{title:(0,r.__)("Programmation","visi-bloc-jlg"),initialOpen:!1,className:"visi-bloc-panel-schedule"},(0,e.createElement)(o.ToggleControl,{label:(0,r.__)("Activer la programmation","visi-bloc-jlg"),checked:b,onChange:()=>s({isSchedulingEnabled:!b})}),b&&(0,e.createElement)("div",null,(0,e.createElement)("p",{style:{fontStyle:"italic",color:"#555"}},h),S&&(0,e.createElement)(o.Notice,{status:"error",isDismissible:!1},(0,r.__)("La date de fin doit être postérieure à la date de début.","visi-bloc-jlg")),(0,e.createElement)("p",{style:{fontStyle:"italic",color:"#555"}},_),(0,e.createElement)(o.CheckboxControl,{label:(0,r.__)("Définir une date de début","visi-bloc-jlg"),checked:!!m,onChange:e=>{s({publishStartDate:e?j():void 0})}}),!!m&&(0,e.createElement)("div",{className:"visi-bloc-datepicker-wrapper"},(0,e.createElement)(o.DateTimePicker,{currentDate:m,onChange:e=>s({publishStartDate:e}),is12Hour:w})),(0,e.createElement)(o.CheckboxControl,{label:(0,r.__)("Définir une date de fin","visi-bloc-jlg"),checked:!!p,onChange:e=>{s({publishEndDate:e?j():void 0})}}),!!p&&(0,e.createElement)("div",{className:"visi-bloc-datepicker-wrapper"},(0,e.createElement)(o.DateTimePicker,{currentDate:p,onChange:e=>s({publishEndDate:e}),is12Hour:w})))),(0,e.createElement)(o.PanelBody,{title:(0,r.__)("Visibilité par Rôle","visi-bloc-jlg"),initialOpen:!1},(0,e.createElement)("p",null,(0,r.__)("N'afficher que pour les rôles sélectionnés. Laisser vide pour afficher à tout le monde.","visi-bloc-jlg")),(0,e.createElement)(o.CheckboxControl,{label:(0,r.__)("Visiteurs Déconnectés","visi-bloc-jlg"),checked:g.includes("logged-out"),onChange:e=>v(e,"logged-out")}),(0,e.createElement)(o.CheckboxControl,{label:(0,r.__)("Utilisateurs Connectés (tous)","visi-bloc-jlg"),checked:g.includes("logged-in"),onChange:e=>v(e,"logged-in")}),(0,e.createElement)("hr",null),Object.entries(VisiBlocData.roles||{}).sort(([,e],[,t])=>String(e).localeCompare(String(t))).map(([t,i])=>(0,e.createElement)(o.CheckboxControl,{key:t,label:i,checked:g.includes(t),onChange:e=>v(e,t)}))))))},"withVisibilityControls"),S=new Map,A=new Map;let T=null;function V(){const e=(0,s.select)("core/edit-post");return!!e&&("function"==typeof e.isListViewOpened?e.isListViewOpened():"function"==typeof e.isFeatureActive&&e.isFeatureActive("listView"))}function N(){if("undefined"==typeof document)return void(T=null);const e=new Map;A.forEach((t,i)=>{const l=document.querySelector(`.block-editor-list-view__block[data-block="${i}"]`);l?t?l.classList.add("bloc-editeur-cache"):l.classList.remove("bloc-editeur-cache"):e.set(i,t)}),A.clear(),e.size&&e.forEach((e,t)=>{A.set(t,e)}),T=A.size&&V()?window.requestAnimationFrame(()=>{N()}):null}function F(e,t){A.get(e)!==t&&(A.set(e,t),T||(T=window.requestAnimationFrame(()=>{N()})))}(0,i.addFilter)("blocks.registerBlockType","visi-bloc-jlg/add-visibility-attributes",function(e,t){return f(t)?(e.attributes={...e.attributes,isHidden:{type:"boolean",default:!1},deviceVisibility:{type:"string",default:"all"},isSchedulingEnabled:{type:"boolean",default:!1},publishStartDate:{type:"string"},publishEndDate:{type:"string"},visibilityRoles:{type:"array",default:[]}},e):e}),(0,i.addFilter)("editor.BlockEdit","visi-bloc-jlg/with-visibility-controls",D),(0,i.addFilter)("blocks.getSaveContent.extraProps","visi-bloc-jlg/add-save-classes",function(e,t,i){if(!f(t.name)||!i)return e;const{deviceVisibility:l}=i,n=[e.className,l&&"all"!==l?`vb-${l}`:""].filter(Boolean).join(" ");return{...e,className:n}}),(0,i.addFilter)("editor.BlockListBlock.props","visi-bloc-jlg/add-editor-canvas-classes",function(e,t){if(!f(t.name)||!t.attributes)return e;const{isHidden:i}=t.attributes,l=[e.className,i?"bloc-editeur-cache":""].filter(Boolean).join(" ");return{...e,className:l}});let H=V();(0,s.subscribe)(function(){const e=V();!function(){const e=(0,s.select)("core/block-editor");if(!e)return;const t=e.getBlockOrder();if(!t.length)return;const i=[...t],l=new Set;for(;i.length;){const t=i.pop(),n=e.getBlock(t);if(n){if(f(n.name)){const e=Boolean(n.attributes.isHidden);S.get(t)!==e&&F(t,e),S.set(t,e),l.add(t)}n.innerBlocks&&n.innerBlocks.length&&n.innerBlocks.forEach(e=>{e&&e.clientId&&i.push(e.clientId)})}}l.size!==S.size&&Array.from(S.keys()).forEach(e=>{l.has(e)||(S.delete(e),A.delete(e))})}(),e&&!H&&function(){if(!A.size)return;const e=Array.from(A.entries());A.clear(),T&&(window.cancelAnimationFrame(T),T=null),e.forEach(([e,t])=>{F(e,t)})}(),H=e})})();