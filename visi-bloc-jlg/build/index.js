(()=>{"use strict";const e=window.React,t=window.wp.element,l=window.wp.hooks,i=window.wp.compose,a=window.wp.blockEditor,n=window.wp.components,o=window.wp.i18n,r=window.wp.date,s=window.wp.data,c=["core/group"],u=e=>Array.isArray(e)?Array.from(new Set(e.map(e=>"string"==typeof e?e.trim():"").filter(Boolean))):[],b=u("object"==typeof VisiBlocData&&null!==VisiBlocData&&Array.isArray(VisiBlocData.supportedBlocks)?VisiBlocData.supportedBlocks:c),d=b.length>0?b:c,m=u((0,l.applyFilters)("visiblocSupportedBlocks",d)),p=m.length>0?m:d,f=e=>p.includes(e),g="object"==typeof VisiBlocData&&null!==VisiBlocData&&"object"==typeof VisiBlocData.fallback&&null!==VisiBlocData.fallback?VisiBlocData.fallback:{},v="string"==typeof g.content?g.content:"",_=Array.isArray(g.reusableBlocks)?g.reusableBlocks.map(e=>{if(!e||"object"!=typeof e)return null;const{id:t,title:l}=e,i="number"==typeof t?t:parseInt(t,10);return Number.isNaN(i)||i<=0?null:{id:i,title:"string"==typeof l&&l.trim()?l:`#${i}`}}).filter(Boolean):[],h=v.trim().length>0,y=_.length>0,k={GLOBAL:"global",CUSTOM:"custom",REUSABLE:"reusable"},E=(0,o.__)("Repli actif","visi-bloc-jlg"),C=({fallbackEnabled:e,fallbackSource:t,fallbackCustomContent:l,fallbackReusableBlockId:i})=>{if(!e)return!1;switch(t){case k.CUSTOM:return"string"==typeof l&&l.trim().length>0;case k.REUSABLE:if(Number.isInteger(i)&&i>0)return!0;if("string"==typeof i){const e=parseInt(i,10);return!Number.isNaN(e)&&e>0}return!1;default:return h}},j="function"==typeof r.__experimentalGetSettings?(0,r.__experimentalGetSettings)():{},{formats:w={}}=j||{},B="string"==typeof w.date&&w.date.trim()?w.date:"F j, Y",S="string"==typeof w.time&&w.time.trim()?w.time:"H:i",A="string"==typeof w.datetime&&w.datetime.trim()?w.datetime:`${B} ${S}`.trim(),D=(e=>{if(!e||"object"!=typeof e)return!1;if("boolean"==typeof e.twelveHourTime)return e.twelveHourTime;const{formats:t}=e;if(t&&"object"==typeof t){const{time:e}=t;if("string"==typeof e&&e.trim())return/a(?!\\)/i.test(e)}return!1})(j),N=(()=>{if(!j||"object"!=typeof j)return"UTC";const{timezone:e,timezoneAbbr:t,gmt_offset:l}=j;if(e&&"object"==typeof e){if("string"==typeof e.string&&e.string.trim())return e.string.trim();if("string"==typeof e.abbr&&e.abbr.trim())return e.abbr.trim()}if("string"==typeof e&&e.trim())return e.trim();if("string"==typeof t&&t.trim())return t.trim();return(e=>{if("number"!=typeof e||Number.isNaN(e))return"";if(0===e)return"UTC";const t=e>0?"+":"-",l=Math.abs(e),i=Math.round(60*l),a=Math.floor(i/60),n=i%60;return`UTC${t}${String(a).padStart(2,"0")}:${String(n).padStart(2,"0")}`})(l)||"UTC"})(),T=e=>e?"function"==typeof r.dateI18n?(0,r.dateI18n)(A,e):(0,r.format)(A,e):null,L=()=>(0,r.format)("Y-m-d\\TH:i:s",new Date),V=e=>{if(!e)return null;const t=new Date(e);return Number.isNaN(t.getTime())?null:t},O=[{label:(0,o.__)("Visible sur tous les appareils","visi-bloc-jlg"),value:"all"},{label:(0,o.__)("--- Afficher uniquement sur ---","visi-bloc-jlg"),value:"separator-show",disabled:!0},{label:(0,o.__)("Desktop Uniquement","visi-bloc-jlg"),value:"desktop-only"},{label:(0,o.__)("Tablette Uniquement","visi-bloc-jlg"),value:"tablet-only"},{label:(0,o.__)("Mobile Uniquement","visi-bloc-jlg"),value:"mobile-only"},{label:(0,o.__)("--- Cacher sur ---","visi-bloc-jlg"),value:"separator-hide",disabled:!0},{label:(0,o.__)("Caché sur Desktop","visi-bloc-jlg"),value:"hide-on-desktop"},{label:(0,o.__)("Caché sur Tablette","visi-bloc-jlg"),value:"hide-on-tablet"},{label:(0,o.__)("Caché sur Mobile","visi-bloc-jlg"),value:"hide-on-mobile"}],R=(0,i.createHigherOrderComponent)(l=>i=>{if(!f(i.name))return(0,e.createElement)(l,{...i});const{attributes:r,setAttributes:s,isSelected:c}=i,{isHidden:u,deviceVisibility:b,isSchedulingEnabled:d,publishStartDate:m,publishEndDate:p,visibilityRoles:g,fallbackEnabled:v,fallbackSource:E,fallbackCustomContent:j,fallbackReusableBlockId:w}=r,B=C(r),S=(e,t)=>{const l=e?[...g,t]:g.filter(e=>e!==t);s({visibilityRoles:l})};let A=(0,o.__)("Aucune programmation.","visi-bloc-jlg");const R=(0,o.sprintf)((0,o.__)("Fuseau horaire : %s","visi-bloc-jlg"),N),U=V(m),F=V(p),I=d&&!!U&&!!F&&F.getTime()<U.getTime();if(d){const e=T(m),t=T(p);
/* translators: 1: Start date, 2: end date. */
A=e&&t?(0,o.sprintf)((0,o.__)("Du %s au %s.","visi-bloc-jlg"),e,t):e?(0,o.sprintf)((0,o.__)("À partir du %s.","visi-bloc-jlg"),e):t?(0,o.sprintf)((0,o.__)("Jusqu'au %s.","visi-bloc-jlg"),t):(0,o.__)("Activée, mais sans date définie.","visi-bloc-jlg"),I&&(A=(0,o.__)("Dates de programmation invalides.","visi-bloc-jlg"))}return(0,e.createElement)(t.Fragment,null,(0,e.createElement)(l,{...i}),c&&(0,e.createElement)(t.Fragment,null,(0,e.createElement)(a.BlockControls,null,(0,e.createElement)(n.ToolbarGroup,null,(0,e.createElement)(n.ToolbarButton,{icon:"visibility",label:(0,o.__)("Rendre visible","visi-bloc-jlg"),onClick:()=>s({isHidden:!1}),isActive:!1===u}),(0,e.createElement)(n.ToolbarButton,{icon:"hidden",label:(0,o.__)("Rendre caché","visi-bloc-jlg"),onClick:()=>s({isHidden:!0}),isActive:!0===u}))),(0,e.createElement)(a.InspectorControls,null,(0,e.createElement)(n.PanelBody,{title:(0,o.__)("Contrôles de Visibilité","visi-bloc-jlg"),initialOpen:!0},(0,e.createElement)(n.SelectControl,{label:(0,o.__)("Visibilité par Appareil","visi-bloc-jlg"),value:b,options:O,onChange:e=>s({deviceVisibility:e})})),(0,e.createElement)(n.PanelBody,{title:(0,o.__)("Programmation","visi-bloc-jlg"),initialOpen:!1,className:"visi-bloc-panel-schedule"},(0,e.createElement)(n.ToggleControl,{label:(0,o.__)("Activer la programmation","visi-bloc-jlg"),checked:d,onChange:()=>s({isSchedulingEnabled:!d})}),d&&(0,e.createElement)("div",null,(0,e.createElement)("p",{style:{fontStyle:"italic",color:"#555"}},A),I&&(0,e.createElement)(n.Notice,{status:"error",isDismissible:!1},(0,o.__)("La date de fin doit être postérieure à la date de début.","visi-bloc-jlg")),(0,e.createElement)("p",{style:{fontStyle:"italic",color:"#555"}},R),(0,e.createElement)(n.CheckboxControl,{label:(0,o.__)("Définir une date de début","visi-bloc-jlg"),checked:!!m,onChange:e=>{s({publishStartDate:e?L():void 0})}}),!!m&&(0,e.createElement)("div",{className:"visi-bloc-datepicker-wrapper"},(0,e.createElement)(n.DateTimePicker,{currentDate:m,onChange:e=>s({publishStartDate:e}),is12Hour:D})),(0,e.createElement)(n.CheckboxControl,{label:(0,o.__)("Définir une date de fin","visi-bloc-jlg"),checked:!!p,onChange:e=>{s({publishEndDate:e?L():void 0})}}),!!p&&(0,e.createElement)("div",{className:"visi-bloc-datepicker-wrapper"},(0,e.createElement)(n.DateTimePicker,{currentDate:p,onChange:e=>s({publishEndDate:e}),is12Hour:D})))),(0,e.createElement)(n.PanelBody,{title:(0,o.__)("Contenu de repli","visi-bloc-jlg"),initialOpen:!1},(0,e.createElement)(n.ToggleControl,{label:(0,o.__)("Activer le repli","visi-bloc-jlg"),checked:v,onChange:()=>s({fallbackEnabled:!v})}),v&&(0,e.createElement)(t.Fragment,null,(0,e.createElement)(n.SelectControl,{label:(0,o.__)("Source du repli","visi-bloc-jlg"),value:E,options:[{label:(0,o.__)("Utiliser le contenu global","visi-bloc-jlg"),value:k.GLOBAL},{label:(0,o.__)("Texte personnalisé","visi-bloc-jlg"),value:k.CUSTOM},{label:(0,o.__)("Bloc réutilisable","visi-bloc-jlg"),value:k.REUSABLE,disabled:!y}],onChange:e=>{const t=Object.values(k).includes(e)?e:k.GLOBAL,l={fallbackSource:t};t!==k.REUSABLE&&(l.fallbackReusableBlockId=void 0),s(l)}}),E===k.GLOBAL&&!h&&(0,e.createElement)(n.Notice,{status:"warning",isDismissible:!1},(0,o.__)("Aucun contenu de repli global n’est défini dans les réglages.","visi-bloc-jlg")),E===k.CUSTOM&&(0,e.createElement)(n.TextareaControl,{label:(0,o.__)("Texte ou HTML à afficher en repli","visi-bloc-jlg"),help:(0,o.__)("Ce contenu remplacera le bloc lorsque les règles de visibilité le masquent.","visi-bloc-jlg"),value:"string"==typeof j?j:"",onChange:e=>s({fallbackCustomContent:e})}),E===k.REUSABLE&&(0,e.createElement)(t.Fragment,null,!y&&(0,e.createElement)(n.Notice,{status:"warning",isDismissible:!1},(0,o.__)("Aucun bloc réutilisable disponible. Créez-en un avant de le sélectionner ici.","visi-bloc-jlg")),y&&(0,e.createElement)(n.SelectControl,{label:(0,o.__)("Bloc réutilisable à afficher","visi-bloc-jlg"),value:Number.isInteger(w)?String(w):"",options:[{label:(0,o.__)("Sélectionner un bloc…","visi-bloc-jlg"),value:""},..._.map(e=>({label:e.title,value:String(e.id)}))],onChange:e=>{const t=parseInt(e,10);s({fallbackReusableBlockId:Number.isNaN(t)?void 0:t})}})),!B&&(0,e.createElement)(n.Notice,{status:"warning",isDismissible:!1},(0,o.__)("Le repli est activé mais aucun contenu ne sera affiché tant que vous ne fournissez pas de source valide.","visi-bloc-jlg")))),(0,e.createElement)(n.PanelBody,{title:(0,o.__)("Visibilité par Rôle","visi-bloc-jlg"),initialOpen:!1},(0,e.createElement)("p",null,(0,o.__)("N'afficher que pour les rôles sélectionnés. Laisser vide pour afficher à tout le monde.","visi-bloc-jlg")),(0,e.createElement)(n.CheckboxControl,{label:(0,o.__)("Visiteurs Déconnectés","visi-bloc-jlg"),checked:g.includes("logged-out"),onChange:e=>S(e,"logged-out")}),(0,e.createElement)(n.CheckboxControl,{label:(0,o.__)("Utilisateurs Connectés (tous)","visi-bloc-jlg"),checked:g.includes("logged-in"),onChange:e=>S(e,"logged-in")}),(0,e.createElement)("hr",null),Object.entries(VisiBlocData.roles||{}).sort(([,e],[,t])=>String(e).localeCompare(String(t))).map(([t,l])=>(0,e.createElement)(n.CheckboxControl,{key:t,label:l,checked:g.includes(t),onChange:e=>S(e,t)}))))))},"withVisibilityControls"),U=new Map,F=new Map;let I=null;function H(){const e=(0,s.select)("core/edit-post");return!!e&&("function"==typeof e.isListViewOpened?e.isListViewOpened():"function"==typeof e.isFeatureActive&&e.isFeatureActive("listView"))}function M(){if("undefined"==typeof document)return void(I=null);const e=new Map;F.forEach((t,l)=>{const i=document.querySelector(`.block-editor-list-view__block[data-block="${l}"]`);i?t?i.classList.add("bloc-editeur-cache"):i.classList.remove("bloc-editeur-cache"):e.set(l,t)}),F.clear(),e.size&&e.forEach((e,t)=>{F.set(t,e)}),I=F.size&&H()?window.requestAnimationFrame(()=>{M()}):null}function q(e,t){F.get(e)!==t&&(F.set(e,t),I||(I=window.requestAnimationFrame(()=>{M()})))}(0,l.addFilter)("blocks.registerBlockType","visi-bloc-jlg/add-visibility-attributes",function(e,t){return f(t)?(e.attributes={...e.attributes,isHidden:{type:"boolean",default:!1},deviceVisibility:{type:"string",default:"all"},isSchedulingEnabled:{type:"boolean",default:!1},publishStartDate:{type:"string"},publishEndDate:{type:"string"},visibilityRoles:{type:"array",default:[]},fallbackEnabled:{type:"boolean",default:!1},fallbackSource:{type:"string",default:k.GLOBAL},fallbackCustomContent:{type:"string"},fallbackReusableBlockId:{type:"number"}},e):e}),(0,l.addFilter)("editor.BlockEdit","visi-bloc-jlg/with-visibility-controls",R),(0,l.addFilter)("blocks.getSaveContent.extraProps","visi-bloc-jlg/add-save-classes",function(e,t,l){if(!f(t.name)||!l)return e;const{deviceVisibility:i}=l,a=[e.className,i&&"all"!==i?`vb-${i}`:""].filter(Boolean).join(" ");return{...e,className:a}}),(0,l.addFilter)("editor.BlockListBlock.props","visi-bloc-jlg/add-editor-canvas-classes",function(e,t){if(!f(t.name)||!t.attributes)return e;const{isHidden:l}=t.attributes,i=[e.className,l?"bloc-editeur-cache":""].filter(Boolean).join(" "),a={...e,className:i};return C(t.attributes)&&l?a["data-visibloc-fallback-label"]=E:Object.prototype.hasOwnProperty.call(a,"data-visibloc-fallback-label")&&delete a["data-visibloc-fallback-label"],a});let x=H();(0,s.subscribe)(function(){const e=H();!function(){const e=(0,s.select)("core/block-editor");if(!e)return;const t=e.getBlockOrder();if(!t.length)return;const l=[...t],i=new Set;for(;l.length;){const t=l.pop(),a=e.getBlock(t);if(a){if(f(a.name)){const e=Boolean(a.attributes.isHidden);U.get(t)!==e&&q(t,e),U.set(t,e),i.add(t)}a.innerBlocks&&a.innerBlocks.length&&a.innerBlocks.forEach(e=>{e&&e.clientId&&l.push(e.clientId)})}}i.size!==U.size&&Array.from(U.keys()).forEach(e=>{i.has(e)||(U.delete(e),F.delete(e))})}(),e&&!x&&function(){if(!F.size)return;const e=Array.from(F.entries());F.clear(),I&&(window.cancelAnimationFrame(I),I=null),e.forEach(([e,t])=>{q(e,t)})}(),x=e})})();