(()=>{"use strict";const e=window.React,l=window.wp.element,t=window.wp.hooks,i=window.wp.compose,o=window.wp.blockEditor,a=window.wp.components,n=window.wp.i18n,r=window.wp.date,s=window.wp.data,c=["core/group"],u=({label:l,variant:t="",screenReaderText:i="",description:o=""})=>{const n=["visibloc-status-badge"],r="string"==typeof o&&o.trim().length>0;"string"==typeof t&&t.trim()&&n.push(`visibloc-status-badge--${t.trim()}`);const s=(0,e.createElement)("span",{className:n.join(" ")},(0,e.createElement)("span",{className:"visibloc-status-badge__label"},l),r?(0,e.createElement)("span",{className:"visibloc-status-badge__description"},o):null,i?(0,e.createElement)("span",{className:"screen-reader-text"},i):null);return r?(0,e.createElement)(a.Tooltip,{text:o},s):s},b=e=>Array.isArray(e)?Array.from(new Set(e.map(e=>"string"==typeof e?e.trim():"").filter(Boolean))):[],p=b("object"==typeof VisiBlocData&&null!==VisiBlocData&&Array.isArray(VisiBlocData.supportedBlocks)?VisiBlocData.supportedBlocks:c),m=p.length>0?p:c,d=b((0,t.applyFilters)("visiblocSupportedBlocks",m)),g=d.length>0?d:m,v=e=>g.includes(e),_="function"==typeof r.__experimentalGetSettings?(0,r.__experimentalGetSettings)():{},{formats:f={}}=_||{},y="string"==typeof f.date&&f.date.trim()?f.date:"F j, Y",h="string"==typeof f.time&&f.time.trim()?f.time:"H:i",j="string"==typeof f.datetime&&f.datetime.trim()?f.datetime:`${y} ${h}`.trim(),E=(e=>{if(!e||"object"!=typeof e)return!1;if("boolean"==typeof e.twelveHourTime)return e.twelveHourTime;const{formats:l}=e;if(l&&"object"==typeof l){const{time:e}=l;if("string"==typeof e&&e.trim())return/a(?!\\)/i.test(e)}return!1})(_),k=(()=>{if(!_||"object"!=typeof _)return"UTC";const{timezone:e,timezoneAbbr:l,gmt_offset:t}=_;if(e&&"object"==typeof e){if("string"==typeof e.string&&e.string.trim())return e.string.trim();if("string"==typeof e.abbr&&e.abbr.trim())return e.abbr.trim()}if("string"==typeof e&&e.trim())return e.trim();if("string"==typeof l&&l.trim())return l.trim();return(e=>{if("number"!=typeof e||Number.isNaN(e))return"";if(0===e)return"UTC";const l=e>0?"+":"-",t=Math.abs(e),i=Math.round(60*t),o=Math.floor(i/60),a=i%60;return`UTC${l}${String(o).padStart(2,"0")}:${String(a).padStart(2,"0")}`})(t)||"UTC"})(),C=e=>e?"function"==typeof r.dateI18n?(0,r.dateI18n)(j,e):(0,r.format)(j,e):null,x=()=>(0,r.format)("Y-m-d\\TH:i:s",new Date),B=e=>{if(!e)return null;const l=new Date(e);return Number.isNaN(l.getTime())?null:l},w={id:"all",label:(0,n.__)("Visible sur tous les appareils","visi-bloc-jlg")},A=[{id:"show-only",label:(0,n.__)("Afficher uniquement","visi-bloc-jlg"),options:[{id:"desktop-only",label:(0,n.__)("Desktop","visi-bloc-jlg"),icon:"desktop"},{id:"tablet-only",label:(0,n.__)("Tablette","visi-bloc-jlg"),icon:"tablet"},{id:"mobile-only",label:(0,n.__)("Mobile","visi-bloc-jlg"),icon:"smartphone"}]},{id:"hide-on",label:(0,n.__)("Masquer sur","visi-bloc-jlg"),options:[{id:"hide-on-desktop",label:(0,n.__)("Desktop","visi-bloc-jlg"),icon:"desktop"},{id:"hide-on-tablet",label:(0,n.__)("Tablette","visi-bloc-jlg"),icon:"tablet"},{id:"hide-on-mobile",label:(0,n.__)("Mobile","visi-bloc-jlg"),icon:"smartphone"}]}],N=A.reduce((e,l)=>l&&Array.isArray(l.options)?e.concat(l.options):e,[]),T=["post_type","taxonomy","template","recurring_schedule","logged_in_status","user_role_group","woocommerce_cart","query_param"],S=[{value:"post_type",label:(0,n.__)("Type de contenu","visi-bloc-jlg")},{value:"taxonomy",label:(0,n.__)("Taxonomie","visi-bloc-jlg")},{value:"template",label:(0,n.__)("Modèle de page","visi-bloc-jlg")},{value:"recurring_schedule",label:(0,n.__)("Horaire récurrent","visi-bloc-jlg")},{value:"logged_in_status",label:(0,n.__)("État de connexion","visi-bloc-jlg")},{value:"user_role_group",label:(0,n.__)("Groupe de rôles","visi-bloc-jlg")},{value:"woocommerce_cart",label:(0,n.__)("Panier WooCommerce","visi-bloc-jlg")},{value:"query_param",label:(0,n.__)("Paramètre d’URL","visi-bloc-jlg")}],D=Object.freeze({logic:"AND",rules:[]}),F=Object.freeze({frequency:"daily",days:[],startTime:"08:00",endTime:"17:00"}),q=e=>{if("object"!=typeof VisiBlocData||null===VisiBlocData)return[];const l=VisiBlocData[e];return Array.isArray(l)?l:[]},V=e=>{if("object"!=typeof VisiBlocData||null===VisiBlocData)return null;const l=VisiBlocData[e];return l&&"object"==typeof l?l:null},H=e=>{if(!e||"object"!=typeof e)return!1;const l=void 0===e.fallbackEnabled||Boolean(e.fallbackEnabled),t="string"==typeof e.fallbackBehavior?e.fallbackBehavior:"inherit";if(!l)return!1;if("text"===t)return("string"==typeof e.fallbackCustomText?e.fallbackCustomText:"").trim().length>0;if("block"===t)return Boolean(e.fallbackBlockId);const i=V("fallbackSettings")||{};return Boolean(i&&i.hasContent)},O=new Map,R=new Map;let I=null;const P=(()=>{const e=q("daysOfWeek"),l=new Map;return e.forEach(e=>{e&&"object"==typeof e&&"string"==typeof e.value&&l.set(e.value,e.label||e.value)}),l})(),$=()=>`rule-${Math.random().toString(36).slice(2)}-${Date.now()}`,M=e=>{if(!Array.isArray(e)||!e.length)return"";const l=e.find(e=>e&&void 0!==e.value);if(!l)return"";const t=void 0===l.value||null===l.value?"":l.value;return String(t)},L=e=>{switch(e){case"taxonomy":return(()=>{const e=q("taxonomies").find(e=>e&&"string"==typeof e.slug);return{id:$(),type:"taxonomy",operator:"in",taxonomy:e?e.slug:"",terms:[]}})();case"template":return(()=>{const e=q("templates");return{id:$(),type:"template",operator:"is",value:M(e)}})();case"recurring_schedule":return{id:$(),type:"recurring_schedule",operator:"matches",...F};case"logged_in_status":return(()=>{const e=q("loginStatuses");return{id:$(),type:"logged_in_status",operator:"is",value:M(e)}})();case"user_role_group":return(()=>{const e=q("roleGroups");return{id:$(),type:"user_role_group",operator:"matches",group:M(e)}})();case"woocommerce_cart":return(()=>{const e=q("woocommerceTaxonomies").find(e=>e&&"string"==typeof e.slug);return{id:$(),type:"woocommerce_cart",operator:"contains",taxonomy:e?e.slug:"",terms:[]}})();case"query_param":return(()=>{const e=q("commonQueryParams");return{id:$(),type:"query_param",operator:"equals",param:M(e),value:""}})();default:return(()=>{const e=q("postTypes");return{id:$(),type:"post_type",operator:"is",value:M(e)}})()}},z=e=>{if(!e||"object"!=typeof e)return null;const{type:l}=e;if(!T.includes(l))return null;const t={id:"string"==typeof e.id&&e.id?e.id:$(),type:l};if("post_type"===l)return t.operator="is_not"===e.operator?"is_not":"is",t.value="string"==typeof e.value?e.value:"",t;if("taxonomy"===l)return t.operator="not_in"===e.operator?"not_in":"in",t.taxonomy="string"==typeof e.taxonomy?e.taxonomy:"",t.terms=Array.isArray(e.terms)?e.terms.map(e=>"string"==typeof e||"number"==typeof e?String(e):"").filter(Boolean):[],t;if("template"===l)return t.operator="is_not"===e.operator?"is_not":"is",t.value="string"==typeof e.value?e.value:"",t;if("logged_in_status"===l)return t.operator="is_not"===e.operator?"is_not":"is",t.value="string"==typeof e.value?e.value:"",t;if("user_role_group"===l)return t.operator="does_not_match"===e.operator?"does_not_match":"matches",t.group="string"==typeof e.group?e.group:"",t;if("woocommerce_cart"===l)return t.operator="not_contains"===e.operator?"not_contains":"contains",t.taxonomy="string"==typeof e.taxonomy?e.taxonomy:"",t.terms=Array.isArray(e.terms)?e.terms.map(e=>"string"==typeof e||"number"==typeof e?String(e):"").filter(Boolean):[],t;if("query_param"===l){const l=["equals","not_equals","contains","not_contains","exists","not_exists"];return t.operator=l.includes(e.operator)?e.operator:"equals",t.param="string"==typeof e.param?e.param:"",t.value="string"==typeof e.value?e.value:"",t}return t.operator="matches",t.frequency="weekly"===e.frequency?"weekly":"daily",t.days=Array.isArray(e.days)?e.days.map(e=>"string"==typeof e?e:"").filter(e=>P.has(e)):[],t.startTime="string"==typeof e.startTime?e.startTime:F.startTime,t.endTime="string"==typeof e.endTime?e.endTime:F.endTime,t},G=e=>e&&"object"==typeof e?{logic:"OR"===e.logic?"OR":"AND",rules:Array.isArray(e.rules)?e.rules.map(z).filter(Boolean):[]}:{logic:D.logic,rules:[...D.rules]},U=(0,i.createHigherOrderComponent)(t=>i=>{if(!v(i.name))return(0,e.createElement)(t,{...i});const{attributes:r,setAttributes:s,isSelected:c,clientId:u}=i,{isHidden:b,deviceVisibility:p,isSchedulingEnabled:m,publishStartDate:d,publishEndDate:g,visibilityRoles:_,advancedVisibility:f,fallbackEnabled:y=!0,fallbackBehavior:h="inherit",fallbackCustomText:j="",fallbackBlockId:D}=r,F=G(f),R=V("fallbackSettings")||{},I=H(r),$=Boolean(R&&R.hasContent),M=R&&"string"==typeof R.summary?R.summary:"",U=q("fallbackBlocks").filter(e=>e&&"object"==typeof e).map(e=>{const l="number"==typeof e.value?e.value:parseInt(e.value,10),t=Number.isNaN(l)?0:l;return{value:String(t),label:"string"==typeof e.label&&e.label.trim()?e.label:`#${t}`}}),W=[{value:"inherit",label:(0,n.__)("Utiliser le repli global","visi-bloc-jlg")},{value:"text",label:(0,n.__)("Texte personnalisé","visi-bloc-jlg")},{value:"block",label:(0,n.__)("Bloc réutilisable","visi-bloc-jlg")}],Q=e=>{const l=G({...F}),t=e(l)||l;s({advancedVisibility:G(t)})},Y=(e,l)=>{const t=e?[..._,l]:_.filter(e=>e!==l);s({visibilityRoles:t})};let K=(0,n.__)("Aucune programmation.","visi-bloc-jlg");const X=(0,n.sprintf)((0,n.__)("Fuseau horaire : %s","visi-bloc-jlg"),k),Z=B(d),ee=B(g),le=m&&!!Z&&!!ee&&ee.getTime()<Z.getTime();if(m){const e=C(d),l=C(g);
/* translators: 1: Start date, 2: end date. */
K=e&&l?(0,n.sprintf)((0,n.__)("Du %s au %s.","visi-bloc-jlg"),e,l):e?(0,n.sprintf)((0,n.__)("À partir du %s.","visi-bloc-jlg"),e):l?(0,n.sprintf)((0,n.__)("Jusqu'au %s.","visi-bloc-jlg"),l):(0,n.__)("Activée, mais sans date définie.","visi-bloc-jlg"),le&&(K=(0,n.__)("Dates de programmation invalides.","visi-bloc-jlg"))}const te=(0,n.__)("Inactif","visi-bloc-jlg"),ie=(t,i)=>(0,e.createElement)(l.Fragment,null,(0,e.createElement)("span",null,t),(0,e.createElement)("span",{className:"components-panel__summary"},i&&String(i).trim()?i:te)),oe=(()=>{if(!p||p===w.id)return"";const e=A.find(e=>!!Array.isArray(e.options)&&e.options.some(e=>e.id===p)),l=N.find(e=>e.id===p);return l?e?`${e.label} – ${l.label}`:l.label:""})(),ae=m?le?(0,n.__)("Erreur de dates","visi-bloc-jlg"):d&&g?(0,n.__)("Plage définie","visi-bloc-jlg"):d||g?(0,n.__)("Date définie","visi-bloc-jlg"):(0,n.__)("Programmation active","visi-bloc-jlg"):"",ne=(()=>{const e=Array.from(new Set((_||[]).filter(Boolean))).length;return e?(0,n.sprintf)((0,n._n)("%d rôle","%d rôles",e,"visi-bloc-jlg"),e):""})(),re=(()=>{const e=Array.isArray(F.rules)?F.rules.length:0;if(!e)return"";const l="OR"===F.logic?(0,n.__)("OU","visi-bloc-jlg"):(0,n.__)("ET","visi-bloc-jlg");return(0,n.sprintf)((0,n._n)("%1$d règle %2$s","%1$d règles %2$s",e,"visi-bloc-jlg"),e,l)})(),se=(()=>{if(!y)return"";const e={inherit:(0,n.__)("Global","visi-bloc-jlg"),text:(0,n.__)("Texte","visi-bloc-jlg"),block:(0,n.__)("Bloc","visi-bloc-jlg")};return"block"!==h||D?e[h]||e.inherit:(0,n.__)("Bloc","visi-bloc-jlg")})(),ce=[];b&&ce.push((0,n.__)("Bloc masqué manuellement.","visi-bloc-jlg")),oe&&ce.push((0,n.sprintf)((0,n.__)("Appareils : %s","visi-bloc-jlg"),oe)),m&&ce.push((0,n.sprintf)((0,n.__)("Programmation : %s","visi-bloc-jlg"),K)),ne&&ce.push((0,n.sprintf)((0,n.__)("Rôles ciblés : %s","visi-bloc-jlg"),ne)),re&&ce.push((0,n.sprintf)((0,n.__)("Règles avancées : %s","visi-bloc-jlg"),re));const ue=[];if(I)if(se&&ue.push((0,n.sprintf)((0,n.__)("Type : %s","visi-bloc-jlg"),se)),"inherit"===h)M?ue.push((0,n.sprintf)((0,n.__)("Repli global : %s","visi-bloc-jlg"),M)):$?ue.push((0,n.__)("Utilise le contenu de repli global.","visi-bloc-jlg")):ue.push((0,n.__)("Aucun repli global défini.","visi-bloc-jlg"));else if("text"===h){const e="string"==typeof j?j.trim():"";e&&ue.push(e)}else if("block"===h&&D){const e=U.find(e=>e.value===String(D));e&&e.label&&ue.push((0,n.sprintf)((0,n.__)("Bloc : %s","visi-bloc-jlg"),e.label))}if(u){const e=ce.join("\n").trim(),l=ue.join("\n").trim(),t=O.get(u)||{},i={...t,isHidden:Boolean(b),hasFallback:I,hiddenDescription:e,fallbackDescription:l};O.set(u,i),t.isHidden===i.isHidden&&t.hasFallback===i.hasFallback&&t.hiddenDescription===i.hiddenDescription&&t.fallbackDescription===i.fallbackDescription||J(u,i)}return(0,e.createElement)(l.Fragment,null,(0,e.createElement)(t,{...i}),c&&(0,e.createElement)(l.Fragment,null,(0,e.createElement)(o.BlockControls,null,(0,e.createElement)(a.ToolbarGroup,null,(0,e.createElement)(a.ToolbarButton,{icon:"visibility",label:(0,n.__)("Rendre visible","visi-bloc-jlg"),onClick:()=>s({isHidden:!1}),isActive:!1===b}),(0,e.createElement)(a.ToolbarButton,{icon:"hidden",label:(0,n.__)("Rendre caché","visi-bloc-jlg"),onClick:()=>s({isHidden:!0}),isActive:!0===b}))),(0,e.createElement)(o.InspectorControls,null,(0,e.createElement)(a.PanelBody,{title:ie((0,n.__)("Contrôles de Visibilité","visi-bloc-jlg"),oe),initialOpen:!0},(0,e.createElement)(a.BaseControl,{label:(0,n.__)("Visibilité par Appareil","visi-bloc-jlg")},(0,e.createElement)("div",{className:"visi-bloc-device-toggle-groups"},A.map(l=>{const t=l.options.some(e=>e.id===p);return(0,e.createElement)("div",{key:l.id,className:"visi-bloc-device-toggle-group"},(0,e.createElement)(a.BaseControl.VisualLabel,null,l.label),(0,e.createElement)(a.ToggleGroupControl,{className:"visi-bloc-device-toggle",isBlock:!0,isDeselectable:!0,value:t?p:void 0,onChange:e=>s({deviceVisibility:e||w.id})},l.options.map(l=>(0,e.createElement)(a.ToggleGroupControlOptionIcon,{key:l.id,value:l.id,icon:l.icon,label:l.label}))))}),(0,e.createElement)(a.Button,{className:"visi-bloc-device-toggle-reset",variant:"link",isLink:!0,onClick:()=>s({deviceVisibility:w.id}),disabled:p===w.id},w.label)))),(0,e.createElement)(a.PanelBody,{title:ie((0,n.__)("Programmation","visi-bloc-jlg"),ae),initialOpen:!1,className:"visi-bloc-panel-schedule"},(0,e.createElement)(a.ToggleControl,{label:(0,n.__)("Activer la programmation","visi-bloc-jlg"),checked:m,onChange:()=>s({isSchedulingEnabled:!m})}),m&&(0,e.createElement)("div",null,(0,e.createElement)("p",{style:{fontStyle:"italic",color:"#555"}},K),le&&(0,e.createElement)(a.Notice,{status:"error",isDismissible:!1},(0,n.__)("La date de fin doit être postérieure à la date de début.","visi-bloc-jlg")),(0,e.createElement)("p",{style:{fontStyle:"italic",color:"#555"}},X),(0,e.createElement)(a.CheckboxControl,{label:(0,n.__)("Définir une date de début","visi-bloc-jlg"),checked:!!d,onChange:e=>{s({publishStartDate:e?x():void 0})}}),!!d&&(0,e.createElement)("div",{className:"visi-bloc-datepicker-wrapper"},(0,e.createElement)(a.DateTimePicker,{currentDate:d,onChange:e=>s({publishStartDate:e}),is12Hour:E})),(0,e.createElement)(a.CheckboxControl,{label:(0,n.__)("Définir une date de fin","visi-bloc-jlg"),checked:!!g,onChange:e=>{s({publishEndDate:e?x():void 0})}}),!!g&&(0,e.createElement)("div",{className:"visi-bloc-datepicker-wrapper"},(0,e.createElement)(a.DateTimePicker,{currentDate:g,onChange:e=>s({publishEndDate:e}),is12Hour:E})))),(0,e.createElement)(a.PanelBody,{title:ie((0,n.__)("Visibilité par Rôle","visi-bloc-jlg"),ne),initialOpen:!1},(0,e.createElement)("p",null,(0,n.__)("N'afficher que pour les rôles sélectionnés. Laisser vide pour afficher à tout le monde.","visi-bloc-jlg")),(0,e.createElement)(a.CheckboxControl,{label:(0,n.__)("Visiteurs Déconnectés","visi-bloc-jlg"),checked:_.includes("logged-out"),onChange:e=>Y(e,"logged-out")}),(0,e.createElement)(a.CheckboxControl,{label:(0,n.__)("Utilisateurs Connectés (tous)","visi-bloc-jlg"),checked:_.includes("logged-in"),onChange:e=>Y(e,"logged-in")}),(0,e.createElement)("hr",null),Object.entries(VisiBlocData.roles||{}).sort(([,e],[,l])=>String(e).localeCompare(String(l))).map(([l,t])=>(0,e.createElement)(a.CheckboxControl,{key:l,label:t,checked:_.includes(l),onChange:e=>Y(e,l)}))),(0,e.createElement)(a.PanelBody,{title:ie((0,n.__)("Règles de visibilité avancées","visi-bloc-jlg"),re),initialOpen:!1},(0,e.createElement)(a.SelectControl,{label:(0,n.__)("Logique entre les règles","visi-bloc-jlg"),value:F.logic,options:[{value:"AND",label:(0,n.__)("Toutes les règles doivent être vraies (ET)","visi-bloc-jlg")},{value:"OR",label:(0,n.__)("Au moins une règle doit être vraie (OU)","visi-bloc-jlg")}],onChange:e=>Q(l=>({...l,logic:"OR"===e?"OR":"AND"}))}),F.rules.map((l,t)=>((l,t)=>{const i=e=>{Q(i=>{const o=[...i.rules];return o[t]=z({...l,...e}),{...i,rules:o}})},o=(0,e.createElement)(a.Flex,{align:"center",wrap:!0},(0,e.createElement)(a.FlexBlock,null,(0,e.createElement)(a.SelectControl,{label:(0,n.__)("Type de règle","visi-bloc-jlg"),value:l.type,options:S,onChange:e=>{T.includes(e)&&Q(l=>{const i=[...l.rules],o=L(e);return i[t]=o,{...l,rules:i}})}})),(0,e.createElement)(a.FlexItem,null,(0,e.createElement)(a.Button,{isDestructive:!0,variant:"tertiary",onClick:()=>{Q(e=>{const l=e.rules.filter((e,l)=>l!==t);return{...e,rules:l}})}},(0,n.__)("Supprimer","visi-bloc-jlg"))));if("post_type"===l.type){const t=q("postTypes").map(e=>({value:e.value,label:e.label}));return(0,e.createElement)("div",{key:l.id,className:"visibloc-advanced-rule"},o,(0,e.createElement)(a.SelectControl,{label:(0,n.__)("Condition","visi-bloc-jlg"),value:l.operator,options:[{value:"is",label:(0,n.__)("Est","visi-bloc-jlg")},{value:"is_not",label:(0,n.__)("N’est pas","visi-bloc-jlg")}],onChange:e=>i({operator:e})}),(0,e.createElement)(a.SelectControl,{label:(0,n.__)("Type de contenu","visi-bloc-jlg"),value:l.value,options:t,onChange:e=>i({value:e})}))}if("taxonomy"===l.type){const t=q("taxonomies"),r=t.find(e=>e.slug===l.taxonomy),s=t.map(e=>({value:e.slug,label:e.label})),c=(r&&Array.isArray(r.terms)?r.terms:[]).map(e=>({value:e.value,label:e.label})),u=(e,t)=>{const o=String(t),a=e?[...l.terms,o]:l.terms.filter(e=>e!==o);i({terms:a})};return(0,e.createElement)("div",{key:l.id,className:"visibloc-advanced-rule"},o,(0,e.createElement)(a.SelectControl,{label:(0,n.__)("Taxonomie","visi-bloc-jlg"),value:l.taxonomy,options:s,onChange:e=>i({taxonomy:e,terms:[]})}),(0,e.createElement)(a.SelectControl,{label:(0,n.__)("Condition","visi-bloc-jlg"),value:l.operator,options:[{value:"in",label:(0,n.__)("Inclut au moins un terme","visi-bloc-jlg")},{value:"not_in",label:(0,n.__)("Exclut tous les termes","visi-bloc-jlg")}],onChange:e=>i({operator:e})}),c.length>0?(0,e.createElement)("div",{className:"visibloc-advanced-rule__terms"},c.map(t=>(0,e.createElement)(a.CheckboxControl,{key:t.value,label:t.label,checked:l.terms.includes(t.value),onChange:e=>u(e,t.value)}))):(0,e.createElement)("p",{className:"components-help-text"},(0,n.__)("Aucun terme disponible pour cette taxonomie.","visi-bloc-jlg")))}if("template"===l.type){const t=q("templates").map(e=>({value:e.value,label:e.label}));return(0,e.createElement)("div",{key:l.id,className:"visibloc-advanced-rule"},o,(0,e.createElement)(a.SelectControl,{label:(0,n.__)("Condition","visi-bloc-jlg"),value:l.operator,options:[{value:"is",label:(0,n.__)("Est","visi-bloc-jlg")},{value:"is_not",label:(0,n.__)("N’est pas","visi-bloc-jlg")}],onChange:e=>i({operator:e})}),(0,e.createElement)(a.SelectControl,{label:(0,n.__)("Modèle","visi-bloc-jlg"),value:l.value,options:t,onChange:e=>i({value:e})}))}if("logged_in_status"===l.type){const t=q("loginStatuses").map(e=>({value:e.value,label:e.label}));return(0,e.createElement)("div",{key:l.id,className:"visibloc-advanced-rule"},o,(0,e.createElement)(a.SelectControl,{label:(0,n.__)("Condition","visi-bloc-jlg"),value:l.operator,options:[{value:"is",label:(0,n.__)("Est","visi-bloc-jlg")},{value:"is_not",label:(0,n.__)("N’est pas","visi-bloc-jlg")}],onChange:e=>i({operator:e})}),(0,e.createElement)(a.SelectControl,{label:(0,n.__)("État de connexion","visi-bloc-jlg"),value:l.value,options:t,onChange:e=>i({value:e})}))}if("user_role_group"===l.type){const t=q("roleGroups"),r=V("roles")||{},s=t.find(e=>e&&e.value===l.group),c=s&&Array.isArray(s.roles)?s.roles:[];return(0,e.createElement)("div",{key:l.id,className:"visibloc-advanced-rule"},o,(0,e.createElement)(a.SelectControl,{label:(0,n.__)("Condition","visi-bloc-jlg"),value:l.operator,options:[{value:"matches",label:(0,n.__)("Correspond à","visi-bloc-jlg")},{value:"does_not_match",label:(0,n.__)("Ne correspond pas à","visi-bloc-jlg")}],onChange:e=>i({operator:e})}),(0,e.createElement)(a.SelectControl,{label:(0,n.__)("Groupe de rôles","visi-bloc-jlg"),value:l.group,options:t.map(e=>({value:e.value,label:e.label})),onChange:e=>i({group:e})}),c.length>0&&(0,e.createElement)("p",{className:"components-help-text"},c.map(e=>r[e]||e).filter(Boolean).join(", ")))}if("woocommerce_cart"===l.type){const t=q("woocommerceTaxonomies"),r=Array.isArray(t)&&t.length>0,s=t.find(e=>e&&e.slug===l.taxonomy),c=r?t.map(e=>({value:e.slug,label:e.label})):[{value:"",label:(0,n.__)("Aucune taxonomie disponible","visi-bloc-jlg")}],u=s&&Array.isArray(s.terms)?s.terms.map(e=>({value:e.value,label:e.label})):[],b=(e,t)=>{const o=String(t),a=e?[...l.terms,o]:l.terms.filter(e=>e!==o);i({terms:a})};return(0,e.createElement)("div",{key:l.id,className:"visibloc-advanced-rule"},o,(0,e.createElement)(a.SelectControl,{label:(0,n.__)("Condition","visi-bloc-jlg"),value:l.operator,options:[{value:"contains",label:(0,n.__)("Contient des produits avec ces termes","visi-bloc-jlg")},{value:"not_contains",label:(0,n.__)("Ne contient aucun produit avec ces termes","visi-bloc-jlg")}],onChange:e=>i({operator:e})}),(0,e.createElement)(a.SelectControl,{label:(0,n.__)("Taxonomie WooCommerce","visi-bloc-jlg"),value:l.taxonomy,options:c,onChange:e=>i({taxonomy:e,terms:[]}),disabled:!r}),r?u.length>0?(0,e.createElement)("div",{className:"visibloc-advanced-rule__terms"},u.map(t=>(0,e.createElement)(a.CheckboxControl,{key:t.value,label:t.label,checked:l.terms.includes(t.value),onChange:e=>b(e,t.value)}))):(0,e.createElement)("p",{className:"components-help-text"},(0,n.__)("Aucun terme disponible pour cette taxonomie WooCommerce.","visi-bloc-jlg")):(0,e.createElement)("p",{className:"components-help-text"},(0,n.__)("Aucune source WooCommerce n’est disponible. Activez WooCommerce pour utiliser cette règle.","visi-bloc-jlg")))}if("query_param"===l.type){const t=q("commonQueryParams").map(e=>({value:e.value,label:e.label||e.value})),r=[{value:"",label:(0,n.__)("Personnalisé…","visi-bloc-jlg")},...t],s=[{value:"equals",label:(0,n.__)("Est égal à","visi-bloc-jlg")},{value:"not_equals",label:(0,n.__)("Est différent de","visi-bloc-jlg")},{value:"contains",label:(0,n.__)("Contient","visi-bloc-jlg")},{value:"not_contains",label:(0,n.__)("Ne contient pas","visi-bloc-jlg")},{value:"exists",label:(0,n.__)("Existe","visi-bloc-jlg")},{value:"not_exists",label:(0,n.__)("N’existe pas","visi-bloc-jlg")}],c=t.some(e=>e.value===l.param)?l.param:"";return(0,e.createElement)("div",{key:l.id,className:"visibloc-advanced-rule"},o,(0,e.createElement)(a.SelectControl,{label:(0,n.__)("Condition","visi-bloc-jlg"),value:l.operator,options:s,onChange:e=>i({operator:e})}),(0,e.createElement)(a.SelectControl,{label:(0,n.__)("Paramètre courant","visi-bloc-jlg"),value:c,options:r,onChange:e=>{e&&i({param:e})}}),(0,e.createElement)(a.TextControl,{label:(0,n.__)("Nom du paramètre","visi-bloc-jlg"),value:l.param,onChange:e=>i({param:e}),help:(0,n.__)("Saisissez le nom du paramètre de requête attendu (ex. utm_source).","visi-bloc-jlg")}),!["exists","not_exists"].includes(l.operator)&&(0,e.createElement)(a.TextControl,{label:(0,n.__)("Valeur attendue","visi-bloc-jlg"),value:l.value,onChange:e=>i({value:e})}))}const r=e=>l=>{const t=l&&l.target?l.target.value:"",o="string"==typeof t?t:"";i({[e]:o})};return(0,e.createElement)("div",{key:l.id,className:"visibloc-advanced-rule"},o,(0,e.createElement)(a.SelectControl,{label:(0,n.__)("Fréquence","visi-bloc-jlg"),value:l.frequency,options:[{value:"daily",label:(0,n.__)("Quotidien","visi-bloc-jlg")},{value:"weekly",label:(0,n.__)("Hebdomadaire","visi-bloc-jlg")}],onChange:e=>i({frequency:e,days:"weekly"===e?l.days:[]})}),(0,e.createElement)(a.Flex,{gap:"small"},(0,e.createElement)(a.FlexBlock,null,(0,e.createElement)(a.BaseControl,{label:(0,n.__)("Heure de début","visi-bloc-jlg")},(0,e.createElement)("input",{type:"time",value:l.startTime||"",onChange:r("startTime"),className:"components-text-control__input"}))),(0,e.createElement)(a.FlexBlock,null,(0,e.createElement)(a.BaseControl,{label:(0,n.__)("Heure de fin","visi-bloc-jlg")},(0,e.createElement)("input",{type:"time",value:l.endTime||"",onChange:r("endTime"),className:"components-text-control__input"})))),"weekly"===l.frequency&&P.size>0&&(0,e.createElement)("div",{className:"visibloc-advanced-rule__days"},(0,e.createElement)("p",{className:"components-base-control__label"},(0,n.__)("Jours actifs","visi-bloc-jlg")),Array.from(P.entries()).map(([t,o])=>(0,e.createElement)(a.CheckboxControl,{key:t,label:o,checked:l.days.includes(t),onChange:e=>((e,t)=>{const o=e?[...new Set([...l.days,t])]:l.days.filter(e=>e!==t);i({days:o})})(e,t)}))))})(l,t)),(0,e.createElement)(a.DropdownMenu,{text:(0,n.__)("Ajouter une règle de…","visi-bloc-jlg"),label:(0,n.__)("Ajouter une règle de…","visi-bloc-jlg"),toggleProps:{variant:"secondary"}},({onClose:l})=>(0,e.createElement)(a.MenuGroup,{label:(0,n.__)("Types de règles disponibles","visi-bloc-jlg")},S.map(t=>(0,e.createElement)(a.MenuItem,{key:t.value,onClick:()=>{Q(e=>({...e,rules:[...e.rules,L(t.value)]})),l()}},t.label)))),(0,e.createElement)("p",{className:"components-help-text"},(0,n.__)("Ces règles permettent d’affiner la visibilité selon le contexte du contenu, le modèle ou un horaire récurrent.","visi-bloc-jlg"))),(0,e.createElement)(a.PanelBody,{title:ie((0,n.__)("Contenu de repli","visi-bloc-jlg"),se),initialOpen:!1},(0,e.createElement)(a.ToggleControl,{label:(0,n.__)("Activer le repli pour ce bloc","visi-bloc-jlg"),checked:y,onChange:()=>s({fallbackEnabled:!y})}),!y&&(0,e.createElement)(a.Notice,{status:"info",isDismissible:!1},(0,n.__)("Aucun contenu de repli ne sera affiché si ce bloc est masqué.","visi-bloc-jlg")),y&&(0,e.createElement)(l.Fragment,null,(0,e.createElement)(a.SelectControl,{label:(0,n.__)("Source du repli","visi-bloc-jlg"),value:h,options:W,onChange:e=>s({fallbackBehavior:W.some(l=>l.value===e)?e:"inherit"})}),"inherit"===h&&($?(0,e.createElement)(a.Notice,{status:"info",isDismissible:!1},M?(0,n.sprintf)((0,n.__)("Repli global : %s","visi-bloc-jlg"),M):(0,n.__)("Un repli global est configuré.","visi-bloc-jlg")):(0,e.createElement)(a.Notice,{status:"warning",isDismissible:!1},(0,n.__)("Aucun repli global n’est actuellement défini.","visi-bloc-jlg"))),"text"===h&&(0,e.createElement)(a.TextareaControl,{label:(0,n.__)("Texte affiché en repli","visi-bloc-jlg"),help:(0,n.__)("Ce texte remplace le bloc lorsque les visiteurs n’y ont pas accès.","visi-bloc-jlg"),value:j,onChange:e=>s({fallbackCustomText:e})}),"block"===h&&(0,e.createElement)(l.Fragment,null,(0,e.createElement)(a.SelectControl,{label:(0,n.__)("Bloc réutilisable à afficher","visi-bloc-jlg"),value:D?String(D):"",options:[{value:"",label:(0,n.__)("— Sélectionnez un bloc —","visi-bloc-jlg")},...U],onChange:e=>{const l=parseInt(e,10);s({fallbackBlockId:Number.isNaN(l)?0:l})},disabled:!U.length}),!U.length&&(0,e.createElement)(a.Notice,{status:"warning",isDismissible:!1},(0,n.__)("Aucun bloc réutilisable publié n’est disponible.","visi-bloc-jlg"))))))))},"withVisibilityControls");function W(){const e=(0,s.select)("core/edit-post");return!!e&&("function"==typeof e.isListViewOpened?e.isListViewOpened():"function"==typeof e.isFeatureActive&&e.isFeatureActive("listView"))}function Q(){if("undefined"==typeof document)return void(I=null);const e=new Map;R.forEach((l,t)=>{const i=document.querySelector(`.block-editor-list-view__block[data-block="${t}"]`);i?(l.isHidden?i.classList.add("bloc-editeur-cache"):i.classList.remove("bloc-editeur-cache"),l.hasFallback?i.classList.add("bloc-editeur-repli"):i.classList.remove("bloc-editeur-repli")):e.set(t,l)}),R.clear(),e.size&&e.forEach((e,l)=>{R.set(l,e)}),I=R.size&&W()?window.requestAnimationFrame(()=>{Q()}):null}function J(e,l){const t=R.get(e);t&&t.isHidden===l.isHidden&&t.hasFallback===l.hasFallback&&t.hiddenDescription===l.hiddenDescription&&t.fallbackDescription===l.fallbackDescription||(R.set(e,l),I||(I=window.requestAnimationFrame(()=>{Q()})))}(0,t.addFilter)("blocks.registerBlockType","visi-bloc-jlg/add-visibility-attributes",function(e,l){return v(l)?(e.attributes={...e.attributes,isHidden:{type:"boolean",default:!1},deviceVisibility:{type:"string",default:"all"},isSchedulingEnabled:{type:"boolean",default:!1},publishStartDate:{type:"string"},publishEndDate:{type:"string"},visibilityRoles:{type:"array",default:[]},advancedVisibility:{type:"object",default:D},fallbackEnabled:{type:"boolean",default:!0},fallbackBehavior:{type:"string",default:"inherit"},fallbackCustomText:{type:"string",default:""},fallbackBlockId:{type:"number"}},e):e}),(0,t.addFilter)("editor.BlockEdit","visi-bloc-jlg/with-visibility-controls",U),(0,t.addFilter)("blocks.getSaveContent.extraProps","visi-bloc-jlg/add-save-classes",function(e,l,t){if(!v(l.name)||!t)return e;const{deviceVisibility:i}=t,o=[e.className,i&&"all"!==i?`vb-${i}`:""].filter(Boolean).join(" ");return{...e,className:o}}),(0,t.addFilter)("editor.BlockListBlock","visi-bloc-jlg/add-editor-status-badges",(0,i.createHigherOrderComponent)(t=>i=>{const o="string"==typeof i.className?i.className:"",a=o.includes("bloc-editeur-cache"),r=o.includes("bloc-editeur-repli"),s=i.clientId&&O.get(i.clientId)||{},c="string"==typeof s.hiddenDescription?s.hiddenDescription:"",b="string"==typeof s.fallbackDescription?s.fallbackDescription:"";if(!a&&!r)return(0,e.createElement)(t,{...i});const p=(0,e.createElement)(t,{...i}),m=l.Children.toArray(p.props.children),d=[];return a&&d.push((0,e.createElement)(u,{key:"visibloc-hidden-badge",label:(0,n.__)("Bloc masqué","visi-bloc-jlg"),variant:"hidden",screenReaderText:(0,n.__)("Ce bloc est masqué pour les visiteurs du site.","visi-bloc-jlg"),description:c})),r&&d.push((0,e.createElement)(u,{key:"visibloc-fallback-badge",label:(0,n.__)("Repli actif","visi-bloc-jlg"),variant:"fallback",screenReaderText:(0,n.__)("Le contenu de repli est affiché à la place du bloc original.","visi-bloc-jlg"),description:b})),(0,l.cloneElement)(p,p.props,[...d,...m])},"withVisibilityStatusBadges")),(0,t.addFilter)("editor.BlockListBlock.props","visi-bloc-jlg/add-editor-canvas-classes",function(e,l){if(!v(l.name)||!l.attributes)return e;const{isHidden:t}=l.attributes,i=H(l.attributes),o=[e.className,t?"bloc-editeur-cache":"",i?"bloc-editeur-repli":""].filter(Boolean).join(" ");return{...e,className:o}});let Y=W();(0,s.subscribe)(function(){const e=W();!function(){const e=(0,s.select)("core/block-editor");if(!e)return;const l=e.getBlockOrder();if(!l.length)return;const t=[...l],i=new Set;for(;t.length;){const l=t.pop(),o=e.getBlock(l);if(o){if(v(o.name)){const e=Boolean(o.attributes.isHidden),t=H(o.attributes),a=O.get(l)||{},n={...a,isHidden:e,hasFallback:t};a.isHidden===n.isHidden&&a.hasFallback===n.hasFallback||J(l,n),O.set(l,n),i.add(l)}o.innerBlocks&&o.innerBlocks.length&&o.innerBlocks.forEach(e=>{e&&e.clientId&&t.push(e.clientId)})}}i.size!==O.size&&Array.from(O.keys()).forEach(e=>{i.has(e)||(O.delete(e),R.delete(e))})}(),e&&!Y&&function(){if(!R.size)return;const e=Array.from(R.entries());R.clear(),I&&(window.cancelAnimationFrame(I),I=null),e.forEach(([e,l])=>{J(e,l)})}(),Y=e})})();