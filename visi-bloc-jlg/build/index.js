(()=>{var e={124:(e,t,i)=>{var l=i(325);e.exports=function(){return l.Date.now()}},128:(e,t,i)=>{var l=i(800),r=/^\s+/;e.exports=function(e){return e?e.slice(0,l(e)+1).replace(r,""):e}},221:(e,t,i)=>{var l=i(805),r=i(124),a=i(374),s=Math.max,o=Math.min;e.exports=function(e,t,i){var n,c,u,d,p,b,m=0,g=!1,v=!1,_=!0;if("function"!=typeof e)throw new TypeError("Expected a function");function f(t){var i=n,l=c;return n=c=void 0,m=t,d=e.apply(l,i)}function y(e){var i=e-b;return void 0===b||i>=t||i<0||v&&e-m>=u}function h(){var e=r();if(y(e))return j(e);p=setTimeout(h,function(e){var i=t-(e-b);return v?o(i,u-(e-m)):i}(e))}function j(e){return p=void 0,_&&n?f(e):(n=c=void 0,d)}function E(){var e=r(),i=y(e);if(n=arguments,c=this,b=e,i){if(void 0===p)return function(e){return m=e,p=setTimeout(h,t),g?f(e):d}(b);if(v)return clearTimeout(p),p=setTimeout(h,t),f(b)}return void 0===p&&(p=setTimeout(h,t)),d}return t=a(t)||0,l(i)&&(g=!!i.leading,u=(v="maxWait"in i)?s(a(i.maxWait)||0,t):u,_="trailing"in i?!!i.trailing:_),E.cancel=function(){void 0!==p&&clearTimeout(p),m=0,n=b=c=p=void 0},E.flush=function(){return void 0===p?d:j(r())},E}},325:(e,t,i)=>{var l=i(840),r="object"==typeof self&&self&&self.Object===Object&&self,a=l||r||Function("return this")();e.exports=a},346:e=>{e.exports=function(e){return null!=e&&"object"==typeof e}},350:e=>{var t=Object.prototype.toString;e.exports=function(e){return t.call(e)}},374:(e,t,i)=>{var l=i(128),r=i(805),a=i(394),s=/^[-+]0x[0-9a-f]+$/i,o=/^0b[01]+$/i,n=/^0o[0-7]+$/i,c=parseInt;e.exports=function(e){if("number"==typeof e)return e;if(a(e))return NaN;if(r(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=r(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=l(e);var i=o.test(e);return i||n.test(e)?c(e.slice(2),i?2:8):s.test(e)?NaN:+e}},394:(e,t,i)=>{var l=i(552),r=i(346);e.exports=function(e){return"symbol"==typeof e||r(e)&&"[object Symbol]"==l(e)}},552:(e,t,i)=>{var l=i(873),r=i(659),a=i(350),s=l?l.toStringTag:void 0;e.exports=function(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":s&&s in Object(e)?r(e):a(e)}},659:(e,t,i)=>{var l=i(873),r=Object.prototype,a=r.hasOwnProperty,s=r.toString,o=l?l.toStringTag:void 0;e.exports=function(e){var t=a.call(e,o),i=e[o];try{e[o]=void 0;var l=!0}catch(e){}var r=s.call(e);return l&&(t?e[o]=i:delete e[o]),r}},800:e=>{var t=/\s/;e.exports=function(e){for(var i=e.length;i--&&t.test(e.charAt(i)););return i}},805:e=>{e.exports=function(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)}},840:(e,t,i)=>{var l="object"==typeof i.g&&i.g&&i.g.Object===Object&&i.g;e.exports=l},873:(e,t,i)=>{var l=i(325).Symbol;e.exports=l}},t={};function i(l){var r=t[l];if(void 0!==r)return r.exports;var a=t[l]={exports:{}};return e[l](a,a.exports,i),a.exports}i.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return i.d(t,{a:t}),t},i.d=(e,t)=>{for(var l in t)i.o(t,l)&&!i.o(e,l)&&Object.defineProperty(e,l,{enumerable:!0,get:t[l]})},i.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{"use strict";const e=window.React,t=window.wp.element,l=window.wp.hooks,r=window.wp.compose,a=window.wp.blockEditor,s=window.wp.components,o=window.wp.i18n,n=window.wp.date,c=window.wp.apiFetch;var u=i.n(c);const d=window.wp.data,p=window.wp.autop;var b=i.n(p),m=i(221),g=i.n(m);const v=window.wp.htmlEntities,_=window.wp.url,f="visi-bloc-jlg/onboarding",y=["objective","audience","timing","content"],h={goal:"",description:"",successMetric:""},j={primary:"",secondary:"",notes:"",roles:""},E={start:"",end:"",cadence:""},k={promise:"",callToAction:"",fallback:""};function C(){return{objective:{...h},audience:{...j},timing:{...E},content:{...k}}}const S={isOpen:!1,currentStep:y[0],steps:C(),recipes:[],selectedRecipeId:"",badges:{},mode:"simple",restEndpoint:"",hasInitialized:!1,hasLoadedDraft:!1,isLoadingDraft:!1,isSavingDraft:!1,lastError:"",draftUpdatedAt:null},x="INITIALIZE",A="SET_OPEN",w="SET_STEP",N="UPDATE_STEP",B="APPLY_RECIPE",T="RECEIVE_RECIPES",D="SET_BADGES",R="START_LOAD_DRAFT",M="FINISH_LOAD_DRAFT",L="START_SAVE_DRAFT",I="FINISH_SAVE_DRAFT",z="RESET_ERROR",O="RESET_STEPS";function q(e){return Array.isArray(e)?e.map(e=>q(e)):e&&"object"==typeof e?Object.keys(e).reduce((t,i)=>(t[i]=q(e[i]),t),{}):"number"==typeof e?String(e):"string"==typeof e?e:""}function P(e,t){return t&&"object"==typeof t?{...e,...Object.keys(t).reduce((i,l)=>(Object.prototype.hasOwnProperty.call(e,l)&&(i[l]=q(t[l])),i),{})}:e}function V(e){if(!e||"object"!=typeof e)return null;const t=(e.id&&"string"==typeof e.id?e.id:"")||`recipe-${Math.random().toString(36).slice(2)}`;return{id:t,title:e.title&&"string"==typeof e.title?e.title:t,summary:e.summary&&"string"==typeof e.summary?e.summary:"",steps:{objective:P(h,e.objective||{}),audience:P(j,e.audience||{}),timing:P(E,e.timing||{}),content:P(k,e.content||{})}}}const F={API_FETCH({path:e,method:t="GET",data:i}){if(!e)return Promise.resolve(null);const l={method:t,data:i};return/^https?:/i.test(e)?l.url=e:l.path=e,u()(l)}},H={initialize:e=>({type:x,config:e}),openWizard:()=>({type:A,isOpen:!0}),closeWizard:()=>({type:A,isOpen:!1}),goToStep:e=>({type:w,step:e}),updateStep:(e,t)=>({type:N,step:e,values:t}),applyRecipe:e=>({type:B,recipeId:e}),setBadges:e=>({type:D,badges:e}),receiveRecipes:e=>({type:T,recipes:e}),loadDraft:function*(e){if(e){yield{type:R};try{const t=yield{type:"API_FETCH",path:e,method:"GET"};yield{type:M,draft:t&&t.draft?t.draft:null,updatedAt:t&&t.updatedAt?t.updatedAt:null}}catch(e){const t=e&&e.message?e.message:(0,o.__)("Erreur de chargement du brouillon.","visi-bloc-jlg");yield{type:M,error:t}}}},saveDraft:function*(e,t){if(e){yield{type:L};try{const i=yield{type:"API_FETCH",path:e,method:"POST",data:t};yield{type:I,updatedAt:i&&i.updatedAt?i.updatedAt:null}}catch(e){const t=e&&e.message?e.message:(0,o.__)("Impossible d’enregistrer le brouillon.","visi-bloc-jlg");yield{type:I,error:t}}}},resetSteps:()=>({type:O}),resetError:()=>({type:z})},$={isOpen:e=>e.isOpen,getCurrentStep:e=>e.currentStep,getSteps:e=>e.steps,getStepValues:(e,t)=>t&&Object.prototype.hasOwnProperty.call(e.steps,t)?e.steps[t]:e.steps.objective,getRecipes:e=>e.recipes,getSelectedRecipeId:e=>e.selectedRecipeId,getBadges:e=>e.badges,getMode:e=>e.mode,getRestEndpoint:e=>e.restEndpoint,hasLoadedDraft:e=>e.hasLoadedDraft,isLoadingDraft:e=>e.isLoadingDraft,isSavingDraft:e=>e.isSavingDraft,getLastError:e=>e.lastError,getDraftUpdatedAt:e=>e.draftUpdatedAt,getDraftPayload:e=>({recipeId:e.selectedRecipeId,steps:e.steps,mode:e.mode}),isInitialized:e=>e.hasInitialized};function W(e=e=>e,i=[]){const l=(0,d.useSelect)(t=>{const i=t(f);return i?e(i):{}},i),r=(0,d.useDispatch)(f);return(0,t.useMemo)(()=>({...l,actions:r}),[l,r])}function G(){const{goal:t="",description:i="",successMetric:l="",actions:r}=W(e=>e.getStepValues("objective"),[]),a=(e,t)=>{r.updateStep("objective",{[e]:t})};return(0,e.createElement)("div",{className:"visibloc-onboarding-step visibloc-onboarding-step--objective"},(0,e.createElement)(s.TextControl,{label:(0,o.__)("Objectif principal","visi-bloc-jlg"),value:t,onChange:e=>a("goal",e)}),(0,e.createElement)(s.TextareaControl,{label:(0,o.__)("Description","visi-bloc-jlg"),value:i,onChange:e=>a("description",e),help:(0,o.__)("Expliquez comment l’assistant doit orienter la campagne.","visi-bloc-jlg"),rows:4}),(0,e.createElement)(s.TextControl,{label:(0,o.__)("Indicateur de succès","visi-bloc-jlg"),value:l,onChange:e=>a("successMetric",e),help:(0,o.__)("Exemple : “Taux de conversion supérieur à 5 %”.","visi-bloc-jlg")}))}(0,d.registerStore)(f,{reducer:function(e=S,t){switch(t.type){case x:return function(e,t){if(e.hasInitialized)return e;const i={...e,hasInitialized:!0};if(t&&"object"==typeof t){if(Array.isArray(t.recipes)&&(i.recipes=t.recipes.map(e=>V(e))),t.mode&&"string"==typeof t.mode){const e=t.mode.toLowerCase();i.mode="expert"===e?"expert":"simple"}t.restEndpoint&&"string"==typeof t.restEndpoint&&(i.restEndpoint=t.restEndpoint)}return i}(e,t.config);case A:return{...e,isOpen:t.isOpen,currentStep:t.isOpen?e.currentStep:y[0]};case w:{const i=y.includes(t.step)?t.step:e.currentStep;return{...e,currentStep:i}}case N:return Object.prototype.hasOwnProperty.call(e.steps,t.step)?{...e,steps:{...e.steps,[t.step]:P(e.steps[t.step],t.values)}}:e;case B:{const i=e.recipes.find(e=>e.id===t.recipeId);return i?{...e,selectedRecipeId:i.id,steps:{objective:{...i.steps.objective},audience:{...i.steps.audience},timing:{...i.steps.timing},content:{...i.steps.content}},currentStep:e.currentStep}:{...e,selectedRecipeId:"",steps:C()}}case T:return{...e,recipes:Array.isArray(t.recipes)?t.recipes.map(e=>V(e)).filter(Boolean):e.recipes};case D:return{...e,badges:t.badges&&"object"==typeof t.badges?t.badges:{}};case R:return{...e,isLoadingDraft:!0,lastError:""};case M:{const i=t.draft&&t.draft.steps?t.draft.steps:null;return{...e,isLoadingDraft:!1,hasLoadedDraft:!0,lastError:t.error||"",steps:i?{objective:P(h,i.objective),audience:P(j,i.audience),timing:P(E,i.timing),content:P(k,i.content)}:e.steps,selectedRecipeId:t.draft&&"string"==typeof t.draft.recipeId?t.draft.recipeId:e.selectedRecipeId,draftUpdatedAt:t.updatedAt||null}}case L:return{...e,isSavingDraft:!0,lastError:""};case I:return{...e,isSavingDraft:!1,draftUpdatedAt:t.updatedAt||e.draftUpdatedAt,lastError:t.error||""};case"SET_ERROR":return{...e,lastError:t.message||""};case z:return{...e,lastError:""};case O:return{...e,steps:C(),selectedRecipeId:""};default:return e}},actions:H,selectors:$,controls:F});const U={objective:G,audience:function(){const{primary:t="",secondary:i="",notes:l="",roles:r="",actions:a}=W(e=>e.getStepValues("audience"),[]),n=(e,t)=>{a.updateStep("audience",{[e]:t})};return(0,e.createElement)("div",{className:"visibloc-onboarding-step visibloc-onboarding-step--audience"},(0,e.createElement)(s.TextareaControl,{label:(0,o.__)("Segment principal","visi-bloc-jlg"),value:t,onChange:e=>n("primary",e),rows:3}),(0,e.createElement)(s.TextareaControl,{label:(0,o.__)("Segment secondaire","visi-bloc-jlg"),value:i,onChange:e=>n("secondary",e),rows:3}),(0,e.createElement)(s.TextControl,{label:(0,o.__)("Rôles ou profils cibles","visi-bloc-jlg"),value:r,onChange:e=>n("roles",e),help:(0,o.__)("Indiquez les rôles WordPress ou personas CRM concernés.","visi-bloc-jlg")}),(0,e.createElement)(s.TextareaControl,{label:(0,o.__)("Notes ou exclusions","visi-bloc-jlg"),value:l,onChange:e=>n("notes",e),rows:4}))},timing:function(){const{start:t="",end:i="",cadence:l="",actions:r}=W(e=>e.getStepValues("timing"),[]),a=(e,t)=>{r.updateStep("timing",{[e]:t})};return(0,e.createElement)("div",{className:"visibloc-onboarding-step visibloc-onboarding-step--timing"},(0,e.createElement)(s.TextControl,{label:(0,o.__)("Point de départ","visi-bloc-jlg"),value:t,onChange:e=>a("start",e),help:(0,o.__)("Exemple : “Dès l’inscription” ou “J+3 après l’achat”.","visi-bloc-jlg")}),(0,e.createElement)(s.TextControl,{label:(0,o.__)("Date ou condition de fin","visi-bloc-jlg"),value:i,onChange:e=>a("end",e)}),(0,e.createElement)(s.TextControl,{label:(0,o.__)("Cadence","visi-bloc-jlg"),value:l,onChange:e=>a("cadence",e),help:(0,o.__)("Décrivez la fréquence (ex. “3 rappels sur 10 jours”).","visi-bloc-jlg")}))},content:function(){const{promise:t="",callToAction:i="",fallback:l="",actions:r}=W(e=>e.getStepValues("content"),[]),a=(e,t)=>{r.updateStep("content",{[e]:t})};return(0,e.createElement)("div",{className:"visibloc-onboarding-step visibloc-onboarding-step--content"},(0,e.createElement)(s.TextareaControl,{label:(0,o.__)("Promesse / message clé","visi-bloc-jlg"),value:t,onChange:e=>a("promise",e),rows:3}),(0,e.createElement)(s.TextControl,{label:(0,o.__)("Appel à l’action","visi-bloc-jlg"),value:i,onChange:e=>a("callToAction",e)}),(0,e.createElement)(s.TextareaControl,{label:(0,o.__)("Fallback ou alternative","visi-bloc-jlg"),value:l,onChange:e=>a("fallback",e),rows:3,help:(0,o.__)("Message affiché si la condition échoue (optionnel).","visi-bloc-jlg")}))}};function J({currentStep:t,onSelectStep:i}){return(0,e.createElement)(s.Flex,{className:"visibloc-onboarding-nav",wrap:!0},y.map((l,r)=>{const a=t===l,n=[(0,o.sprintf)((0,o.__)("Étape %1$d","visi-bloc-jlg"),r+1),Q(l)].filter(Boolean).join(" · ");return(0,e.createElement)(s.FlexItem,{key:l},(0,e.createElement)(s.Button,{variant:a?"primary":"tertiary",onClick:()=>i(l),"aria-current":a?"step":void 0},n))}))}function Q(e){switch(e){case"objective":return(0,o.__)("Objectif","visi-bloc-jlg");case"audience":return(0,o.__)("Audience","visi-bloc-jlg");case"timing":return(0,o.__)("Timing","visi-bloc-jlg");case"content":return(0,o.__)("Contenu","visi-bloc-jlg");default:return""}}function Y({badges:t}){const i=Object.entries(t||{});return 0===i.length?null:(0,e.createElement)("ul",{className:"visibloc-onboarding-badges"},i.map(([t,i])=>(0,e.createElement)("li",{key:t,className:`visibloc-onboarding-badges__item visibloc-onboarding-badges__item--${i.variant||"info"}`},(0,e.createElement)("span",{className:"visibloc-onboarding-badges__label"},i.label),i.description?(0,e.createElement)("span",{className:"visibloc-onboarding-badges__description"},i.description):null)))}function X(){const{isOpen:i,currentStep:l,actions:r,recipes:a,selectedRecipeId:n,badges:c,isSavingDraft:u,isLoadingDraft:d,hasLoadedDraft:p,draftUpdatedAt:b,lastError:m,restEndpoint:g,draftPayload:v,hasInitialized:_}=W(e=>({isOpen:e.isOpen(),currentStep:e.getCurrentStep(),recipes:e.getRecipes(),selectedRecipeId:e.getSelectedRecipeId(),badges:e.getBadges(),isSavingDraft:e.isSavingDraft(),isLoadingDraft:e.isLoadingDraft(),hasLoadedDraft:e.hasLoadedDraft(),draftUpdatedAt:e.getDraftUpdatedAt(),lastError:e.getLastError(),restEndpoint:e.getRestEndpoint(),draftPayload:e.getDraftPayload(),hasInitialized:!!e.isInitialized&&e.isInitialized()}));(0,t.useEffect)(()=>{if(_)return;const e=window.VisiBlocData&&window.VisiBlocData.onboarding||{};r.initialize(e)},[r,_]),(0,t.useEffect)(()=>{g&&!p&&r.loadDraft(g)},[r,g,p]);const f=U[l]||G,y=(0,t.useMemo)(()=>function(e){return Array.isArray(e)?[{label:(0,o.__)("Aucune recette appliquée","visi-bloc-jlg"),value:""},...e.map(e=>({label:e.title||e.id,value:e.id}))]:[]}(a),[a]),h=(0,t.useMemo)(()=>{if(!b)return"";try{return new Date(1e3*b).toLocaleString()}catch(e){return""}},[b]);return i?(0,e.createElement)(s.Modal,{title:(0,o.__)("Assistant visibilité – Onboarding","visi-bloc-jlg"),onRequestClose:()=>r.closeWizard(),className:"visibloc-onboarding-modal"},(0,e.createElement)(s.Card,null,(0,e.createElement)(s.CardHeader,null,(0,e.createElement)("div",{className:"visibloc-onboarding-modal__header"},(0,e.createElement)(s.SelectControl,{label:(0,o.__)("Bibliothèque de recettes","visi-bloc-jlg"),value:n,options:y,onChange:e=>r.applyRecipe(e)}),(0,e.createElement)(Y,{badges:c}))),(0,e.createElement)(s.CardBody,null,d&&!p?(0,e.createElement)("div",{className:"visibloc-onboarding-loading"},(0,e.createElement)(s.Spinner,null),(0,e.createElement)("p",null,(0,o.__)("Chargement du brouillon…","visi-bloc-jlg"))):(0,e.createElement)(e.Fragment,null,(0,e.createElement)(J,{currentStep:l,onSelectStep:e=>r.goToStep(e)}),(0,e.createElement)("div",{className:"visibloc-onboarding-modal__content"},(0,e.createElement)(f,null))),m?(0,e.createElement)(s.Notice,{status:"error",isDismissible:!0,onRemove:()=>r.resetError()},m):null),(0,e.createElement)(s.CardFooter,null,(0,e.createElement)(s.Flex,{justify:"space-between",align:"center"},(0,e.createElement)(s.FlexItem,null,h?(0,e.createElement)("span",{className:"visibloc-onboarding-modal__meta"},(0,o.sprintf)((0,o.__)("Dernier enregistrement : %s","visi-bloc-jlg"),h)):null),(0,e.createElement)(s.FlexItem,null,(0,e.createElement)(s.Button,{variant:"secondary",onClick:()=>r.resetSteps(),disabled:u},(0,o.__)("Réinitialiser","visi-bloc-jlg"))),(0,e.createElement)(s.FlexItem,null,(0,e.createElement)(s.Button,{variant:"primary",onClick:()=>r.saveDraft(g,v),isBusy:u,disabled:u},u?(0,o.__)("Enregistrement…","visi-bloc-jlg"):(0,o.__)("Enregistrer le brouillon","visi-bloc-jlg"))))))):null}const Z=["core/group"],K=s.ToggleGroupControlOptionIcon||s.ToggleGroupControlOption,ee=Boolean(s.ToggleGroupControl)&&Boolean(K),te="function"==typeof s.FormTokenField,ie=()=>(0,e.createElement)("svg",{width:"24",height:"24",viewBox:"0 0 24 24",role:"presentation",focusable:"false","aria-hidden":"true"},(0,e.createElement)("rect",{x:"7",y:"3",width:"10",height:"18",rx:"2",ry:"2",fill:"currentColor",opacity:"0.2"}),(0,e.createElement)("rect",{x:"9",y:"5",width:"6",height:"14",rx:"1.2",ry:"1.2",fill:"none",stroke:"currentColor",strokeWidth:"1.5"}),(0,e.createElement)("circle",{cx:"12",cy:"17.5",r:"0.9",fill:"currentColor"})),le=()=>(0,e.createElement)("svg",{width:"24",height:"24",viewBox:"0 0 24 24",role:"presentation",focusable:"false","aria-hidden":"true"},(0,e.createElement)("rect",{x:"3",y:"7",width:"18",height:"10",rx:"2",ry:"2",fill:"currentColor",opacity:"0.2"}),(0,e.createElement)("rect",{x:"5",y:"9",width:"14",height:"6",rx:"1.2",ry:"1.2",fill:"none",stroke:"currentColor",strokeWidth:"1.5"}),(0,e.createElement)("circle",{cx:"17.5",cy:"12",r:"0.9",fill:"currentColor"})),re=()=>(0,e.createElement)("svg",{width:"24",height:"24",viewBox:"0 0 24 24",role:"presentation",focusable:"false","aria-hidden":"true"},(0,e.createElement)("rect",{x:"4",y:"5",width:"16",height:"14",rx:"2.4",fill:"currentColor",opacity:"0.18"}),(0,e.createElement)("path",{d:"M7 9.5h10M7 12h6M7 14.5h4",fill:"none",stroke:"currentColor",strokeWidth:"1.6",strokeLinecap:"round",strokeLinejoin:"round"})),ae=()=>(0,e.createElement)("svg",{width:"24",height:"24",viewBox:"0 0 24 24",role:"presentation",focusable:"false","aria-hidden":"true"},(0,e.createElement)("rect",{x:"3",y:"4",width:"18",height:"16",rx:"2.6",fill:"currentColor",opacity:"0.18"}),(0,e.createElement)("path",{d:"M7 9.5h6l2-2.5 2 6 2-3.5",fill:"none",stroke:"currentColor",strokeWidth:"1.6",strokeLinecap:"round",strokeLinejoin:"round"}),(0,e.createElement)("circle",{cx:"9",cy:"15",r:"1.3",fill:"currentColor"}),(0,e.createElement)("circle",{cx:"15",cy:"15",r:"1.3",fill:"currentColor"})),se=()=>(0,e.createElement)("svg",{width:"16",height:"16",viewBox:"0 0 24 24",role:"presentation",focusable:"false","aria-hidden":"true"},(0,e.createElement)("path",{d:"m12 4 8 14H4z",fill:"none",stroke:"currentColor",strokeWidth:"1.6",strokeLinejoin:"round"}),(0,e.createElement)("path",{d:"M12 10v4",stroke:"currentColor",strokeWidth:"1.8",strokeLinecap:"round",strokeLinejoin:"round"}),(0,e.createElement)("circle",{cx:"12",cy:"17",r:"1",fill:"currentColor"})),oe={hidden:()=>(0,e.createElement)("svg",{width:"16",height:"16",viewBox:"0 0 24 24",role:"presentation",focusable:"false","aria-hidden":"true"},(0,e.createElement)("path",{d:"M2 12c2.8-5.3 6.5-8 10-8s7.2 2.7 10 8c-2.8 5.3-6.5 8-10 8s-7.2-2.7-10-8z",fill:"none",stroke:"currentColor",strokeWidth:"1.6",strokeLinejoin:"round"}),(0,e.createElement)("circle",{cx:"12",cy:"12",r:"3",fill:"currentColor",opacity:"0.2"}),(0,e.createElement)("path",{d:"M12 9a3 3 0 0 1 3 3m6.5 6.5-17-17",fill:"none",stroke:"currentColor",strokeWidth:"1.6",strokeLinecap:"round"})),schedule:()=>(0,e.createElement)("svg",{width:"16",height:"16",viewBox:"0 0 24 24",role:"presentation",focusable:"false","aria-hidden":"true"},(0,e.createElement)("circle",{cx:"12",cy:"12",r:"7.5",fill:"none",stroke:"currentColor",strokeWidth:"1.6"}),(0,e.createElement)("path",{d:"M12 8.5v4l2.5 2",fill:"none",stroke:"currentColor",strokeWidth:"1.6",strokeLinecap:"round",strokeLinejoin:"round"})),"schedule-error":()=>(0,e.createElement)("svg",{width:"16",height:"16",viewBox:"0 0 24 24",role:"presentation",focusable:"false","aria-hidden":"true"},(0,e.createElement)("circle",{cx:"11",cy:"11",r:"7",fill:"none",stroke:"currentColor",strokeWidth:"1.6"}),(0,e.createElement)("path",{d:"M11 7.5v3.7l2.1 1.6",fill:"none",stroke:"currentColor",strokeWidth:"1.6",strokeLinecap:"round",strokeLinejoin:"round"}),(0,e.createElement)("path",{d:"M17.5 13.5v3.5",fill:"none",stroke:"currentColor",strokeWidth:"1.6",strokeLinecap:"round"}),(0,e.createElement)("circle",{cx:"17.5",cy:"18.5",r:"0.8",fill:"currentColor"})),fallback:()=>(0,e.createElement)("svg",{width:"16",height:"16",viewBox:"0 0 24 24",role:"presentation",focusable:"false","aria-hidden":"true"},(0,e.createElement)("path",{d:"M5.5 9.5 12 6l6.5 3.5L12 13z",fill:"none",stroke:"currentColor",strokeWidth:"1.6",strokeLinejoin:"round"}),(0,e.createElement)("path",{d:"M5.5 14.5 12 18l6.5-3.5",fill:"none",stroke:"currentColor",strokeWidth:"1.6",strokeLinejoin:"round"})),advanced:()=>(0,e.createElement)("svg",{width:"16",height:"16",viewBox:"0 0 24 24",role:"presentation",focusable:"false","aria-hidden":"true"},(0,e.createElement)("path",{d:"M7 5v14M17 5v14",fill:"none",stroke:"currentColor",strokeWidth:"1.6",strokeLinecap:"round"}),(0,e.createElement)("circle",{cx:"7",cy:"10",r:"2.5",fill:"currentColor",opacity:"0.2",stroke:"currentColor",strokeWidth:"1.2"}),(0,e.createElement)("circle",{cx:"17",cy:"14",r:"2.5",fill:"currentColor",opacity:"0.2",stroke:"currentColor",strokeWidth:"1.2"})),conditional:se,warning:se,critical:()=>(0,e.createElement)("svg",{width:"16",height:"16",viewBox:"0 0 24 24",role:"presentation",focusable:"false","aria-hidden":"true"},(0,e.createElement)("circle",{cx:"12",cy:"12",r:"7.5",fill:"none",stroke:"currentColor",strokeWidth:"1.6"}),(0,e.createElement)("path",{d:"M9.6 9.6 14.4 14.4m0-4.8L9.6 14.4",fill:"none",stroke:"currentColor",strokeWidth:"1.8",strokeLinecap:"round"})),success:()=>(0,e.createElement)("svg",{width:"16",height:"16",viewBox:"0 0 24 24",role:"presentation",focusable:"false","aria-hidden":"true"},(0,e.createElement)("circle",{cx:"12",cy:"12",r:"7.5",fill:"none",stroke:"currentColor",strokeWidth:"1.6"}),(0,e.createElement)("path",{d:"m8.8 12.4 2.3 2.3 4-4.7",fill:"none",stroke:"currentColor",strokeWidth:"1.8",strokeLinecap:"round",strokeLinejoin:"round"})),default:()=>(0,e.createElement)("svg",{width:"16",height:"16",viewBox:"0 0 24 24",role:"presentation",focusable:"false","aria-hidden":"true"},(0,e.createElement)("circle",{cx:"12",cy:"12",r:"8",fill:"none",stroke:"currentColor",strokeWidth:"1.6"}),(0,e.createElement)("circle",{cx:"12",cy:"8.5",r:"1",fill:"currentColor"}),(0,e.createElement)("path",{d:"M11 11.5h2v6",fill:"none",stroke:"currentColor",strokeWidth:"1.6",strokeLinecap:"round"}))},ne={success:(0,o.__)("Gravité : réussite","visi-bloc-jlg"),info:(0,o.__)("Gravité : information","visi-bloc-jlg"),warning:(0,o.__)("Gravité : avertissement","visi-bloc-jlg"),critical:(0,o.__)("Gravité : critique","visi-bloc-jlg")},ce=({label:t,variant:i="",screenReaderText:l="",description:r=""})=>{const a=["visibloc-status-badge"],o="string"==typeof r&&r.trim().length>0,n="string"==typeof i?i.trim():"";n&&a.push(`visibloc-status-badge--${n}`);const c=oe[n]||oe.default,u=(0,e.createElement)("span",{className:a.join(" ")},c?(0,e.createElement)("span",{className:"visibloc-status-badge__icon","aria-hidden":"true"},(0,e.createElement)(c,null)):null,(0,e.createElement)("span",{className:"visibloc-status-badge__label"},t),o?(0,e.createElement)("span",{className:"visibloc-status-badge__description"},r):null,l?(0,e.createElement)("span",{className:"screen-reader-text"},l):null);return o?(0,e.createElement)(s.Tooltip,{text:r},u):u},ue=36e5,de=e=>Array.isArray(e)?Array.from(new Set(e.map(e=>"string"==typeof e?e.trim():"").filter(Boolean))):[],pe=de("object"==typeof VisiBlocData&&null!==VisiBlocData&&Array.isArray(VisiBlocData.supportedBlocks)?VisiBlocData.supportedBlocks:Z),be=pe.length>0?pe:Z,me=de((0,l.applyFilters)("visiblocSupportedBlocks",be)),ge=me.length>0?me:be,ve=e=>ge.includes(e),_e="function"==typeof n.__experimentalGetSettings?(0,n.__experimentalGetSettings)():{},{formats:fe={}}=_e||{},ye="string"==typeof fe.date&&fe.date.trim()?fe.date:"F j, Y",he="string"==typeof fe.time&&fe.time.trim()?fe.time:"H:i",je="string"==typeof fe.datetime&&fe.datetime.trim()?fe.datetime:`${ye} ${he}`.trim(),Ee=(e=>{if(!e||"object"!=typeof e)return!1;if("boolean"==typeof e.twelveHourTime)return e.twelveHourTime;const{formats:t}=e;if(t&&"object"==typeof t){const{time:e}=t;if("string"==typeof e&&e.trim())return/a(?!\\)/i.test(e)}return!1})(_e),ke=(()=>{if(!_e||"object"!=typeof _e)return"UTC";const{timezone:e,timezoneAbbr:t,gmt_offset:i}=_e;if(e&&"object"==typeof e){if("string"==typeof e.string&&e.string.trim())return e.string.trim();if("string"==typeof e.abbr&&e.abbr.trim())return e.abbr.trim()}if("string"==typeof e&&e.trim())return e.trim();if("string"==typeof t&&t.trim())return t.trim();return(e=>{if("number"!=typeof e||Number.isNaN(e))return"";if(0===e)return"UTC";const t=e>0?"+":"-",i=Math.abs(e),l=Math.round(60*i),r=Math.floor(l/60),a=l%60;return`UTC${t}${String(r).padStart(2,"0")}:${String(a).padStart(2,"0")}`})(i)||"UTC"})(),Ce=e=>e?"function"==typeof n.dateI18n?(0,n.dateI18n)(je,e):(0,n.format)(je,e):null,Se=()=>(0,n.format)("Y-m-d\\TH:i:s",new Date),xe=e=>{if(!e)return null;const t=new Date(e);return Number.isNaN(t.getTime())?null:t},Ae={id:"all",label:(0,o.__)("Visible sur tous les appareils","visi-bloc-jlg")},we=[{id:"show-only",label:(0,o.__)("Afficher uniquement","visi-bloc-jlg"),options:[{id:"desktop-only",label:(0,o.__)("Desktop","visi-bloc-jlg"),icon:"desktop"},{id:"tablet-only",label:(0,o.__)("Tablette","visi-bloc-jlg"),icon:"tablet"},{id:"mobile-only",label:(0,o.__)("Mobile","visi-bloc-jlg"),icon:"smartphone"}]},{id:"hide-on",label:(0,o.__)("Masquer sur","visi-bloc-jlg"),options:[{id:"hide-on-desktop",label:(0,o.__)("Desktop","visi-bloc-jlg"),icon:"desktop"},{id:"hide-on-tablet",label:(0,o.__)("Tablette","visi-bloc-jlg"),icon:"tablet"},{id:"hide-on-mobile",label:(0,o.__)("Mobile","visi-bloc-jlg"),icon:"smartphone"}]},{id:"orientation-show",label:(0,o.__)("Orientation ciblée","visi-bloc-jlg"),options:[{id:"portrait-only",label:(0,o.__)("Portrait","visi-bloc-jlg"),icon:ie},{id:"landscape-only",label:(0,o.__)("Paysage","visi-bloc-jlg"),icon:le}]},{id:"orientation-hide",label:(0,o.__)("Masquer en orientation","visi-bloc-jlg"),options:[{id:"hide-on-portrait",label:(0,o.__)("Portrait","visi-bloc-jlg"),icon:ie},{id:"hide-on-landscape",label:(0,o.__)("Paysage","visi-bloc-jlg"),icon:le}]}],Ne=we.reduce((e,t)=>t&&Array.isArray(t.options)?e.concat(t.options):e,[]),Be=[{label:(0,o.__)("Visible sur tous les appareils","visi-bloc-jlg"),value:Ae.id},...Ne.map(e=>({label:e.label,value:e.id}))],Te=["post_type","taxonomy","template","recurring_schedule","logged_in_status","user_role_group","user_segment","woocommerce_cart","query_param","cookie","visit_count","geolocation"],De=[{value:"post_type",label:(0,o.__)("Type de contenu","visi-bloc-jlg")},{value:"taxonomy",label:(0,o.__)("Taxonomie","visi-bloc-jlg")},{value:"template",label:(0,o.__)("Modèle de page","visi-bloc-jlg")},{value:"recurring_schedule",label:(0,o.__)("Horaire récurrent","visi-bloc-jlg")},{value:"logged_in_status",label:(0,o.__)("État de connexion","visi-bloc-jlg")},{value:"user_role_group",label:(0,o.__)("Groupe de rôles","visi-bloc-jlg")},{value:"user_segment",label:(0,o.__)("Segment marketing","visi-bloc-jlg")},{value:"woocommerce_cart",label:(0,o.__)("Panier WooCommerce","visi-bloc-jlg")},{value:"query_param",label:(0,o.__)("Paramètre d’URL","visi-bloc-jlg")},{value:"cookie",label:(0,o.__)("Cookie","visi-bloc-jlg")},{value:"visit_count",label:(0,o.__)("Compteur de visites","visi-bloc-jlg")},{value:"geolocation",label:(0,o.__)("Pays (géolocalisation)","visi-bloc-jlg")}],Re=Object.freeze({logic:"AND",rules:[],savedGroups:[]}),Me=Object.freeze({frequency:"daily",days:[],startTime:"08:00",endTime:"17:00"}),Le="site",Ie="simple",ze="expert",Oe=Ie,qe=["device","schedule","roles","fallback"],Pe=e=>"string"!=typeof e?Oe:e.trim().toLowerCase()===ze?ze:Ie,Ve=e=>{if("boolean"==typeof e)return e;if("number"==typeof e)return 0!==e;if("string"==typeof e){const t=e.trim().toLowerCase();return!!t&&(!!["1","true","yes","on","enabled","haute","actif"].includes(t)||!["0","false","no","off","disabled","inactive"].includes(t)&&"0"!==t)}return!1},Fe=e=>{if("object"!=typeof VisiBlocData||null===VisiBlocData)return[];const t=VisiBlocData[e];return Array.isArray(t)?t:[]},He=e=>{if("object"!=typeof VisiBlocData||null===VisiBlocData)return null;const t=VisiBlocData[e];return t&&"object"==typeof t?t:null},$e=e=>{if("object"!=typeof VisiBlocData||null===VisiBlocData)return"";const t=VisiBlocData[e];return"string"==typeof t?t:""},We=e=>{if("string"!=typeof e)return"";const t=e.trim();if(!t)return"";if("undefined"==typeof document)return t;const i=document.createElement("template");return i.innerHTML=t,i.content.querySelectorAll("script, iframe, frame, frameset, object, embed, link, meta, style, noscript, form, input, button, textarea, select").forEach(e=>{e.remove()}),i.content.querySelectorAll("*").forEach(e=>{Array.from(e.attributes).forEach(t=>{const i=t.name.toLowerCase();if(i.startsWith("on"))e.removeAttribute(t.name);else if(["src","href","xlink:href"].includes(i)){const i=t.value.trim().toLowerCase();(i.startsWith("javascript:")||i.startsWith("data:"))&&e.removeAttribute(t.name)}})}),i.innerHTML.trim()},Ge=e=>{if(!e||"object"!=typeof e)return null;const t="number"==typeof e.value?e.value:parseInt(e.value,10),i=Number.isNaN(t)?0:t;if(i<=0)return null;const l="string"==typeof e.label&&e.label.trim()?e.label.trim():`#${i}`;return{value:String(i),label:l}},Ue=e=>{if(!e||"object"!=typeof e)return null;const t="number"==typeof e.id?e.id:parseInt(e.id,10);if(Number.isNaN(t)||t<=0)return null;const i=e.title&&"string"==typeof e.title.rendered?(0,v.decodeEntities)(e.title.rendered).trim():"";return Ge({value:t,label:i})},Je=e=>{if("string"!=typeof e)return"";const t=e.trim();if(!t)return"";if(t.startsWith("http://")||t.startsWith("https://")){const e=t.match(/^https?:\/\/[^/]+(.*)$/);if(e&&e[1])return e[1]||"/"}return t},Qe=({value:i,onChange:r,disabled:a,endpoint:n,initialOptions:c,onOptionsLoaded:d})=>{const p=(0,t.useMemo)(()=>Array.isArray(c)?c.map(e=>Ge(e)).filter(Boolean):[],[c]),[b,m]=(0,t.useState)(p),[g,v]=(0,t.useState)(""),[f,y]=(0,t.useState)(1),[h,j]=(0,t.useState)(!1),[E,k]=(0,t.useState)(!1),[C,S]=(0,t.useState)(!1),[x,A]=(0,t.useState)(""),[w,N]=(0,t.useState)(null),[B,T]=(0,t.useState)(0);(0,t.useEffect)(()=>{m(p),"function"==typeof d&&p.length&&d(p)},[p,d]),(0,t.useEffect)(()=>{if(!n)return S(!1),void j(!1);let e=!0;const t=new AbortController;return j(!0),A(""),N(null),(async()=>{try{const i={page:f,per_page:20};g&&g.trim()&&(i.search=g.trim());const l=(0,_.addQueryArgs)(n,i),r=await u()({path:l,signal:t.signal,parse:!1}),a=await r.json();if(!r.ok){const e=new Error((a&&"string"==typeof a.message?a.message:(0,o.__)("La requête REST a échoué.","visi-bloc-jlg"))||(0,o.__)("La requête REST a échoué.","visi-bloc-jlg"));throw e.status=r.status,e.statusText=r.statusText,a&&"string"==typeof a.code&&(e.code=a.code),e.responseJson=a,e}if(!e)return;const s=(Array.isArray(a?.items)?a.items:[]).map(e=>Ge(e)||Ue(e)).filter(Boolean),c=a&&a.pagination?a.pagination:{},p=c&&void 0!==c.totalPages?parseInt(c.totalPages,10):null,b=Number.isNaN(p)?null:p;S(b?f<b:20===s.length),m(e=>{if(1===f)return s;const t=[...e];return s.forEach(e=>{const i=t.findIndex(t=>t.value===e.value);-1===i?t.push(e):t[i]=e}),t}),"function"==typeof d&&s.length&&d(s),A(""),N(null)}catch(t){if(!e||t&&"AbortError"===t.name)return;const i=t&&"object"==typeof t?t.responseJson:null,r=t&&"number"==typeof t.status?t.status:null,a=t&&"string"==typeof t.statusText?t.statusText:"",s=i&&"string"==typeof i.code?i.code:"",c=i&&"string"==typeof i.message?i.message:"",u=r?(0,o.sprintf)((0,o.__)("Erreur %s lors du chargement des blocs de repli.","visi-bloc-jlg"),r):(0,o.__)("Impossible de charger la liste des blocs de repli.","visi-bloc-jlg");A(u),N({status:r,statusText:a,code:s,message:c}),S(!1),"undefined"!=typeof console&&"function"==typeof console.error&&console.error("VisiBloc – fallback blocks request failed",t),"function"==typeof l.doAction&&(0,l.doAction)("visibloc_jlg.fallback_blocks_error",{error:t,endpoint:n,page:f,search:g,status:r,code:s})}finally{e&&j(!1)}})(),()=>{e=!1,t.abort()}},[n,f,g,d,B]),(0,t.useEffect)(()=>{if(!i)return;const e=String(i);if(b.some(t=>t.value===e))return;let t=!0;return k(!0),u()({path:(0,_.addQueryArgs)(`/wp/v2/blocks/${i}`,{context:"edit",_fields:"id,title.rendered"})}).then(e=>{if(!t)return;const i=Ue(e);i&&(m(e=>e.some(e=>e.value===i.value)?e:[...e,i]),"function"==typeof d&&d([i]))}).catch(()=>{}).finally(()=>{t&&k(!1)}),()=>{t=!1}},[i,b,d]);const D=(0,t.useCallback)(e=>{v(e||""),y(1)},[]),R=(0,t.useCallback)(e=>{if("function"!=typeof r)return;if("string"!=typeof e)return void r(void 0);const t=parseInt(e,10);Number.isNaN(t)||t<=0?r(void 0):r(t)},[r]),M=i?String(i):"",L=!(h||E||x||b.length),I=(0,t.useCallback)(()=>{A(""),N(null),y(1),T(e=>e+1)},[]),z=[];return w&&(w.status&&z.push((0,o.sprintf)((0,o.__)("Statut HTTP : %s","visi-bloc-jlg"),w.status)),w.statusText&&z.push(w.statusText),w.code&&z.push((0,o.sprintf)((0,o.__)("Code : %s","visi-bloc-jlg"),w.code))),(0,e.createElement)("div",{className:"visibloc-fallback-selector"},(0,e.createElement)(s.ComboboxControl,{label:(0,o.__)("Bloc réutilisable","visi-bloc-jlg"),value:M,options:b,onChange:R,onFilterValueChange:D,__nextHasNoMarginBottom:!0,placeholder:(0,o.__)("Rechercher un bloc réutilisable…","visi-bloc-jlg"),disabled:a}),(h||E)&&(0,e.createElement)("div",{className:"visibloc-fallback-selector__status",role:"status"},(0,e.createElement)(s.Spinner,null),(0,e.createElement)("span",null,(0,o.__)("Chargement des blocs…","visi-bloc-jlg"))),!h&&!E&&x&&(0,e.createElement)(s.Notice,{status:"error",isDismissible:!1},(0,e.createElement)("div",{className:"visibloc-fallback-selector__error"},(0,e.createElement)("p",{className:"visibloc-fallback-selector__error-summary"},x),z.length>0?(0,e.createElement)("p",{className:"visibloc-fallback-selector__error-meta"},z.join(" · ")):null,w&&w.message?(0,e.createElement)("p",{className:"visibloc-fallback-selector__error-message"},w.message):null,(0,e.createElement)("div",{className:"visibloc-fallback-selector__error-actions"},(0,e.createElement)(s.Button,{variant:"secondary",onClick:I,disabled:h||E},(0,o.__)("Réessayer","visi-bloc-jlg"))))),L&&!g.trim()&&(0,e.createElement)(s.Notice,{status:"warning",isDismissible:!1},(0,o.__)("Aucun bloc réutilisable publié n’est disponible.","visi-bloc-jlg")),L&&g.trim()&&(0,e.createElement)("p",{className:"visibloc-fallback-selector__message"},(0,o.__)("Aucun bloc ne correspond à votre recherche.","visi-bloc-jlg")),C&&!x&&n&&(0,e.createElement)("div",{className:"visibloc-fallback-selector__actions"},(0,e.createElement)(s.Button,{variant:"secondary",onClick:()=>y(e=>e+1),disabled:h||E},h?(0,o.__)("Chargement…","visi-bloc-jlg"):(0,o.__)("Charger plus de blocs","visi-bloc-jlg"))))},Ye=e=>{if(!e||"object"!=typeof e)return!1;const t=void 0===e.fallbackEnabled||Boolean(e.fallbackEnabled),i="string"==typeof e.fallbackBehavior?e.fallbackBehavior:"inherit";if(!t)return!1;if("text"===i)return("string"==typeof e.fallbackCustomText?e.fallbackCustomText:"").trim().length>0;if("block"===i)return Boolean(e.fallbackBlockId);const l=He("fallbackSettings")||{};return Boolean(l&&l.hasContent)},Xe=(()=>{const e=Fe("daysOfWeek"),t=new Map;return e.forEach(e=>{e&&"object"==typeof e&&"string"==typeof e.value&&t.set(e.value,e.label||e.value)}),t})(),Ze=()=>`rule-${Math.random().toString(36).slice(2)}-${Date.now()}`,Ke=e=>{if(!Array.isArray(e)||!e.length)return"";const t=e.find(e=>e&&void 0!==e.value);if(!t)return"";const i=void 0===t.value||null===t.value?"":t.value;return String(i)},et=e=>{if("string"!=typeof e)return"";const t=e.replace(/[^a-z0-9]/gi,"").toUpperCase();return 2===t.length?t:""},tt=({value:i,onChange:l,label:r,placeholder:a})=>{const n=(0,t.useMemo)(()=>Array.isArray(i)?i.map(e=>et(e)).filter(Boolean):[],[i]),[c,u]=(0,t.useState)(n.join(", "));(0,t.useEffect)(()=>{u(n.join(", "))},[n]);const d=(0,t.useCallback)(e=>{var t;u(e),"function"==typeof l&&l("string"!=typeof(t=e)?[]:Array.from(new Set(t.split(/[,\s]+/).map(e=>et(e)).filter(Boolean))))},[l]);return(0,e.createElement)(s.TextControl,{label:r,value:c,onChange:d,placeholder:a,help:(0,o.__)("Séparez les codes pays par des virgules ou des espaces (ex. FR, CA, US).","visi-bloc-jlg")})},it=e=>{switch(e){case"taxonomy":return(()=>{const e=Fe("taxonomies").find(e=>e&&"string"==typeof e.slug);return{id:Ze(),type:"taxonomy",operator:"in",taxonomy:e?e.slug:"",terms:[],savedGroups:[]}})();case"template":return(()=>{const e=Fe("templates");return{id:Ze(),type:"template",operator:"is",value:Ke(e)}})();case"recurring_schedule":return{id:Ze(),type:"recurring_schedule",operator:"matches",...Me};case"logged_in_status":return(()=>{const e=Fe("loginStatuses");return{id:Ze(),type:"logged_in_status",operator:"is",value:Ke(e)}})();case"user_role_group":return(()=>{const e=Fe("roleGroups");return{id:Ze(),type:"user_role_group",operator:"matches",group:Ke(e)}})();case"user_segment":return(()=>{const e=Fe("userSegments");return{id:Ze(),type:"user_segment",operator:"matches",segment:Ke(e)}})();case"woocommerce_cart":return(()=>{const e=Fe("woocommerceTaxonomies").find(e=>e&&"string"==typeof e.slug);return{id:Ze(),type:"woocommerce_cart",operator:"contains",taxonomy:e?e.slug:"",terms:[]}})();case"query_param":return(()=>{const e=Fe("commonQueryParams");return{id:Ze(),type:"query_param",operator:"equals",param:Ke(e),value:""}})();case"cookie":return(()=>{const e=Fe("commonCookies");return{id:Ze(),type:"cookie",operator:"equals",name:Ke(e),value:""}})();case"visit_count":return{id:Ze(),type:"visit_count",operator:"at_least",threshold:3};case"geolocation":return(()=>{const e=Fe("geolocationCountries").find(e=>e&&"string"==typeof e.value&&et(e.value)),t=e?et(e.value):"";return{id:Ze(),type:"geolocation",operator:"in",countries:t?[t]:[]}})();default:return(()=>{const e=Fe("postTypes");return{id:Ze(),type:"post_type",operator:"is",value:Ke(e)}})()}},lt=e=>{if(!e||"object"!=typeof e)return null;const{type:t}=e;if(!Te.includes(t))return null;const i={id:"string"==typeof e.id&&e.id?e.id:Ze(),type:t};if("post_type"===t)return i.operator="is_not"===e.operator?"is_not":"is",i.value="string"==typeof e.value?e.value:"",i;if("taxonomy"===t)return i.operator="not_in"===e.operator?"not_in":"in",i.taxonomy="string"==typeof e.taxonomy?e.taxonomy:"",i.terms=Array.isArray(e.terms)?e.terms.map(e=>"string"==typeof e||"number"==typeof e?String(e):"").filter(Boolean):[],i.savedGroups=Array.isArray(e.savedGroups)?e.savedGroups.map(e=>{if(!e||"object"!=typeof e)return null;const t=Array.isArray(e.terms)?e.terms.map(e=>"string"==typeof e||"number"==typeof e?String(e):"").filter(Boolean):[];return t.length?{id:("string"==typeof e.id?e.id.trim():"")||`group-${t.join("-")}`,label:("string"==typeof e.label?e.label.trim():"")||(0,o.__)("Sélection enregistrée","visi-bloc-jlg"),terms:t}:null}).filter(Boolean):[],i;if("template"===t)return i.operator="is_not"===e.operator?"is_not":"is",i.value="string"==typeof e.value?e.value:"",i;if("logged_in_status"===t)return i.operator="is_not"===e.operator?"is_not":"is",i.value="string"==typeof e.value?e.value:"",i;if("user_role_group"===t)return i.operator="does_not_match"===e.operator?"does_not_match":"matches",i.group="string"==typeof e.group?e.group:"",i;if("user_segment"===t)return i.operator="does_not_match"===e.operator?"does_not_match":"matches",i.segment="string"==typeof e.segment?e.segment:"",i;if("woocommerce_cart"===t)return i.operator="not_contains"===e.operator?"not_contains":"contains",i.taxonomy="string"==typeof e.taxonomy?e.taxonomy:"",i.terms=Array.isArray(e.terms)?e.terms.map(e=>"string"==typeof e||"number"==typeof e?String(e):"").filter(Boolean):[],i;if("query_param"===t){const t=["equals","not_equals","contains","not_contains","exists","not_exists"];return i.operator=t.includes(e.operator)?e.operator:"equals",i.param="string"==typeof e.param?e.param:"",i.value="string"==typeof e.value?e.value:"",i}if("cookie"===t){const t=["equals","not_equals","contains","not_contains","exists","not_exists"];return i.operator=t.includes(e.operator)?e.operator:"equals",i.name="string"==typeof e.name?e.name:"",i.value="string"==typeof e.value?e.value:"",i}if("geolocation"===t){const t="not_in"===e.operator?"not_in":"in",l=Array.isArray(e.countries)?Array.from(new Set(e.countries.map(et).filter(Boolean))):[];return i.operator=t,i.countries=l,i}if("visit_count"===t){const t=["at_least","at_most","equals","not_equals"],l=Number.parseInt(e.threshold,10),r=Number.isFinite(l)&&l>=0?l:0;return i.operator=t.includes(e.operator)?e.operator:"at_least",i.threshold=r,i}return i.operator="matches",i.frequency="weekly"===e.frequency?"weekly":"daily",i.days=Array.isArray(e.days)?e.days.map(e=>"string"==typeof e?e:"").filter(e=>Xe.has(e)):[],i.startTime="string"==typeof e.startTime?e.startTime:Me.startTime,i.endTime="string"==typeof e.endTime?e.endTime:Me.endTime,i},rt=e=>e&&"object"==typeof e?{logic:"OR"===e.logic?"OR":"AND",rules:Array.isArray(e.rules)?e.rules.map(lt).filter(Boolean):[],savedGroups:Array.isArray(e.savedGroups)?e.savedGroups.filter(e=>e&&"object"==typeof e):[]}:{logic:Re.logic,rules:[...Re.rules],savedGroups:[...Re.savedGroups]},at=({deviceVisibilitySummary:e,isSchedulingEnabled:t,scheduleSummary:i,timezoneDisplayLabel:l,rolesSummary:r,advancedRulesSummary:a})=>{const s=[];return e&&s.push((0,o.sprintf)((0,o.__)("Appareils : %s","visi-bloc-jlg"),e)),t&&(s.push((0,o.sprintf)((0,o.__)("Programmation : %s","visi-bloc-jlg"),i)),s.push((0,o.sprintf)((0,o.__)("Fuseau horaire : %s","visi-bloc-jlg"),l))),r&&s.push((0,o.sprintf)((0,o.__)("Rôles ciblés : %s","visi-bloc-jlg"),r)),a&&s.push((0,o.sprintf)((0,o.__)("Règles avancées : %s","visi-bloc-jlg"),a)),{description:s.join("\n").trim(),hasConditions:s.length>0}},st=(e,t=null)=>{const i=(e=>{if(!e||"object"!=typeof e)return"";const t="string"==typeof e.deviceVisibility?e.deviceVisibility:Ae.id;if(!t||t===Ae.id)return"";const i=we.find(e=>e&&Array.isArray(e.options)&&e.options.some(e=>e.id===t)),l=Ne.find(e=>e.id===t);return l?i?`${i.label} – ${l.label}`:l.label:""})(e),l=(e=>{const t=(0,o.sprintf)((0,o.__)("Fuseau du site (%s)","visi-bloc-jlg"),ke);if(!e||"object"!=typeof e)return{isSchedulingEnabled:!1,scheduleSummary:(0,o.__)("Aucune programmation.","visi-bloc-jlg"),timezoneDisplayLabel:t,hasScheduleRangeError:!1,hasCustomScheduleTimezone:!1};const i=Boolean(e.isSchedulingEnabled),l="string"==typeof e.publishStartDate?e.publishStartDate:"",r="string"==typeof e.publishEndDate?e.publishEndDate:"",a="string"==typeof e.publishTimezone?e.publishTimezone:"",s=Fe("timezones").map(e=>{if(!e||"object"!=typeof e)return null;const t="string"==typeof e.value?e.value.trim():"";return t?{value:t,label:"string"==typeof e.label&&e.label.trim()?e.label:t}:null}).filter(Boolean),n=[{value:Le,label:t},...s],c=n.some(e=>e.value===a)?a:Le,u=(n.find(e=>e.value===c)||{}).label||t,d=i&&c!==Le;let p=(0,o.__)("Aucune programmation.","visi-bloc-jlg");const b=xe(l),m=xe(r),g=i&&!!b&&!!m&&m.getTime()<b.getTime();if(i){const e=Ce(l),t=Ce(r);
/* translators: 1: Start date, 2: end date. */
p=e&&t?(0,o.sprintf)((0,o.__)("Du %s au %s.","visi-bloc-jlg"),e,t):e?(0,o.sprintf)((0,o.__)("À partir du %s.","visi-bloc-jlg"),e):t?(0,o.sprintf)((0,o.__)("Jusqu'au %s.","visi-bloc-jlg"),t):(0,o.__)("Activée, mais sans date définie.","visi-bloc-jlg"),g&&(p=(0,o.__)("Dates de programmation invalides.","visi-bloc-jlg"))}return{isSchedulingEnabled:i,scheduleSummary:p,timezoneDisplayLabel:u,hasScheduleRangeError:g,hasCustomScheduleTimezone:d}})(e),r=(e=>{const t=Array.isArray(e)?e.map(e=>"string"==typeof e?e:"").filter(Boolean):[],i=Array.from(new Set(t)).length;return i?{summary:(0,o.sprintf)((0,o._n)("%d rôle","%d rôles",i,"visi-bloc-jlg"),i),count:i}:{summary:"",count:0}})(e?e.visibilityRoles:[]),a=t||rt(e?e.advancedVisibility:void 0),s=(e=>{if(!e||"object"!=typeof e)return{summary:"",count:0};const t=Array.isArray(e.rules)?e.rules.length:0;if(!t)return{summary:"",count:0};const i="OR"===e.logic?(0,o.__)("OU","visi-bloc-jlg"):(0,o.__)("ET","visi-bloc-jlg");return{summary:(0,o.sprintf)((0,o._n)("%1$d règle %2$s","%1$d règles %2$s",t,"visi-bloc-jlg"),t,i),count:t}})(a),{description:n,hasConditions:c}=at({deviceVisibilitySummary:i,isSchedulingEnabled:l.isSchedulingEnabled,scheduleSummary:l.scheduleSummary,timezoneDisplayLabel:l.timezoneDisplayLabel,rolesSummary:r.summary,advancedRulesSummary:s.summary});return{deviceVisibilitySummary:i,scheduling:l,rolesSummary:r.summary,rolesCount:r.count,advancedRulesSummary:s.summary,advancedRulesCount:s.count,conditionalDescription:n,hasConditionalVisibility:c,normalizedAdvancedVisibility:a}},ot=(e,t=Date.now())=>{if(!(e instanceof Date)||Number.isNaN(e.getTime()))return"";const i=e.getTime()-t,l=Math.abs(i);if(l<ue)return i>=0?(0,o.__)("dans moins d’une heure","visi-bloc-jlg"):(0,o.__)("depuis moins d’une heure","visi-bloc-jlg");const r=Math.round(l/ue);if(r>=48){const e=Math.max(1,Math.round(r/24));return i>=0?(0,o.sprintf)((0,o._n)("dans %d jour","dans %d jours",e,"visi-bloc-jlg"),e):(0,o.sprintf)((0,o._n)("depuis %d jour","depuis %d jours",e,"visi-bloc-jlg"),e)}return i>=0?(0,o.sprintf)((0,o._n)("dans %d heure","dans %d heures",r,"visi-bloc-jlg"),r):(0,o.sprintf)((0,o._n)("depuis %d heure","depuis %d heures",r,"visi-bloc-jlg"),r)},nt=e=>{if(!e||"object"!=typeof e)return"";const t=e.isHidden?"1":"0",i=void 0===e.fallbackEnabled||Boolean(e.fallbackEnabled),l="string"==typeof e.fallbackBehavior?e.fallbackBehavior:"inherit",r=e.fallbackBlockId?String(e.fallbackBlockId):"",a="string"==typeof e.fallbackCustomText?e.fallbackCustomText.trim():"",s="string"==typeof e.deviceVisibility?e.deviceVisibility:Ae.id,o=e.isSchedulingEnabled?"1":"0",n="string"==typeof e.publishStartDate?e.publishStartDate:"",c="string"==typeof e.publishEndDate?e.publishEndDate:"",u="string"==typeof e.publishTimezone?e.publishTimezone:"",d=Array.isArray(e.visibilityRoles)?e.visibilityRoles.map(e=>"string"==typeof e?e:"").filter(Boolean).sort().join(","):"",p=rt(e.advancedVisibility),b=JSON.stringify(p.rules.map(e=>{if(!e||"object"!=typeof e)return null;const{id:t,...i}=e;return i})),m=JSON.stringify(p.savedGroups.map(e=>{if(!e||"object"!=typeof e)return null;const{id:t,...i}=e;return i}));return[t,i?"1":"0",l,r,a,s,o,n,c,u,d,p.logic||"AND",b,m].join("|")},ct=new Map,ut=new Map,dt=new Map,pt=new Set,bt=new Map,mt=new Set;let gt="",vt=null,_t=[],ft=null,yt=null,ht=null,jt=!1;const Et=(e,t)=>{const i=Array.isArray(t)?t.filter(Boolean):[];if(!i.length)return[];const l=(Array.isArray(e)?e:[]).map(e=>"string"==typeof e?e:"").filter(e=>e&&i.includes(e));return l.length?Array.from(new Set(l)):[i[0]]},kt=e=>{if("number"==typeof e)return e;if("string"==typeof e&&e){const t=parseInt(e,10);if(!Number.isNaN(t))return t}},Ct=(e,t={})=>{if(!e||"object"!=typeof e)return null;const{attributes:i={},id:l}=e,r={};if("string"==typeof l&&(r.scenarioPreset=l),"string"==typeof i.deviceVisibility&&(r.deviceVisibility=i.deviceVisibility),"boolean"==typeof i.isSchedulingEnabled)if(r.isSchedulingEnabled=i.isSchedulingEnabled,i.isSchedulingEnabled){r.publishStartDate=Se();const e=Number.isFinite(i.scheduleWindowDays)?Number(i.scheduleWindowDays):null;r.publishEndDate=Number.isFinite(e)?((e=0)=>{const t=Number.isFinite(e)?Number(e):0,i=new Date;return i.setDate(i.getDate()+t),(0,n.format)("Y-m-d\\TH:i:s",i)})(e):""}else r.publishStartDate="",r.publishEndDate="";if(i.roles){const e=Array.isArray(t.availableRoles)?t.availableRoles:[];r.visibilityRoles=Et(i.roles,e)}if(i.fallback){r.fallbackEnabled=!0;const e=i.fallback.behavior;if("text"===e)r.fallbackBehavior="text",r.fallbackCustomText=i.fallback.message||"";else if("block"===e){r.fallbackBehavior="block";const e=Array.isArray(t.fallbackBlocks)?t.fallbackBlocks:[],l=kt(i.fallback.blockId)||(()=>{const t=e.find(e=>void 0!==e.value);if(t)return kt(t.value)})();"number"==typeof l&&(r.fallbackBlockId=l)}else r.fallbackBehavior="inherit"}if(Array.isArray(i.advancedRules)&&i.advancedRules.length>0){const e=i.advancedRules.map(e=>((e,t)=>{if(!e||"object"!=typeof e)return null;const i={...e};if("taxonomy"===i.type){const e=Array.isArray(t.taxonomies)?t.taxonomies.map(e=>e&&"string"==typeof e.slug?e.slug:"").filter(Boolean):[];i.taxonomy="string"==typeof i.taxonomy&&i.taxonomy?i.taxonomy:e[0]||""}if("user_segment"===i.type){const e=Array.isArray(t.userSegments)?t.userSegments.map(e=>e&&"string"==typeof e.value?e.value:"").filter(Boolean):[],l=i.segment?[i.segment]:[],[r]=Et(l,e);i.segment=r||""}if("woocommerce_cart"===i.type){const e=Array.isArray(t.woocommerceTaxonomies)?t.woocommerceTaxonomies.map(e=>e&&"string"==typeof e.slug?e.slug:"").filter(Boolean):[];i.taxonomy="string"==typeof i.taxonomy&&i.taxonomy?i.taxonomy:e[0]||""}return i.id||(i.id=Ze()),lt(i)})(e,t)).filter(Boolean);e.length>0&&(r.advancedVisibility=rt({logic:"OR"===i.advancedLogic?"OR":"AND",rules:e}))}return r},St=({rule:i,taxonomies:l,onUpdateRule:r,commonHeader:a})=>{const n=(0,t.useMemo)(()=>Array.isArray(l)?l:[],[l]),c=(0,t.useMemo)(()=>n.find(e=>e&&e.slug===i.taxonomy)||null,[n,i.taxonomy]),d=(0,t.useMemo)(()=>c&&Array.isArray(c.terms)?c.terms.map(e=>e&&"object"==typeof e?{value:"string"==typeof e.value?e.value:String(e.value||""),label:"string"==typeof e.label?e.label:String(e.value||"")}:null).filter(e=>e&&e.value):[],[c]),[p,b]=(0,t.useState)(""),[m,g]=(0,t.useState)(d),[v,_]=(0,t.useState)(!1),[f,y]=(0,t.useState)(""),h=(0,t.useRef)(null),j=(0,t.useRef)(new Map);(0,t.useEffect)(()=>{g(d),b(""),y("")},[d,i.taxonomy]),(0,t.useEffect)(()=>{const e=j.current;d.forEach(t=>{e.set(t.value,t.label)})},[d]),(0,t.useEffect)(()=>{const e=j.current;m.forEach(t=>{e.set(t.value,t.label)})},[m]),(0,t.useEffect)(()=>{if(!p)return h.current&&(h.current.abort(),h.current=null),_(!1),y(""),void g(d);const e=((e,t)=>{const i=("string"==typeof e?e:"wp/v2").replace(/^\/+/,"").replace(/\/+$/,""),l=("string"==typeof t?t:"").replace(/^\/+/,"").replace(/\/+$/,"");return l?`/${i}/${l}`:`/${i}`})(c?c.rest_namespace:"wp/v2",c?c.rest_base:i.taxonomy),t=new AbortController;return h.current=t,_(!0),y(""),u()({path:`${e}?per_page=20&search=${encodeURIComponent(p)}`,signal:t.signal}).then(e=>{if(t.signal.aborted)return;const i=Array.isArray(e)?e.map(e=>{if(!e||"object"!=typeof e)return null;const t="string"==typeof e.slug&&e.slug?e.slug:void 0!==e.id?String(e.id):"",i="string"==typeof e.name&&e.name?e.name:t;return t?{value:t,label:i}:null}).filter(Boolean):[];g(i.length?i:d)}).catch(e=>{t.signal.aborted||e&&"AbortError"===e.name||y((0,o.__)("Impossible de charger les termes. Réessayez plus tard.","visi-bloc-jlg"))}).finally(()=>{t.signal.aborted||_(!1)}),()=>{t.abort()}},[p,c,d,i.taxonomy]);const E=(0,t.useMemo)(()=>n.map(e=>({value:e.slug,label:e.label})),[n]),k=(0,t.useCallback)(e=>{const t=j.current;return t.has(e)?t.get(e):e},[]),C=(0,t.useCallback)(e=>{if(!e)return;const t=String(e);i.terms.includes(t)||r({terms:[...i.terms,t]})},[r,i.terms]),S=(0,t.useCallback)(e=>{r({terms:i.terms.filter(t=>t!==e)})},[r,i.terms]),x=(0,t.useCallback)(e=>{const t="string"==typeof e?e.trim():"";if(!i.terms.length)return;const l={id:`group-${Ze()}`,label:t||(0,o.sprintf)((0,o.__)("Groupe %d","visi-bloc-jlg"),(i.savedGroups||[]).length+1),terms:[...i.terms]},a=Array.isArray(i.savedGroups)?i.savedGroups:[];r({savedGroups:[...a,l]})},[r,i.savedGroups,i.terms]),A=(0,t.useCallback)(e=>{e&&Array.isArray(e.terms)&&r({terms:e.terms.filter(Boolean)})},[r]),w=(0,t.useCallback)(e=>{const t=Array.isArray(i.savedGroups)?i.savedGroups:[];r({savedGroups:t.filter(t=>t&&t.id!==e)})},[r,i.savedGroups]),[N,B]=(0,t.useState)(!1),[T,D]=(0,t.useState)("");(0,t.useEffect)(()=>{N||D("")},[N]);const R=(0,t.useMemo)(()=>{const e=i.terms.length;return 0===e?(0,o.__)("Aucun terme sélectionné.","visi-bloc-jlg"):(0,o._n)("%d terme sélectionné.","%d termes sélectionnés.",e,"visi-bloc-jlg")},[i.terms.length]);return(0,e.createElement)("div",{className:"visibloc-advanced-rule"},a,(0,e.createElement)(s.SelectControl,{label:(0,o.__)("Taxonomie","visi-bloc-jlg"),value:i.taxonomy,options:E,onChange:e=>r({taxonomy:e,terms:[],savedGroups:[]})}),(0,e.createElement)(s.SelectControl,{label:(0,o.__)("Condition","visi-bloc-jlg"),value:i.operator,options:[{value:"in",label:(0,o.__)("Inclut au moins un terme","visi-bloc-jlg")},{value:"not_in",label:(0,o.__)("Exclut tous les termes","visi-bloc-jlg")}],onChange:e=>r({operator:e})}),(0,e.createElement)(s.ComboboxControl,{__nextHasNoMarginBottom:!0,label:(0,o.__)("Ajouter un terme","visi-bloc-jlg"),value:"",options:m,onChange:e=>{C(e)},onFilterValueChange:e=>b(e),allowReset:!1,placeholder:(0,o.__)("Rechercher…","visi-bloc-jlg")}),v?(0,e.createElement)("div",{className:"visibloc-term-search-status"},(0,e.createElement)(s.Spinner,null),(0,e.createElement)("span",null,(0,o.__)("Recherche des termes…","visi-bloc-jlg"))):null,f?(0,e.createElement)(s.Notice,{status:"error",isDismissible:!1},f):null,(0,e.createElement)("div",{className:"visibloc-term-selection"},(0,e.createElement)("p",{className:"visibloc-term-selection__count"},(0,o.sprintf)(R,i.terms.length)),(0,e.createElement)("div",{className:"visibloc-term-chips",role:"list"},i.terms.map(t=>(0,e.createElement)("span",{key:t,role:"listitem",className:"visibloc-term-chip"},(0,e.createElement)("span",{className:"visibloc-term-chip__label"},k(t)),(0,e.createElement)(s.Button,{onClick:()=>S(t),icon:"no-alt",label:(0,o.__)("Retirer ce terme","visi-bloc-jlg"),variant:"tertiary",size:"small"}))),0===i.terms.length&&(0,e.createElement)("span",{className:"visibloc-term-chip visibloc-term-chip--placeholder"},(0,o.__)("Aucun terme encore ajouté.","visi-bloc-jlg")))),(0,e.createElement)("div",{className:"visibloc-term-groups"},i.terms.length>0?(0,e.createElement)("div",{className:"visibloc-term-groups__actions"},N?(0,e.createElement)(s.Flex,{align:"center",gap:8,justify:"flex-start"},(0,e.createElement)(s.FlexBlock,null,(0,e.createElement)(s.TextControl,{label:(0,o.__)("Nom du groupe","visi-bloc-jlg"),value:T,onChange:D,placeholder:(0,o.__)("Audience prioritaire","visi-bloc-jlg")})),(0,e.createElement)(s.FlexItem,null,(0,e.createElement)(s.Button,{variant:"primary",onClick:()=>{x(T),B(!1)}},(0,o.__)("Enregistrer","visi-bloc-jlg"))),(0,e.createElement)(s.FlexItem,null,(0,e.createElement)(s.Button,{variant:"tertiary",onClick:()=>B(!1)},(0,o.__)("Annuler","visi-bloc-jlg")))):(0,e.createElement)(s.Button,{variant:"tertiary",onClick:()=>B(!0)},(0,o.__)("Enregistrer cette sélection","visi-bloc-jlg"))):null,Array.isArray(i.savedGroups)&&i.savedGroups.length>0?(0,e.createElement)("div",{className:"visibloc-term-groups__list"},(0,e.createElement)("p",{className:"visibloc-term-groups__title"},(0,o.__)("Groupes enregistrés","visi-bloc-jlg")),i.savedGroups.map(t=>(0,e.createElement)("div",{key:t.id,className:"visibloc-term-group"},(0,e.createElement)(s.Button,{variant:"secondary",onClick:()=>A(t),className:"visibloc-term-group__apply"},(0,e.createElement)("span",{className:"visibloc-term-group__label"},t.label),(0,e.createElement)("span",{className:"visibloc-term-group__count"},t.terms.length)),(0,e.createElement)(s.Button,{icon:"trash",label:(0,o.__)("Supprimer ce groupe","visi-bloc-jlg"),onClick:()=>w(t.id),variant:"tertiary"})))):null))},xt=(0,r.createHigherOrderComponent)(i=>l=>{if(!ve(l.name))return(0,e.createElement)(i,{...l});const{attributes:n,setAttributes:c,isSelected:p,clientId:m}=l,{isHidden:g,deviceVisibility:v,isSchedulingEnabled:_,publishStartDate:f,publishEndDate:y,publishTimezone:h=Le,visibilityRoles:j,advancedVisibility:E,fallbackEnabled:k=!0,fallbackBehavior:C="inherit",fallbackCustomText:S="",fallbackBlockId:x,scenarioPreset:A=""}=n,w=rt(E),N="string"==typeof v&&v!==Ae.id,B=(0,t.useMemo)(()=>He("fallbackSettings")||{},[]),T=(0,t.useMemo)(()=>Fe("fallbackBlocks").map(e=>Ge(e)).filter(Boolean),[]),D=(0,t.useMemo)(()=>Je($e("fallbackBlocksEndpoint")),[]),R=(0,t.useRef)(new Map),[M,L]=(0,t.useState)(0),I=(0,t.useCallback)(e=>{if(!Array.isArray(e)||!e.length)return;const t=R.current;let i=!1;e.forEach(e=>{if(!e||"object"!=typeof e)return;const l="string"==typeof e.value?e.value:String(e.value||"");if(!l)return;const r="string"==typeof e.label?e.label:"";t.has(l)&&t.get(l)===r||(t.set(l,r),i=!0)}),i&&L(e=>e+1)},[]);(0,t.useEffect)(()=>{T.length&&I(T)},[T,I]);const z=(0,t.useMemo)(()=>He("roles")||{},[]),O=(0,t.useMemo)(()=>Object.keys(z),[z]),q=(0,t.useMemo)(()=>Fe("guidedRecipes"),[]),P=(0,t.useMemo)(()=>Fe("userSegments"),[]),V=(0,t.useMemo)(()=>Fe("woocommerceTaxonomies"),[]),F=(0,t.useMemo)(()=>Fe("taxonomies"),[]),H=(0,t.useMemo)(()=>Fe("geolocationCountries"),[]),$=(0,t.useMemo)(()=>({availableRoles:O,fallbackBlocks:T,fallbackSettings:B,userSegments:P,woocommerceTaxonomies:V,taxonomies:F,geolocationCountries:H}),[O,T,B,P,V,F,H]),G=(0,t.useMemo)(()=>{return e=q,t=$,Array.isArray(e)?e.map(e=>{if(!e||"object"!=typeof e)return null;const i=Ct(e,t);return i?{id:e.id,label:e.title||e.id,description:e.description||"",severity:e.severity||"medium",attributes:i}:null}).filter(Boolean):[];var e,t},[q,$]),U=(0,t.useMemo)(()=>He("editorPreferences")||{},[]),J=(0,t.useMemo)(()=>Je($e("editorPreferencesEndpoint")),[]),Q=(0,t.useMemo)(()=>Pe(U?U.mode:void 0),[U]),Y=(0,t.useMemo)(()=>Ve(!!U&&U.highVisibility),[U]),[Z,ie]=(0,t.useState)(Q),[le,se]=(0,t.useState)(Y),[oe,ue]=(0,t.useState)(!1),[de,pe]=(0,t.useState)(""),[be,me]=(0,t.useState)(""),ge=(0,r.useInstanceId)(xt,"visibloc-editor-mode-status"),_e=(0,r.useInstanceId)(xt,"visibloc-editor-mode"),[fe,ye]=(0,t.useState)(!1),[he,je]=(0,t.useState)("device"),[Re,Me]=(0,t.useState)(!1),[Ue,Ze]=(0,t.useState)(""),Ke=(0,t.useRef)({level:"",score:0}),st=(0,t.useMemo)(()=>({critical:(0,o.__)("Critique","visi-bloc-jlg"),high:(0,o.__)("Prioritaire","visi-bloc-jlg"),medium:(0,o.__)("Standard","visi-bloc-jlg"),low:(0,o.__)("Suggestion","visi-bloc-jlg")}),[]),bt=(0,t.useMemo)(()=>({good:(0,o.__)("niveau optimal","visi-bloc-jlg"),warning:(0,o.__)("niveau à surveiller","visi-bloc-jlg"),critical:(0,o.__)("niveau critique","visi-bloc-jlg")}),[]),gt=Z!==ze,vt=gt?(0,o.__)("Le mode Simple affiche les étapes essentielles : appareils, calendrier, rôles et repli.","visi-bloc-jlg"):(0,o.__)("Le mode Expert ajoute les règles avancées et les diagnostics détaillés.","visi-bloc-jlg"),_t=(0,o.__)("Renforce le contraste, réduit les animations et agrandit les contrôles clés de Visibloc.","visi-bloc-jlg"),ft=(0,t.useCallback)((e,t,{onError:i}={})=>{if(!J)return;const l={mode:Pe(e),highVisibility:Ve(t)};ue(!0),u()({path:J,method:"POST",data:l}).then(()=>{me((0,o.__)("Préférence enregistrée.","visi-bloc-jlg"))}).catch(()=>{"function"==typeof i&&i(),pe((0,o.__)("Impossible d’enregistrer la préférence. Réessayez.","visi-bloc-jlg"))}).finally(()=>{ue(!1)})},[J]),yt=(0,t.useCallback)(e=>{const t=Pe(e);if(t===Z)return;const i=Z;ie(t),pe(""),me(""),J&&ft(t,le,{onError:()=>ie(i)})},[Z,J,le,ft]),ht=(0,t.useCallback)(e=>{const t=Ve(e);if(t===le)return;const i=le;se(t),pe(""),me(""),J&&ft(Z,t,{onError:()=>se(i)})},[Z,J,le,ft]);(0,t.useEffect)(()=>{if(!be)return;const e=setTimeout(()=>me(""),4e3);return()=>clearTimeout(e)},[be]),(0,t.useEffect)(()=>{if("undefined"!=typeof window&&window.localStorage)try{window.localStorage.setItem("visiblocHighVisibility",le?"1":"0")}catch(e){}if("undefined"!=typeof document&&document.body)return document.body.classList.toggle("visibloc-high-visibility",Boolean(le)),()=>{document.body.classList.remove("visibloc-high-visibility")}},[le]);const jt=(0,t.useMemo)(()=>{if(!x)return"";const e=String(x),t=R.current.get(e);return t&&t.trim()?t.trim():`#${x}`},[x,M]),Et=(0,t.useCallback)(e=>["critical","high","medium","low"].includes(e)?e:"medium",[]),kt=(0,t.useCallback)(e=>{e&&e.attributes&&(c(e.attributes),e.attributes.isSchedulingEnabled?je("schedule"):e.attributes.fallbackEnabled&&e.attributes.fallbackBehavior&&"inherit"!==e.attributes.fallbackBehavior?je("fallback"):e.attributes.advancedVisibility&&Array.isArray(e.attributes.advancedVisibility.rules)&&e.attributes.advancedVisibility.rules.length>0?je("advanced"):Array.isArray(e.attributes.visibilityRoles)&&e.attributes.visibilityRoles.length>0?je("roles"):je("device"))},[c,je]),At=(0,t.useCallback)(e=>{const t=Ct(e,$);t&&(c(t),t.isSchedulingEnabled?je("schedule"):t.advancedVisibility&&Array.isArray(t.advancedVisibility.rules)&&t.advancedVisibility.rules.length>0?je("advanced"):Array.isArray(t.visibilityRoles)&&t.visibilityRoles.length>0?je("roles"):t.fallbackEnabled&&t.fallbackBehavior&&"inherit"!==t.fallbackBehavior?je("fallback"):je("device"),Me(!1))},[$,c,je]),wt=Ye(n),Nt=Boolean(B&&B.hasContent),Bt=B&&"string"==typeof B.summary?B.summary:"",Dt=B&&"string"==typeof B.previewHtml?B.previewHtml:"",Rt=[{value:"inherit",label:(0,o.__)("Utiliser le repli global","visi-bloc-jlg")},{value:"text",label:(0,o.__)("Texte personnalisé","visi-bloc-jlg")},{value:"block",label:(0,o.__)("Bloc réutilisable","visi-bloc-jlg")}],Lt=(0,t.useMemo)(()=>We(Dt),[Dt]),It=(0,t.useMemo)(()=>"text"===C?(e=>{if("string"!=typeof e)return"";const t=e.trim();if(!t)return"";let i=t;return"function"==typeof b()&&(i=b()(t)),We(i)})(S):"",[C,S]),zt=(0,t.useMemo)(()=>nt(n),[n]);(0,t.useEffect)(()=>{!function(e){e&&(mt.add(e),Mt())}(m)},[m,zt]);const{blockPreviewHtml:Ot,isBlockPreviewResolving:qt}=(0,d.useSelect)(e=>{if("block"!==C||!x)return{blockPreviewHtml:"",isBlockPreviewResolving:!1};const t=e("core"),i=e("core/data"),l=t?t.getEntityRecord("postType","wp_block",x):void 0,r=!!i&&i.isResolving("core","getEntityRecord",["postType","wp_block",x]);return{blockPreviewHtml:l&&l.content&&"string"==typeof l.content.rendered?l.content.rendered:"",isBlockPreviewResolving:r||void 0===l}},[C,x]),Pt=(0,t.useMemo)(()=>"block"===C?We(Ot):"",[C,Ot]),Vt=(0,t.useMemo)(()=>k?"text"===C?"string"==typeof S&&S.trim()?It?{status:"ready",message:"",html:It}:{status:"warning",message:(0,o.__)("Prévisualisation indisponible pour ce texte.","visi-bloc-jlg"),html:""}:{status:"warning",message:(0,o.__)("Aucun texte de repli défini.","visi-bloc-jlg"),html:""}:"block"===C?x?qt?{status:"info",message:(0,o.__)("Chargement de l’aperçu du bloc de repli…","visi-bloc-jlg"),html:""}:Pt?{status:"ready",message:"",html:Pt}:{status:"warning",message:(0,o.__)("Impossible d’afficher l’aperçu du bloc sélectionné.","visi-bloc-jlg"),html:""}:{status:"warning",message:(0,o.__)("Aucun bloc réutilisable sélectionné.","visi-bloc-jlg"),html:""}:Nt?Lt?{status:"ready",message:"",html:Lt}:{status:"warning",message:(0,o.__)("Aucun aperçu disponible pour le repli global.","visi-bloc-jlg"),html:""}:{status:"warning",message:(0,o.__)("Aucun repli global n’est configuré.","visi-bloc-jlg"),html:""}:{status:"info",message:(0,o.__)("Le repli est désactivé pour ce bloc.","visi-bloc-jlg"),html:""},[k,C,S,It,x,qt,Pt,Nt,Lt]),Ft=Vt.html,Ht=Vt.status,$t=Vt.message,Wt=(0,t.useRef)(null),Gt=(0,r.useInstanceId)(xt,"visibloc-fallback-preview"),Ut=`${Gt}__label`;(0,t.useEffect)(()=>{fe&&k&&Wt.current&&Wt.current.focus({preventScroll:!0})},[fe,k,Ft,Ht]),(0,t.useEffect)(()=>()=>{m&&(ct.delete(m),ut.delete(m),dt.delete(m),pt.delete(m))},[m]);const Jt=e=>{const t=rt({...w}),i=e(t)||t;c({advancedVisibility:rt(i)})},Qt=(e,t)=>{const i=e?[...j,t]:j.filter(e=>e!==t);c({visibilityRoles:i})},Yt=(0,t.useMemo)(()=>Fe("timezones"),[]),Xt=(0,t.useMemo)(()=>Yt.map(e=>{if(!e||"object"!=typeof e)return null;const t="string"==typeof e.value?e.value.trim():"";return t?{value:t,label:"string"==typeof e.label&&e.label.trim()?e.label:t}:null}).filter(Boolean),[Yt]),Zt=(0,t.useMemo)(()=>(0,o.sprintf)((0,o.__)("Fuseau du site (%s)","visi-bloc-jlg"),ke),[]),Kt=(0,t.useMemo)(()=>[{value:Le,label:Zt},...Xt],[Zt,Xt]),ei=(0,t.useMemo)(()=>Kt.some(e=>e.value===h)?h:Le,[h,Kt]),ti=(0,t.useMemo)(()=>{const e=Kt.find(e=>e.value===ei);return e?e.label:Zt},[ei,Kt,Zt]),ii=ei!==Le,li=(0,t.useMemo)(()=>(0,o.sprintf)((0,o.__)("Fuseau horaire : %s","visi-bloc-jlg"),ti),[ti]);let ri=(0,o.__)("Aucune programmation.","visi-bloc-jlg");const ai=xe(f),si=xe(y),oi=_&&!!ai&&!!si&&si.getTime()<ai.getTime();if(_){const e=Ce(f),t=Ce(y);
/* translators: 1: Start date, 2: end date. */
ri=e&&t?(0,o.sprintf)((0,o.__)("Du %s au %s.","visi-bloc-jlg"),e,t):e?(0,o.sprintf)((0,o.__)("À partir du %s.","visi-bloc-jlg"),e):t?(0,o.sprintf)((0,o.__)("Jusqu'au %s.","visi-bloc-jlg"),t):(0,o.__)("Activée, mais sans date définie.","visi-bloc-jlg"),oi&&(ri=(0,o.__)("Dates de programmation invalides.","visi-bloc-jlg"))}const ni=(0,o.__)("Inactif","visi-bloc-jlg"),ci=(t,i="")=>{if(!t)return null;const l=["visi-bloc-help-text"];return i&&l.push(i),(0,e.createElement)("p",{className:l.join(" ")},t)},ui=(()=>{if(!v||v===Ae.id)return"";const e=we.find(e=>!!Array.isArray(e.options)&&e.options.some(e=>e.id===v)),t=Ne.find(e=>e.id===v);return t?e?`${e.label} – ${t.label}`:t.label:""})(),di=(()=>{if(!_)return"";if(oi)return(0,o.__)("Erreur de dates","visi-bloc-jlg");let e;return e=f&&y?(0,o.__)("Plage définie","visi-bloc-jlg"):f||y?(0,o.__)("Date définie","visi-bloc-jlg"):(0,o.__)("Programmation active","visi-bloc-jlg"),ii?`${e} – ${ti}`:e})(),pi=(()=>{const e=Array.from(new Set((j||[]).filter(Boolean))).length;return e?{summary:(0,o.sprintf)((0,o._n)("%d rôle","%d rôles",e,"visi-bloc-jlg"),e),count:e}:{summary:"",count:e}})(),bi=pi.summary,mi=pi.count,gi=(()=>{const e=Array.isArray(w.rules)?w.rules.length:0;if(!e)return"";const t="OR"===w.logic?(0,o.__)("OU","visi-bloc-jlg"):(0,o.__)("ET","visi-bloc-jlg");return(0,o.sprintf)((0,o._n)("%1$d règle %2$s","%1$d règles %2$s",e,"visi-bloc-jlg"),e,t)})(),vi=(()=>{if(!k)return"";if("block"===C)return x?jt||(0,o.sprintf)((0,o.__)("Bloc #%d","visi-bloc-jlg"),x):(0,o.__)("Bloc","visi-bloc-jlg");const e={inherit:(0,o.__)("Global","visi-bloc-jlg"),text:(0,o.__)("Texte","visi-bloc-jlg")};return e[C]||e.inherit})(),{description:_i,hasConditions:fi}=at({deviceVisibilitySummary:ui,isSchedulingEnabled:_,scheduleSummary:ri,timezoneDisplayLabel:ti,rolesSummary:bi,advancedRulesSummary:gi}),yi=[];g&&yi.push((0,o.__)("Bloc masqué manuellement.","visi-bloc-jlg")),_i&&yi.push(..._i.split("\n"));const hi=[];if(wt)if(vi&&hi.push((0,o.sprintf)((0,o.__)("Type : %s","visi-bloc-jlg"),vi)),"inherit"===C)Bt?hi.push((0,o.sprintf)((0,o.__)("Repli global : %s","visi-bloc-jlg"),Bt)):Nt?hi.push((0,o.__)("Utilise le contenu de repli global.","visi-bloc-jlg")):hi.push((0,o.__)("Aucun repli global défini.","visi-bloc-jlg"));else if("text"===C){const e="string"==typeof S?S.trim():"";e&&hi.push(e)}else"block"===C&&x&&(jt?hi.push((0,o.sprintf)((0,o.__)("Bloc : %s","visi-bloc-jlg"),jt)):hi.push((0,o.sprintf)((0,o.__)("Bloc #%d","visi-bloc-jlg"),x)));if(m){const e=yi.join("\n").trim(),t=hi.join("\n").trim(),i=ct.get(m)||{},l={...i,isHidden:Boolean(g),hasFallback:wt,isConditionallyHidden:fi&&!g,conditionalDescription:_i,hiddenDescription:e,fallbackDescription:t};ct.set(m,l),i.isHidden===l.isHidden&&i.hasFallback===l.hasFallback&&i.isConditionallyHidden===l.isConditionallyHidden&&i.hiddenDescription===l.hiddenDescription&&i.conditionalDescription===l.conditionalDescription&&i.fallbackDescription===l.fallbackDescription||Tt(m,l)}const ji=Array.isArray(w.rules)?w.rules:[],Ei=ji.length>0,ki=!!Ei&&ji.some(e=>!(!e||"object"!=typeof e||("taxonomy"===e.type||"woocommerce_cart"===e.type?Array.isArray(e.terms)&&0!==e.terms.length:"user_segment"!==e.type||e.segment))),Ci=!!k&&("text"===C&&!S.trim()||"block"===C&&!x||"inherit"===C&&!Nt),Si=gt&&Ei,xi=ki?"warning":"info",Ai=(0,t.useMemo)(()=>(e=>{const t={level:"good",score:100,headline:(0,o.__)("Parcours de visibilité prêt","visi-bloc-jlg"),summary:(0,o.__)("Les réglages respectent les standards UI/UX des solutions professionnelles.","visi-bloc-jlg"),subline:(0,o.sprintf)((0,o.__)("Score de fiabilité : %d/100.","visi-bloc-jlg"),100),notices:[]};if(!e||"object"!=typeof e)return t;const i={info:6,warning:18,critical:35},l={success:0,info:1,warning:2,critical:3};let r=100,a=0;const s=[],n=[],c=(e,t,i)=>{if(!e||"object"!=typeof e)return;const{label:l}=e;if(!l)return;const r={id:e.id||i,label:l,description:e.description||"",type:e.type||"step",targetStep:e.targetStep||"",command:e.command||"",severity:e.severity||t};r.id||(r.id=`${i}-action`),n.some(e=>e.id===r.id)||n.push(r)},u=({id:e,label:t,description:o="",variant:n="default",severity:u="info",action:d=null})=>{if(!t)return;const p=l.hasOwnProperty(u)?u:"info",b=l[p]||0;r-=i[p]||0,a=Math.max(a,b),s.push({id:e||`notice-${s.length+1}`,label:t,description:o,variant:n,severity:p,screenReaderText:ne[p]||""}),d&&c(d,p,e||`notice-${s.length}`)};e.isHidden?u({id:"manual-hidden",label:(0,o.__)("Masquage manuel actif","visi-bloc-jlg"),description:(0,o.__)("Ce bloc restera invisible sur le front tant que le masquage manuel sera activé.","visi-bloc-jlg"),variant:"hidden",severity:"info",action:{id:"action-reveal-block",type:"command",command:"reveal-block",label:(0,o.__)("Afficher ce bloc","visi-bloc-jlg"),description:(0,o.__)("Désactivez le masquage manuel pour rendre le contenu immédiatement visible.","visi-bloc-jlg")}}):e.hasConditionalVisibility&&(u({id:"conditional-filtering",label:(0,o.__)("Règles conditionnelles actives","visi-bloc-jlg"),description:e.conditionalDescription||(0,o.__)("Plusieurs conditions filtrent l’affichage. Vérifiez les chevauchements éventuels.","visi-bloc-jlg"),variant:"conditional",severity:"info"}),e.hasDeviceRestrictions&&c({id:"action-review-device-visibility",type:"step",targetStep:"device",label:(0,o.__)("Ajuster les appareils ciblés","visi-bloc-jlg"),description:(0,o.__)("Ouvrez l’onglet Appareils pour confirmer les restrictions par type d’appareil.","visi-bloc-jlg")},"info","conditional-filtering"),e.scheduling&&e.scheduling.isSchedulingEnabled&&c({id:"action-review-schedule-basics",type:"step",targetStep:"schedule",label:(0,o.__)("Vérifier le calendrier","visi-bloc-jlg"),description:(0,o.__)("Rejoignez l’onglet Calendrier pour ajuster la fenêtre de diffusion.","visi-bloc-jlg")},"info","conditional-filtering"),e.rolesCount>0&&c({id:"action-review-roles-targeting",type:"step",targetStep:"roles",label:(0,o.__)("Examiner les rôles ciblés","visi-bloc-jlg"),description:(0,o.__)("Accédez à l’onglet Rôles pour valider l’audience sélectionnée.","visi-bloc-jlg")},"info","conditional-filtering"),e.hasAdvancedRules&&c({id:"action-review-advanced-filtering",type:"step",targetStep:"advanced",label:(0,o.__)("Réviser les règles avancées","visi-bloc-jlg"),description:(0,o.__)("Ouvrez l’onglet Règles avancées pour inspecter les conditions appliquées.","visi-bloc-jlg")},"info","conditional-filtering"));const d=e.scheduling||{};let p=!1;const b=e=>{e&&("success"!==e.severity&&(p=!0),u(e))};if(d.isSchedulingEnabled){d.hasScheduleRangeError&&b({id:"schedule-invalid",label:(0,o.__)("Programmation incohérente","visi-bloc-jlg"),description:(0,o.__)("La date de fin doit être postérieure à la date de début pour éviter une coupure prématurée.","visi-bloc-jlg"),variant:"critical",severity:"critical",action:{id:"action-fix-schedule-range",type:"step",targetStep:"schedule",label:(0,o.__)("Corriger les dates de programmation","visi-bloc-jlg"),description:(0,o.__)("Ajustez les dates de début et de fin dans l’onglet Calendrier.","visi-bloc-jlg")}});const e=Date.now(),t=xe(d.publishStartDate),i=xe(d.publishEndDate);if(i&&i.getTime()<e)b({id:"schedule-expired",label:(0,o.__)("Programmation expirée","visi-bloc-jlg"),description:(0,o.sprintf)((0,o.__)("Le bloc est masqué depuis %s.","visi-bloc-jlg"),ot(i,e)),variant:"critical",severity:"critical",action:{id:"action-refresh-schedule",type:"step",targetStep:"schedule",label:(0,o.__)("Mettre à jour le calendrier","visi-bloc-jlg"),description:(0,o.__)("Définissez une nouvelle période de diffusion pour réactiver le bloc.","visi-bloc-jlg")}});else if(i){const t=i.getTime()-e;t<=432e5?b({id:"schedule-end-critical",label:(0,o.__)("Expiration imminente","visi-bloc-jlg"),description:(0,o.sprintf)((0,o.__)("Le bloc sera masqué %s.","visi-bloc-jlg"),ot(i,e)),variant:"schedule",severity:"critical",action:{id:"action-prepare-expiration",type:"step",targetStep:"schedule",label:(0,o.__)("Planifier la suite","visi-bloc-jlg"),description:(0,o.__)("Confirmez ou modifiez la date de fin pour éviter une coupure inattendue.","visi-bloc-jlg")}}):t<=1728e5&&b({id:"schedule-end-warning",label:(0,o.__)("Expiration prochaine","visi-bloc-jlg"),description:(0,o.sprintf)((0,o.__)("Préparez une alternative : expiration %s.","visi-bloc-jlg"),ot(i,e)),variant:"schedule",severity:"warning",action:{id:"action-review-schedule-end",type:"step",targetStep:"schedule",label:(0,o.__)("Réviser la date de fin","visi-bloc-jlg"),description:(0,o.__)("Vérifiez si le bloc doit rester actif plus longtemps.","visi-bloc-jlg")}})}if(t&&t.getTime()>e){const i=t.getTime()-e;i<=432e5?b({id:"schedule-start-critical",label:(0,o.__)("Activation imminente","visi-bloc-jlg"),description:(0,o.sprintf)((0,o.__)("Le bloc deviendra visible %s.","visi-bloc-jlg"),ot(t,e)),variant:"schedule",severity:"warning",action:{id:"action-confirm-start-date",type:"step",targetStep:"schedule",label:(0,o.__)("Confirmer la date de publication","visi-bloc-jlg"),description:(0,o.__)("Vérifiez que la date d’activation correspond bien à votre campagne.","visi-bloc-jlg")}}):i<=1728e5&&b({id:"schedule-start-warning",label:(0,o.__)("Activation programmée","visi-bloc-jlg"),description:(0,o.sprintf)((0,o.__)("Le bloc sera publié %s.","visi-bloc-jlg"),ot(t,e)),variant:"schedule",severity:"info",action:{id:"action-review-start-window",type:"step",targetStep:"schedule",label:(0,o.__)("Vérifier la date de début","visi-bloc-jlg"),description:(0,o.__)("Assurez-vous que la fenêtre d’activation est alignée avec vos objectifs.","visi-bloc-jlg")}})}t||i||b({id:"schedule-open",label:(0,o.__)("Programmation sans date","visi-bloc-jlg"),description:(0,o.__)("Aucune date n’est définie malgré la programmation activée. Les solutions pro recommandent une fenêtre claire.","visi-bloc-jlg"),variant:"schedule",severity:"info",action:{id:"action-define-schedule-window",type:"step",targetStep:"schedule",label:(0,o.__)("Définir une fenêtre de diffusion","visi-bloc-jlg"),description:(0,o.__)("Ajoutez une date de début ou de fin pour clarifier l’affichage.","visi-bloc-jlg")}}),p||b({id:"schedule-ready",label:(0,o.__)("Programmation opérationnelle","visi-bloc-jlg"),description:d.scheduleSummary||(0,o.__)("La fenêtre de publication est cohérente et conforme aux pratiques professionnelles.","visi-bloc-jlg"),variant:"schedule",severity:"success"})}const m=e.fallbackBehavior||"inherit",g="string"==typeof e.fallbackCustomText?e.fallbackCustomText.trim():"";e.fallbackEnabled?"text"!==m||g?"block"!==m||e.fallbackBlockId?"inherit"!==m||e.hasGlobalFallback?u({id:"fallback-ready",label:(0,o.__)("Repli opérationnel","visi-bloc-jlg"),description:e.fallbackSummary||(0,o.__)("Un contenu alternatif sera affiché en cas d’exclusion, comme dans les extensions professionnelles.","visi-bloc-jlg"),variant:"fallback",severity:"success"}):u({id:"fallback-global-missing",label:(0,o.__)("Repli global manquant","visi-bloc-jlg"),description:(0,o.__)("Définissez un repli global dans les options pour éviter une impasse de contenu.","visi-bloc-jlg"),variant:"warning",severity:"warning",action:{id:"action-open-global-fallback-settings",type:"step",targetStep:"fallback",label:(0,o.__)("Configurer le repli global","visi-bloc-jlg"),description:(0,o.__)("Ouvrez l’onglet Repli pour choisir ou créer un repli global.","visi-bloc-jlg")}}):u({id:"fallback-block-missing",label:(0,o.__)("Bloc de repli à sélectionner","visi-bloc-jlg"),description:(0,o.__)("Choisissez un bloc réutilisable afin de sécuriser le parcours utilisateur.","visi-bloc-jlg"),variant:"critical",severity:"critical",action:{id:"action-select-fallback-block",type:"step",targetStep:"fallback",label:(0,o.__)("Sélectionner un bloc de repli","visi-bloc-jlg"),description:(0,o.__)("Associez un bloc réutilisable pour couvrir les cas d’exclusion.","visi-bloc-jlg")}}):u({id:"fallback-text-missing",label:(0,o.__)("Texte de repli manquant","visi-bloc-jlg"),description:(0,o.__)("Ajoutez un message de substitution pour éviter une rupture de parcours.","visi-bloc-jlg"),variant:"critical",severity:"critical",action:{id:"action-write-fallback-text",type:"step",targetStep:"fallback",label:(0,o.__)("Rédiger le texte de repli","visi-bloc-jlg"),description:(0,o.__)("Complétez le champ de repli pour informer les visiteurs exclus.","visi-bloc-jlg")}}):u({id:"fallback-disabled",label:(0,o.__)("Pas de repli prévu","visi-bloc-jlg"),description:(0,o.__)("Désactiver le contenu de substitution peut générer une expérience vide. Les extensions pro affichent toujours un repli.","visi-bloc-jlg"),variant:"warning",severity:"warning",action:{id:"action-enable-fallback",type:"step",targetStep:"fallback",label:(0,o.__)("Activer un repli","visi-bloc-jlg"),description:(0,o.__)("Choisissez un contenu de substitution pour garantir une expérience complète.","visi-bloc-jlg")}}),e.hasAdvancedRules&&(e.hasAdvancedWarnings?u({id:"advanced-incomplete",label:(0,o.__)("Règles avancées à compléter","visi-bloc-jlg"),description:(0,o.__)("Certaines règles sont incomplètes (taxonomie sans termes, segment non sélectionné).","visi-bloc-jlg"),variant:"warning",severity:"warning",action:{id:"action-review-advanced-rules",type:"step",targetStep:"advanced",label:(0,o.__)("Compléter les règles avancées","visi-bloc-jlg"),description:(0,o.__)("Ouvrez l’onglet Règles avancées pour finaliser les conditions incomplètes.","visi-bloc-jlg")}}):u({id:"advanced-ready",label:(0,o.__)("Filtrage avancé prêt","visi-bloc-jlg"),description:e.advancedRulesSummary||(0,o.__)("Les conditions avancées sont structurées comme dans les offres professionnelles.","visi-bloc-jlg"),variant:"advanced",severity:"success"})),e.rolesCount>0&&u({id:"roles-targeted",label:(0,o.__)("Audience ciblée","visi-bloc-jlg"),description:e.rolesSummary||(0,o.__)("Des rôles précis reçoivent ce contenu, ce qui s’aligne sur les bonnes pratiques UX.","visi-bloc-jlg"),variant:"success",severity:"success"});const v=Math.min(100,Math.max(0,r)),_=a>=l.critical?"critical":a>=l.warning?"warning":"good",f={good:(0,o.__)("Parcours de visibilité prêt","visi-bloc-jlg"),warning:(0,o.__)("Contrôles à optimiser","visi-bloc-jlg"),critical:(0,o.__)("Plan d’affichage à sécuriser","visi-bloc-jlg")},y={good:(0,o.__)("Les réglages respectent les standards UI/UX des solutions professionnelles.","visi-bloc-jlg"),warning:(0,o.__)("Ajustez les éléments signalés pour atteindre la robustesse des offres professionnelles.","visi-bloc-jlg"),critical:(0,o.__)("Des anomalies critiques peuvent dégrader l’expérience par rapport aux extensions pro.","visi-bloc-jlg")};return{level:_,score:v,headline:f[_]||f.good,summary:y[_]||y.good,subline:(0,o.sprintf)((0,o.__)("Score de fiabilité : %d/100.","visi-bloc-jlg"),Math.round(v)),notices:s,actions:n}})({isHidden:g,hasConditionalVisibility:fi,conditionalDescription:_i,deviceVisibilitySummary:ui,hasDeviceRestrictions:N,scheduling:{isSchedulingEnabled:_,publishStartDate:f,publishEndDate:y,hasScheduleRangeError:oi,scheduleSummary:ri},fallbackEnabled:k,fallbackBehavior:C,fallbackBlockId:x,fallbackCustomText:S,hasGlobalFallback:Nt,fallbackSummary:vi,advancedRulesSummary:gi,hasAdvancedRules:Ei,hasAdvancedWarnings:ki,rolesSummary:bi,rolesCount:mi}),[g,fi,_i,ui,N,_,f,y,oi,ri,k,C,x,S,Nt,vi,gi,Ei,ki,bi,mi]);(0,t.useEffect)(()=>{if(!Ai)return;const{level:e,score:t,headline:i}=Ai,l=Ke.current||{},r=Math.round(t);if(l.level===e&&Math.round(l.score||0)===r)return;const a=bt[e]||bt.good,s=(0,o.sprintf)((0,o.__)("Synthèse visibilité mise à jour : %1$s (%2$s). Score %3$d sur 100.","visi-bloc-jlg"),i,a,r);Ze(s),Ke.current={level:e,score:t}},[Ai,bt]);const wi=Ai?Math.round(Math.max(0,Math.min(100,Ai.score||0))):0,Ni={width:`${wi}%`},Bi=Ai?`${Ai.summary}\n${Ai.subline}`:"",Ti=Ai&&Array.isArray(Ai.actions)?Ai.actions:[],Di=e=>{switch(e){case"critical":return"primary";case"warning":return"secondary";default:return"tertiary"}},Ri=(0,t.useCallback)(e=>{e&&"object"==typeof e&&("command"===e.type&&"reveal-block"===e.command&&c({isHidden:!1}),"step"===e.type&&e.targetStep&&je(e.targetStep))},[c,je]),Mi=(0,t.useMemo)(()=>{const e={};return g&&(e.device={variant:"hidden",label:(0,o.__)("Masqué","visi-bloc-jlg"),description:(0,o.__)("Ce bloc est masqué manuellement.","visi-bloc-jlg")}),_&&(e.schedule=oi?{variant:"warning",label:(0,o.__)("Dates invalides","visi-bloc-jlg"),description:(0,o.__)("Vérifiez la cohérence des dates de début et de fin.","visi-bloc-jlg")}:{variant:"schedule",label:(0,o.__)("Programmation active","visi-bloc-jlg"),description:ri}),mi>0&&(e.roles={variant:"success",label:(0,o.__)("Audience ciblée","visi-bloc-jlg"),description:bi||(0,o.__)("Des rôles spécifiques sont sélectionnés.","visi-bloc-jlg")}),Ei&&(e.advanced=ki?{variant:"warning",label:(0,o.__)("Règles incomplètes","visi-bloc-jlg"),description:(0,o.__)("Complétez les taxonomies, segments ou conditions manquantes.","visi-bloc-jlg")}:{variant:"advanced",label:(0,o.__)("Règles actives","visi-bloc-jlg"),description:gi||(0,o.__)("Des règles avancées filtrent ce bloc.","visi-bloc-jlg")}),k&&(e.fallback=Ci?{variant:"warning",label:(0,o.__)("Repli à compléter","visi-bloc-jlg"),description:(0,o.__)("Ajoutez un texte, un bloc ou définissez un repli global pour éviter une impasse.","visi-bloc-jlg")}:{variant:"fallback",label:(0,o.__)("Repli prêt","visi-bloc-jlg"),description:vi||(0,o.__)("Un repli est prêt pour ce bloc.","visi-bloc-jlg")}),e},[g,_,oi,ri,mi,bi,Ei,ki,gi,k,Ci,vi]),{actions:Li,badges:Ii,selectedRecipeId:zi,recipes:Oi,draftUpdatedAt:qi,isOpen:Pi,isSavingDraft:Vi,isLoadingDraft:Fi,mode:Hi}=W(e=>({badges:e.getBadges(),selectedRecipeId:e.getSelectedRecipeId(),recipes:e.getRecipes(),draftUpdatedAt:e.getDraftUpdatedAt(),isOpen:e.isOpen(),isSavingDraft:e.isSavingDraft(),isLoadingDraft:e.isLoadingDraft(),mode:e.getMode()}));(0,t.useEffect)(()=>{Li.setBadges(Mi)},[Li,Mi]),(0,t.useEffect)(()=>{!p&&Pi&&Li.closeWizard()},[p,Pi,Li]);const $i=(0,t.useMemo)(()=>{if(!zi)return"";const e=Oi.find(e=>e.id===zi);return e?"string"==typeof e.title&&e.title?e.title:zi:""},[zi,Oi]),Wi=(0,t.useMemo)(()=>{if(!qi)return"";try{return new Date(1e3*qi).toLocaleString()}catch(e){return""}},[qi]),Gi=(0,t.useMemo)(()=>Object.entries(Ii||{}),[Ii]),Ui=(0,t.useMemo)(()=>"string"!=typeof Hi?(0,o.__)("Mode simple","visi-bloc-jlg"):"expert"===Hi.toLowerCase()?(0,o.__)("Mode expert","visi-bloc-jlg"):(0,o.__)("Mode simple","visi-bloc-jlg"),[Hi]),Ji=[{id:"device",label:(0,o.__)("Appareils","visi-bloc-jlg"),summary:ui,content:(0,e.createElement)(s.BaseControl,{label:(0,o.__)("Visibilité par appareil","visi-bloc-jlg")},(0,e.createElement)("div",{className:"visi-bloc-device-toggle-groups"},ee?we.map(t=>{const i=t.options.some(e=>e.id===v);return(0,e.createElement)("div",{key:t.id,className:"visi-bloc-device-toggle-group"},(0,e.createElement)(s.BaseControl.VisualLabel,null,t.label),(0,e.createElement)(s.ToggleGroupControl,{className:"visi-bloc-device-toggle",isBlock:!0,isDeselectable:!0,value:i?v:void 0,onChange:e=>c({deviceVisibility:e||Ae.id})},t.options.map(t=>(0,e.createElement)(K,{key:t.id,value:t.id,icon:t.icon,label:t.label}))))}):(0,e.createElement)(s.SelectControl,{className:"visi-bloc-device-toggle-select",value:v,options:Be,onChange:e=>c({deviceVisibility:e||Ae.id})}),(0,e.createElement)(s.Button,{className:"visi-bloc-device-toggle-reset",variant:"link",isLink:!0,onClick:()=>c({deviceVisibility:Ae.id}),disabled:v===Ae.id},Ae.label)))},{id:"schedule",label:(0,o.__)("Calendrier","visi-bloc-jlg"),summary:di,content:(0,e.createElement)(t.Fragment,null,(0,e.createElement)(s.ToggleControl,{label:(0,o.__)("Activer la programmation","visi-bloc-jlg"),checked:_,onChange:()=>c({isSchedulingEnabled:!_})}),ci(ri,"is-subtle"),_&&(0,e.createElement)("div",{className:"visibloc-schedule-controls"},oi&&(0,e.createElement)(s.Notice,{status:"error",isDismissible:!1},(0,o.__)("La date de fin doit être postérieure à la date de début.","visi-bloc-jlg")),(0,e.createElement)(s.ComboboxControl,{label:(0,o.__)("Fuseau horaire de programmation","visi-bloc-jlg"),value:ei,options:Kt,onChange:e=>{const t=Kt.find(t=>t.value===e);c({publishTimezone:t?t.value:Le})},placeholder:(0,o.__)("Rechercher un fuseau horaire…","visi-bloc-jlg"),__nextHasNoMarginBottom:!0,help:(0,o.__)("Choisissez un fuseau horaire spécifique pour cette plage. Par défaut, le fuseau du site est utilisé.","visi-bloc-jlg")}),ci(li,"is-subtle"),(0,e.createElement)("div",{className:"visibloc-schedule-date-field"},(0,e.createElement)(s.CheckboxControl,{label:(0,o.__)("Définir une date de début","visi-bloc-jlg"),checked:!!f,onChange:e=>{c({publishStartDate:e?Se():void 0})}}),!!f&&(0,e.createElement)("div",{className:"visi-bloc-datepicker-wrapper"},(0,e.createElement)(s.DateTimePicker,{currentDate:f,onChange:e=>c({publishStartDate:e}),is12Hour:Ee}))),(0,e.createElement)("div",{className:"visibloc-schedule-date-field"},(0,e.createElement)(s.CheckboxControl,{label:(0,o.__)("Définir une date de fin","visi-bloc-jlg"),checked:!!y,onChange:e=>{c({publishEndDate:e?Se():void 0})}}),!!y&&(0,e.createElement)("div",{className:"visi-bloc-datepicker-wrapper"},(0,e.createElement)(s.DateTimePicker,{currentDate:y,onChange:e=>c({publishEndDate:e}),is12Hour:Ee})))))},{id:"roles",label:(0,o.__)("Rôles","visi-bloc-jlg"),summary:bi,content:(0,e.createElement)(s.BaseControl,{label:(0,o.__)("Audience ciblée","visi-bloc-jlg"),help:(0,o.__)("Sélectionnez les rôles autorisés à voir ce bloc. Laisser vide pour l’afficher à tout le monde.","visi-bloc-jlg")},(0,e.createElement)("div",{className:"visibloc-roles-list"},(0,e.createElement)(s.CheckboxControl,{label:(0,o.__)("Visiteurs déconnectés","visi-bloc-jlg"),checked:j.includes("logged-out"),onChange:e=>Qt(e,"logged-out")}),(0,e.createElement)(s.CheckboxControl,{label:(0,o.__)("Utilisateurs connectés (tous)","visi-bloc-jlg"),checked:j.includes("logged-in"),onChange:e=>Qt(e,"logged-in")}),(0,e.createElement)("div",{className:"visibloc-roles-list__divider","aria-hidden":"true"}),Object.entries(VisiBlocData.roles||{}).sort(([,e],[,t])=>String(e).localeCompare(String(t))).map(([t,i])=>(0,e.createElement)(s.CheckboxControl,{key:t,label:i,checked:j.includes(t),onChange:e=>Qt(e,t)}))))},{id:"advanced",label:(0,o.__)("Règles avancées","visi-bloc-jlg"),summary:gi,content:(0,e.createElement)("div",{className:"visibloc-advanced-rules"},(0,e.createElement)(s.SelectControl,{label:(0,o.__)("Logique entre les règles","visi-bloc-jlg"),value:w.logic,options:[{value:"AND",label:(0,o.__)("Toutes les règles doivent être vraies (ET)","visi-bloc-jlg")},{value:"OR",label:(0,o.__)("Au moins une règle doit être vraie (OU)","visi-bloc-jlg")}],onChange:e=>Jt(t=>({...t,logic:"OR"===e?"OR":"AND"}))}),w.rules.map((t,i)=>((t,i)=>{const l=e=>{Jt(l=>{const r=[...l.rules];return r[i]=lt({...t,...e}),{...l,rules:r}})},r=(0,e.createElement)(s.Flex,{align:"center",wrap:!0},(0,e.createElement)(s.FlexBlock,null,(0,e.createElement)(s.SelectControl,{label:(0,o.__)("Type de règle","visi-bloc-jlg"),value:t.type,options:De,onChange:e=>{Te.includes(e)&&Jt(t=>{const l=[...t.rules],r=it(e);return l[i]=r,{...t,rules:l}})}})),(0,e.createElement)(s.FlexItem,null,(0,e.createElement)(s.Button,{isDestructive:!0,variant:"tertiary",onClick:()=>{Jt(e=>{const t=e.rules.filter((e,t)=>t!==i);return{...e,rules:t}})}},(0,o.__)("Supprimer","visi-bloc-jlg"))));if("post_type"===t.type){const i=Fe("postTypes").map(e=>({value:e.value,label:e.label}));return(0,e.createElement)("div",{key:t.id,className:"visibloc-advanced-rule"},r,(0,e.createElement)(s.SelectControl,{label:(0,o.__)("Condition","visi-bloc-jlg"),value:t.operator,options:[{value:"is",label:(0,o.__)("Est","visi-bloc-jlg")},{value:"is_not",label:(0,o.__)("N’est pas","visi-bloc-jlg")}],onChange:e=>l({operator:e})}),(0,e.createElement)(s.SelectControl,{label:(0,o.__)("Type de contenu","visi-bloc-jlg"),value:t.value,options:i,onChange:e=>l({value:e})}))}if("taxonomy"===t.type)return(0,e.createElement)(St,{key:t.id,rule:t,taxonomies:F,onUpdateRule:l,commonHeader:r});if("template"===t.type){const i=Fe("templates").map(e=>({value:e.value,label:e.label}));return(0,e.createElement)("div",{key:t.id,className:"visibloc-advanced-rule"},r,(0,e.createElement)(s.SelectControl,{label:(0,o.__)("Condition","visi-bloc-jlg"),value:t.operator,options:[{value:"is",label:(0,o.__)("Est","visi-bloc-jlg")},{value:"is_not",label:(0,o.__)("N’est pas","visi-bloc-jlg")}],onChange:e=>l({operator:e})}),(0,e.createElement)(s.SelectControl,{label:(0,o.__)("Modèle","visi-bloc-jlg"),value:t.value,options:i,onChange:e=>l({value:e})}))}if("logged_in_status"===t.type){const i=Fe("loginStatuses").map(e=>({value:e.value,label:e.label}));return(0,e.createElement)("div",{key:t.id,className:"visibloc-advanced-rule"},r,(0,e.createElement)(s.SelectControl,{label:(0,o.__)("Condition","visi-bloc-jlg"),value:t.operator,options:[{value:"is",label:(0,o.__)("Est","visi-bloc-jlg")},{value:"is_not",label:(0,o.__)("N’est pas","visi-bloc-jlg")}],onChange:e=>l({operator:e})}),(0,e.createElement)(s.SelectControl,{label:(0,o.__)("État de connexion","visi-bloc-jlg"),value:t.value,options:i,onChange:e=>l({value:e})}))}if("user_role_group"===t.type){const i=Fe("roleGroups"),a=He("roles")||{},n=i.find(e=>e&&e.value===t.group),c=n&&Array.isArray(n.roles)?n.roles:[];return(0,e.createElement)("div",{key:t.id,className:"visibloc-advanced-rule"},r,(0,e.createElement)(s.SelectControl,{label:(0,o.__)("Condition","visi-bloc-jlg"),value:t.operator,options:[{value:"matches",label:(0,o.__)("Correspond à","visi-bloc-jlg")},{value:"does_not_match",label:(0,o.__)("Ne correspond pas à","visi-bloc-jlg")}],onChange:e=>l({operator:e})}),(0,e.createElement)(s.SelectControl,{label:(0,o.__)("Groupe de rôles","visi-bloc-jlg"),value:t.group,options:i.map(e=>({value:e.value,label:e.label})),onChange:e=>l({group:e})}),c.length>0&&(0,e.createElement)("p",{className:"components-help-text"},c.map(e=>a[e]||e).filter(Boolean).join(", ")))}if("user_segment"===t.type){const i=Fe("userSegments").map(e=>({value:"string"==typeof e.value?e.value:"",label:"string"==typeof e.label&&e.label.trim()?e.label:"string"==typeof e.value?e.value:""})).filter(e=>e.value),a=He("userSegmentsStatus")||{},n=a&&"string"==typeof a.error?a.error.trim():"",c=a&&"string"==typeof a.lastUpdatedHuman?a.lastUpdatedHuman.trim():"",u=a&&"string"==typeof a.connectorLabel?a.connectorLabel.trim():"",d=[{value:"matches",label:(0,o.__)("Appartient au segment","visi-bloc-jlg")},{value:"does_not_match",label:(0,o.__)("N’appartient pas au segment","visi-bloc-jlg")}],p="string"==typeof t.segment?t.segment:"";return(0,e.createElement)("div",{key:t.id,className:"visibloc-advanced-rule"},r,(0,e.createElement)(s.SelectControl,{label:(0,o.__)("Condition","visi-bloc-jlg"),value:t.operator,options:d,onChange:e=>l({operator:e})}),n&&(0,e.createElement)(s.Notice,{status:"error",isDismissible:!1},n),(0,e.createElement)(s.ComboboxControl,{label:(0,o.__)("Identifiant de segment","visi-bloc-jlg"),value:p,options:i,onChange:e=>l({segment:e||""}),allowReset:!0,help:(0,o.__)("Choisissez un segment fourni par vos intégrations marketing ou saisissez un identifiant personnalisé.","visi-bloc-jlg")}),!n&&c&&(0,e.createElement)("p",{className:"components-help-text"},u?(0,o.sprintf)((0,o.__)("Segments « %s » synchronisés %s.","visi-bloc-jlg"),u,c):(0,o.sprintf)((0,o.__)("Segments synchronisés %s.","visi-bloc-jlg"),c)),!i.length&&(0,e.createElement)("p",{className:"components-help-text"},(0,o.__)("Aucun segment n’a encore été exposé via le filtre « visibloc_jlg_user_segments ».","visi-bloc-jlg")))}if("woocommerce_cart"===t.type){const i=Fe("woocommerceTaxonomies"),a=Array.isArray(i)&&i.length>0,n=i.find(e=>e&&e.slug===t.taxonomy),c=a?i.map(e=>({value:e.slug,label:e.label})):[{value:"",label:(0,o.__)("Aucune taxonomie disponible","visi-bloc-jlg")}],u=n&&Array.isArray(n.terms)?n.terms.map(e=>({value:e.value,label:e.label})):[],d=(e,i)=>{const r=String(i),a=e?[...t.terms,r]:t.terms.filter(e=>e!==r);l({terms:a})};return(0,e.createElement)("div",{key:t.id,className:"visibloc-advanced-rule"},r,(0,e.createElement)(s.SelectControl,{label:(0,o.__)("Condition","visi-bloc-jlg"),value:t.operator,options:[{value:"contains",label:(0,o.__)("Contient des produits avec ces termes","visi-bloc-jlg")},{value:"not_contains",label:(0,o.__)("Ne contient aucun produit avec ces termes","visi-bloc-jlg")}],onChange:e=>l({operator:e})}),(0,e.createElement)(s.SelectControl,{label:(0,o.__)("Taxonomie WooCommerce","visi-bloc-jlg"),value:t.taxonomy,options:c,onChange:e=>l({taxonomy:e,terms:[]}),disabled:!a}),a?u.length>0?(0,e.createElement)("div",{className:"visibloc-advanced-rule__terms"},u.map(i=>(0,e.createElement)(s.CheckboxControl,{key:i.value,label:i.label,checked:t.terms.includes(i.value),onChange:e=>d(e,i.value)}))):(0,e.createElement)("p",{className:"components-help-text"},(0,o.__)("Aucun terme disponible pour cette taxonomie WooCommerce.","visi-bloc-jlg")):(0,e.createElement)("p",{className:"components-help-text"},(0,o.__)("Aucune source WooCommerce n’est disponible. Activez WooCommerce pour utiliser cette règle.","visi-bloc-jlg")))}if("query_param"===t.type){const i=Fe("commonQueryParams").map(e=>({value:e.value,label:e.label||e.value})),a=[{value:"",label:(0,o.__)("Personnalisé…","visi-bloc-jlg")},...i],n=[{value:"equals",label:(0,o.__)("Est égal à","visi-bloc-jlg")},{value:"not_equals",label:(0,o.__)("Est différent de","visi-bloc-jlg")},{value:"contains",label:(0,o.__)("Contient","visi-bloc-jlg")},{value:"not_contains",label:(0,o.__)("Ne contient pas","visi-bloc-jlg")},{value:"exists",label:(0,o.__)("Existe","visi-bloc-jlg")},{value:"not_exists",label:(0,o.__)("N’existe pas","visi-bloc-jlg")}],c=i.some(e=>e.value===t.param)?t.param:"";return(0,e.createElement)("div",{key:t.id,className:"visibloc-advanced-rule"},r,(0,e.createElement)(s.SelectControl,{label:(0,o.__)("Condition","visi-bloc-jlg"),value:t.operator,options:n,onChange:e=>l({operator:e})}),(0,e.createElement)(s.SelectControl,{label:(0,o.__)("Paramètre courant","visi-bloc-jlg"),value:c,options:a,onChange:e=>{e&&l({param:e})}}),(0,e.createElement)(s.TextControl,{label:(0,o.__)("Nom du paramètre","visi-bloc-jlg"),value:t.param,onChange:e=>l({param:e}),help:(0,o.__)("Saisissez le nom du paramètre de requête attendu (ex. utm_source).","visi-bloc-jlg")}),!["exists","not_exists"].includes(t.operator)&&(0,e.createElement)(s.TextControl,{label:(0,o.__)("Valeur attendue","visi-bloc-jlg"),value:t.value,onChange:e=>l({value:e})}))}if("cookie"===t.type){const i=Fe("commonCookies").map(e=>({value:e.value,label:e.label||e.value})),a=[{value:"",label:(0,o.__)("Personnalisé…","visi-bloc-jlg")},...i],n=[{value:"equals",label:(0,o.__)("Est égal à","visi-bloc-jlg")},{value:"not_equals",label:(0,o.__)("Est différent de","visi-bloc-jlg")},{value:"contains",label:(0,o.__)("Contient","visi-bloc-jlg")},{value:"not_contains",label:(0,o.__)("Ne contient pas","visi-bloc-jlg")},{value:"exists",label:(0,o.__)("Existe","visi-bloc-jlg")},{value:"not_exists",label:(0,o.__)("N’existe pas","visi-bloc-jlg")}],c=i.some(e=>e.value===t.name)?t.name:"";return(0,e.createElement)("div",{key:t.id,className:"visibloc-advanced-rule"},r,(0,e.createElement)(s.SelectControl,{label:(0,o.__)("Condition","visi-bloc-jlg"),value:t.operator,options:n,onChange:e=>l({operator:e})}),(0,e.createElement)(s.SelectControl,{label:(0,o.__)("Cookie courant","visi-bloc-jlg"),value:c,options:a,onChange:e=>{e&&l({name:e})}}),(0,e.createElement)(s.TextControl,{label:(0,o.__)("Nom du cookie","visi-bloc-jlg"),value:t.name,onChange:e=>l({name:e}),help:(0,o.__)("Saisissez le nom exact du cookie attendu (respect de la casse).","visi-bloc-jlg")}),!["exists","not_exists"].includes(t.operator)&&(0,e.createElement)(s.TextControl,{label:(0,o.__)("Valeur attendue","visi-bloc-jlg"),value:t.value,onChange:e=>l({value:e})}))}if("geolocation"===t.type){const i=H.map(e=>{if(!e||"object"!=typeof e)return null;const t=et(e.value);return t?{value:t,label:"string"==typeof e.label&&e.label.trim()?e.label:t}:null}).filter(Boolean),a=new Map,n=new Map,c=i.map(e=>{const t=`${e.label} (${e.value})`;return a.set(e.value,t),n.set(t,e.value),t}),u=(Array.isArray(t.countries)?t.countries:[]).map(e=>{const t=et(e);return a.get(t)||t}).filter(Boolean),d=e=>{const t=Array.from(new Set(e.map(e=>"string"!=typeof e?"":n.has(e)?n.get(e):et(e)).filter(Boolean)));l({countries:t})},p=[{value:"in",label:(0,o.__)("Comprend ces pays","visi-bloc-jlg")},{value:"not_in",label:(0,o.__)("Exclut ces pays","visi-bloc-jlg")}];return(0,e.createElement)("div",{key:t.id,className:"visibloc-advanced-rule"},r,(0,e.createElement)(s.SelectControl,{label:(0,o.__)("Condition","visi-bloc-jlg"),value:t.operator,options:p,onChange:e=>l({operator:"not_in"===e?"not_in":"in"})}),te?(0,e.createElement)(s.FormTokenField,{label:(0,o.__)("Pays ciblés","visi-bloc-jlg"),value:u,suggestions:c,onChange:d,placeholder:(0,o.__)("Ajouter un pays (FR, CA, US…)…","visi-bloc-jlg")}):(0,e.createElement)(tt,{label:(0,o.__)("Pays ciblés","visi-bloc-jlg"),value:u,onChange:d,placeholder:(0,o.__)("Ajouter un pays (FR, CA, US…)…","visi-bloc-jlg")}),!i.length&&(0,e.createElement)("p",{className:"components-help-text"},(0,o.__)("Aucun pays n’est préconfiguré. Les intégrations peuvent compléter cette liste via le filtre « visibloc_jlg_editor_geolocation_countries ».","visi-bloc-jlg")),(0,e.createElement)("p",{className:"components-help-text"},(0,o.__)("Utilisez les codes ISO 3166-1 alpha-2 (ex. FR, BE, US). Les suggestions garantissent une orthographe cohérente.","visi-bloc-jlg")))}if("visit_count"===t.type){const i=[{value:"at_least",label:(0,o.__)("Au moins","visi-bloc-jlg")},{value:"at_most",label:(0,o.__)("Au plus","visi-bloc-jlg")},{value:"equals",label:(0,o.__)("Est exactement","visi-bloc-jlg")},{value:"not_equals",label:(0,o.__)("N’est pas exactement","visi-bloc-jlg")}],a=Number.isFinite(t.threshold)&&t.threshold>=0?String(t.threshold):"0";return(0,e.createElement)("div",{key:t.id,className:"visibloc-advanced-rule"},r,(0,e.createElement)(s.SelectControl,{label:(0,o.__)("Condition","visi-bloc-jlg"),value:t.operator,options:i,onChange:e=>l({operator:e})}),(0,e.createElement)(s.TextControl,{label:(0,o.__)("Nombre de visites","visi-bloc-jlg"),type:"number",min:0,value:a,onChange:e=>{const t=Number.parseInt(e,10);l({threshold:Number.isNaN(t)||t<0?0:t})},help:(0,o.__)("Le compteur de visites est stocké dans le cookie « visibloc_visit_count ».","visi-bloc-jlg")}))}const a=e=>t=>{const i=t&&t.target?t.target.value:"",r="string"==typeof i?i:"";l({[e]:r})};return(0,e.createElement)("div",{key:t.id,className:"visibloc-advanced-rule"},r,(0,e.createElement)(s.SelectControl,{label:(0,o.__)("Fréquence","visi-bloc-jlg"),value:t.frequency,options:[{value:"daily",label:(0,o.__)("Quotidien","visi-bloc-jlg")},{value:"weekly",label:(0,o.__)("Hebdomadaire","visi-bloc-jlg")}],onChange:e=>l({frequency:e,days:"weekly"===e?t.days:[]})}),(0,e.createElement)(s.Flex,{gap:"small"},(0,e.createElement)(s.FlexBlock,null,(0,e.createElement)(s.BaseControl,{label:(0,o.__)("Heure de début","visi-bloc-jlg")},(0,e.createElement)("input",{type:"time",value:t.startTime||"",onChange:a("startTime"),className:"components-text-control__input"}))),(0,e.createElement)(s.FlexBlock,null,(0,e.createElement)(s.BaseControl,{label:(0,o.__)("Heure de fin","visi-bloc-jlg")},(0,e.createElement)("input",{type:"time",value:t.endTime||"",onChange:a("endTime"),className:"components-text-control__input"})))),"weekly"===t.frequency&&Xe.size>0&&(0,e.createElement)("div",{className:"visibloc-advanced-rule__days"},(0,e.createElement)("p",{className:"components-base-control__label"},(0,o.__)("Jours actifs","visi-bloc-jlg")),Array.from(Xe.entries()).map(([i,r])=>(0,e.createElement)(s.CheckboxControl,{key:i,label:r,checked:t.days.includes(i),onChange:e=>((e,i)=>{const r=e?[...new Set([...t.days,i])]:t.days.filter(e=>e!==i);l({days:r})})(e,i)}))))})(t,i)),(0,e.createElement)(s.DropdownMenu,{text:(0,o.__)("Ajouter une règle de…","visi-bloc-jlg"),label:(0,o.__)("Ajouter une règle de…","visi-bloc-jlg"),toggleProps:{variant:"secondary"}},({onClose:t})=>(0,e.createElement)(s.MenuGroup,{label:(0,o.__)("Types de règles disponibles","visi-bloc-jlg")},De.map(i=>(0,e.createElement)(s.MenuItem,{key:i.value,onClick:()=>{Jt(e=>({...e,rules:[...e.rules,it(i.value)]})),t()}},i.label)))),ci((0,o.__)("Ces règles permettent d’affiner la visibilité selon le contexte du contenu, le modèle ou un horaire récurrent.","visi-bloc-jlg"),"is-subtle"))},{id:"fallback",label:(0,o.__)("Repli","visi-bloc-jlg"),summary:vi,content:(0,e.createElement)(t.Fragment,null,(0,e.createElement)(s.ToggleControl,{label:(0,o.__)("Activer le repli pour ce bloc","visi-bloc-jlg"),checked:k,onChange:()=>c({fallbackEnabled:!k})}),!k&&(0,e.createElement)(s.Notice,{status:"info",isDismissible:!1},(0,o.__)("Aucun contenu de repli ne sera affiché si ce bloc est masqué.","visi-bloc-jlg")),k&&(0,e.createElement)(t.Fragment,null,(0,e.createElement)(s.SelectControl,{label:(0,o.__)("Source du repli","visi-bloc-jlg"),value:C,options:Rt,onChange:e=>c({fallbackBehavior:Rt.some(t=>t.value===e)?e:"inherit"})}),"inherit"===C&&(Nt?(0,e.createElement)(s.Notice,{status:"info",isDismissible:!1},Bt?(0,o.sprintf)((0,o.__)("Repli global : %s","visi-bloc-jlg"),Bt):(0,o.__)("Un repli global est configuré.","visi-bloc-jlg")):(0,e.createElement)(s.Notice,{status:"warning",isDismissible:!1},(0,o.__)("Aucun repli global n’est actuellement défini.","visi-bloc-jlg"))),"text"===C&&(0,e.createElement)(s.TextareaControl,{label:(0,o.__)("Texte affiché en repli","visi-bloc-jlg"),help:(0,o.__)("Ce texte remplace le bloc lorsque les visiteurs n’y ont pas accès.","visi-bloc-jlg"),value:S,onChange:e=>c({fallbackCustomText:e})}),"block"===C&&(0,e.createElement)(Qe,{value:x,disabled:!k,endpoint:D,initialOptions:T,onOptionsLoaded:I,onChange:e=>{c({fallbackBlockId:"number"!=typeof e||Number.isNaN(e)?0:e})}}),(0,e.createElement)(s.ToggleControl,{label:(0,o.__)("Prévisualiser le repli","visi-bloc-jlg"),checked:fe,onChange:()=>ye(e=>!e),disabled:!k,"aria-controls":Gt,"aria-expanded":fe&&k}),fe&&k&&(0,e.createElement)("div",{ref:Wt,id:Gt,className:"visibloc-fallback-preview",role:"region","aria-live":"polite","aria-labelledby":Ut,tabIndex:"-1"},(0,e.createElement)("span",{id:Ut,className:"screen-reader-text"},(0,o.__)("Aperçu du contenu de repli","visi-bloc-jlg")),Ft?(0,e.createElement)("div",{className:"visibloc-fallback-preview__content"},(0,e.createElement)(t.RawHTML,null,Ft)):(0,e.createElement)(s.Notice,{status:"warning"===Ht?"warning":"info",isDismissible:!1},$t||(0,o.__)("Aucun aperçu disponible pour ce repli.","visi-bloc-jlg")))))}],Qi=gt?Ji.filter(e=>qe.includes(e.id)):Ji;(0,t.useEffect)(()=>{Qi.length?Qi.some(e=>e.id===he)||je(Qi[0].id):je("")},[Qi,he]);const Yi=Qi[0]||null,Xi=Qi.map((t,i)=>{const l=Mi[t.id],r=(0,o.sprintf)((0,o.__)("Étape %1$d · %2$s","visi-bloc-jlg"),i+1,t.label);return{name:t.id,title:(0,e.createElement)("span",{className:"visibloc-stepper__tab-label"},(0,e.createElement)("span",{className:"visibloc-stepper__tab-text"},r),l?(0,e.createElement)(s.Tooltip,{text:l.description},(0,e.createElement)("span",{className:`visibloc-stepper__status visibloc-stepper__status--${l.variant}`,"aria-label":l.description},l.label)):null),className:"visibloc-stepper__tab"}});return(0,e.createElement)(t.Fragment,null,(0,e.createElement)(i,{...l}),(0,e.createElement)(X,null),p&&(0,e.createElement)(t.Fragment,null,(0,e.createElement)(a.BlockControls,null,(0,e.createElement)(s.ToolbarGroup,null,(0,e.createElement)(s.ToolbarButton,{icon:"visibility",label:(0,o.__)("Rendre visible","visi-bloc-jlg"),onClick:()=>c({isHidden:!1}),isActive:!1===g}),(0,e.createElement)(s.ToolbarButton,{icon:"hidden",label:(0,o.__)("Rendre caché","visi-bloc-jlg"),onClick:()=>c({isHidden:!0}),isActive:!0===g}))),(0,e.createElement)(a.InspectorControls,null,(0,e.createElement)(s.PanelBody,{title:(0,o.__)("Assistant Onboarding","visi-bloc-jlg"),initialOpen:!1,className:"visibloc-panel--onboarding"},(0,e.createElement)("p",null,(0,o.__)("Centralisez vos objectifs et votre audience avant d’ajuster les réglages de visibilité.","visi-bloc-jlg")),(0,e.createElement)("div",{className:"visibloc-onboarding-panel__meta"},(0,e.createElement)("span",{className:"visibloc-onboarding-panel__meta-item"},Ui),$i?(0,e.createElement)("span",{className:"visibloc-onboarding-panel__meta-item"},(0,o.sprintf)((0,o.__)("Recette sélectionnée : %s","visi-bloc-jlg"),$i)):null,Wi?(0,e.createElement)("span",{className:"visibloc-onboarding-panel__meta-item"},(0,o.sprintf)((0,o.__)("Brouillon mis à jour : %s","visi-bloc-jlg"),Wi)):null),(0,e.createElement)("div",{className:"visibloc-onboarding-panel__badges"},Gi.length>0?Gi.map(([t,i])=>(0,e.createElement)(ce,{key:`onboarding-badge-${t}`,label:i.label,variant:i.variant,description:i.description})):(0,e.createElement)("p",{className:"visibloc-onboarding-panel__placeholder"},(0,o.__)("Les badges apparaîtront après configuration de la visibilité.","visi-bloc-jlg"))),(0,e.createElement)(s.Button,{variant:"primary",onClick:()=>Li.openWizard(),isBusy:Fi||Vi},Fi?(0,o.__)("Chargement…","visi-bloc-jlg"):Pi?(0,o.__)("Reprendre l’assistant","visi-bloc-jlg"):(0,o.__)("Ouvrir l’assistant","visi-bloc-jlg"))),(0,e.createElement)(s.PanelBody,{title:(0,o.__)("Parcours de visibilité","visi-bloc-jlg"),initialOpen:!0,className:"visibloc-panel--guided"},(0,e.createElement)("div",{className:"visibloc-editor-mode"},(0,e.createElement)(s.BaseControl,{id:_e},(0,e.createElement)(s.BaseControl.VisualLabel,null,(0,o.__)("Mode d’édition","visi-bloc-jlg")),ee?(0,e.createElement)(s.ToggleGroupControl,{className:"visibloc-editor-mode__toggle",isBlock:!0,value:Z,onChange:e=>yt(e||Oe)},(0,e.createElement)(K,{value:Ie,label:(0,o.__)("Simple","visi-bloc-jlg"),icon:re,disabled:oe}),(0,e.createElement)(K,{value:ze,label:(0,o.__)("Expert","visi-bloc-jlg"),icon:ae,disabled:oe})):(0,e.createElement)(s.RadioControl,{className:"visibloc-editor-mode__toggle",selected:Z,options:[{label:(0,o.__)("Simple","visi-bloc-jlg"),value:Ie},{label:(0,o.__)("Expert","visi-bloc-jlg"),value:ze}],onChange:e=>yt(e||Oe),disabled:oe}),(0,e.createElement)("div",{className:"visibloc-editor-mode__meta"},oe?(0,e.createElement)("span",{className:"visibloc-editor-mode__spinner"},(0,e.createElement)(s.Spinner,null),(0,e.createElement)("span",{className:"visibloc-editor-mode__spinner-text"},(0,o.__)("Enregistrement en cours…","visi-bloc-jlg"))):null,ci(vt,"is-subtle"))),(0,e.createElement)(s.ToggleControl,{label:(0,o.__)("Contraste renforcé","visi-bloc-jlg"),checked:le,onChange:ht,disabled:oe,help:_t}),(0,e.createElement)("div",{id:ge,className:"visibloc-editor-mode__status screen-reader-text",role:"status","aria-live":"polite"},de||be),de?(0,e.createElement)(s.Notice,{status:"error",onRemove:()=>pe("")},de):null),Si?(0,e.createElement)(s.Notice,{status:xi,isDismissible:!1},ki?(0,o.__)("Des règles avancées sont incomplètes. Passez en mode Expert pour les corriger.","visi-bloc-jlg"):(0,o.__)("Des règles avancées filtrent ce bloc. Passez en mode Expert pour les ajuster.","visi-bloc-jlg")):null,Ai?(0,e.createElement)(t.Fragment,null,(0,e.createElement)(s.Card,{className:`visibloc-diagnostic-card visibloc-diagnostic-card--${Ai.level}`},(0,e.createElement)(s.CardHeader,null,(0,e.createElement)("div",{className:"visibloc-diagnostic-card__header"},(0,e.createElement)("div",{className:"visibloc-diagnostic-card__texts"},(0,e.createElement)("p",{className:"visibloc-diagnostic-card__eyebrow"},(0,o.__)("Synthèse qualité","visi-bloc-jlg")),(0,e.createElement)("h3",{className:"visibloc-diagnostic-card__title"},Ai.headline),(0,e.createElement)("p",{className:"visibloc-diagnostic-card__summary"},Bi)),(0,e.createElement)("div",{className:"visibloc-diagnostic-card__score","aria-hidden":"true"},(0,e.createElement)("span",{className:"visibloc-diagnostic-card__score-value"},wi),(0,e.createElement)("span",{className:"visibloc-diagnostic-card__score-suffix"},"/100"),(0,e.createElement)("span",{className:"visibloc-diagnostic-card__score-meter"},(0,e.createElement)("span",{className:"visibloc-diagnostic-card__score-meter-fill",style:Ni}))))),(0,e.createElement)(s.CardBody,null,Ai.notices.length>0?(0,e.createElement)("ul",{className:"visibloc-diagnostic-list"},Ai.notices.map(t=>(0,e.createElement)("li",{key:t.id,className:"visibloc-diagnostic-list__item"},(0,e.createElement)(ce,{label:t.label,variant:t.variant,description:t.description,screenReaderText:t.screenReaderText})))):(0,e.createElement)("p",{className:"visibloc-diagnostic-empty"},(0,o.__)("Aucun diagnostic particulier pour ce bloc.","visi-bloc-jlg")),Ti.length>0?(0,e.createElement)("div",{className:"visibloc-diagnostic-actions"},(0,e.createElement)("p",{className:"visibloc-diagnostic-actions__title"},(0,o.__)("Actions recommandées","visi-bloc-jlg")),(0,e.createElement)("ul",{className:"visibloc-diagnostic-actions__list"},Ti.map(t=>{const i=t.description?`${t.id}-description`:void 0;return(0,e.createElement)("li",{key:t.id,className:`visibloc-diagnostic-actions__item visibloc-diagnostic-actions__item--${t.type}`},(0,e.createElement)(s.Button,{variant:Di(t.severity),onClick:()=>Ri(t),"aria-describedby":i},t.label),t.description?(0,e.createElement)("p",{id:i,className:"visibloc-diagnostic-actions__description"},t.description):null)}))):null)),(0,e.createElement)("div",{className:"screen-reader-text",role:"status","aria-live":"polite"},Ue)):null,G.length>0&&(0,e.createElement)("div",{className:"visibloc-scenario-presets"},(0,e.createElement)("div",{className:"visibloc-scenario-presets__header"},(0,e.createElement)("p",{className:"visibloc-scenario-presets__title"},(0,o.__)("Scénarios recommandés","visi-bloc-jlg")),(0,e.createElement)(s.Button,{variant:"link",onClick:()=>Me(!0)},(0,o.__)("Explorer toutes les recettes","visi-bloc-jlg"))),(0,e.createElement)("div",{className:"visibloc-scenario-presets__grid"},G.map(t=>{const i=Et(t.severity),l=st[i]||st.medium,r=A===t.id;return(0,e.createElement)(s.Button,{key:t.id,className:`visibloc-scenario-presets__button visibloc-scenario-presets__button--${i}`,variant:r?"primary":"secondary","aria-pressed":r,onClick:()=>kt(t)},(0,e.createElement)("span",{className:"visibloc-scenario-presets__badge"},l),(0,e.createElement)("span",{className:"visibloc-scenario-presets__label"},t.label),t.description?(0,e.createElement)("span",{className:"visibloc-scenario-presets__description"},t.description):null)}))),Xi.length>0&&(0,e.createElement)(s.TabPanel,{className:"visibloc-stepper",activeClass:"is-active",initialTabName:he,onSelect:e=>je(e),tabs:Xi},i=>{const l=Qi.find(e=>e.id===i.name)||Yi,r=(a=l?l.summary:"")&&String(a).trim()?a:ni;var a;const s=l?l.content:null;return(0,e.createElement)(t.Fragment,null,ci(r,"is-summary"),(0,e.createElement)("div",{className:"visibloc-step-content"},s))}))),Re&&(0,e.createElement)(s.Modal,{title:(0,o.__)("Bibliothèque de recettes","visi-bloc-jlg"),onRequestClose:()=>Me(!1),className:"visibloc-recipes-modal"},(0,e.createElement)("div",{className:"visibloc-recipes-modal__grid"},q.length>0?q.map(t=>{const i=Et(t.severity),l=st[i]||st.medium;return(0,e.createElement)(s.Card,{key:t.id,className:"visibloc-recipes-modal__card"},(0,e.createElement)(s.CardHeader,null,(0,e.createElement)("div",{className:"visibloc-recipes-modal__heading"},(0,e.createElement)("h3",{className:"visibloc-recipes-modal__title"},t.title),(0,e.createElement)("span",{className:`visibloc-scenario-presets__badge visibloc-scenario-presets__badge--${i}`},l))),(0,e.createElement)(s.CardBody,null,(0,e.createElement)("p",null,t.description)),(0,e.createElement)(s.CardFooter,null,(0,e.createElement)(s.Button,{variant:"primary",onClick:()=>At(t)},(0,o.__)("Appliquer cette recette","visi-bloc-jlg"))))}):(0,e.createElement)("p",{className:"visibloc-recipes-modal__empty"},(0,o.__)("Aucune recette n’est disponible pour le moment.","visi-bloc-jlg"))))))},"withVisibilityControls");function At(){const e=(0,d.select)("core/edit-post");return!!e&&("function"==typeof e.isListViewOpened?e.isListViewOpened():"function"==typeof e.isFeatureActive&&e.isFeatureActive("listView"))}function wt(e){jt!==e&&("undefined"!=typeof document&&document.body?(jt=e,document.body.classList.toggle("visibloc-compact-badges",e)):jt=e)}function Nt(){if("undefined"==typeof document||"undefined"==typeof ResizeObserver)return;const e=document.querySelector(".block-editor-list-view__container")||document.querySelector(".block-editor-list-view");e&&(yt||(yt=new ResizeObserver(t=>{t.forEach(t=>{const i=t&&t.target?t.target:e;wt((t&&t.contentRect?t.contentRect.width:i.offsetWidth)<260)})})),ht&&ht!==e&&yt.unobserve(ht),ht=e,yt.observe(e),wt((e.getBoundingClientRect?e.getBoundingClientRect().width:e.offsetWidth)<260))}function Bt(){if("undefined"==typeof document)return void(ft=null);const e=new Map;ut.forEach((t,i)=>{let l=dt.get(i);if(l&&l.isConnected||(l=document.querySelector(`.block-editor-list-view__block[data-block="${i}"]`),l&&dt.set(i,l)),!l)return dt.delete(i),void e.set(i,t);t.isHidden?l.classList.add("bloc-editeur-cache"):l.classList.remove("bloc-editeur-cache"),t.hasFallback?l.classList.add("bloc-editeur-repli"):l.classList.remove("bloc-editeur-repli"),t.isConditionallyHidden?l.classList.add("bloc-editeur-conditionnel"):l.classList.remove("bloc-editeur-conditionnel")}),ut.clear(),e.size&&e.forEach((e,t)=>{ut.set(t,e)}),ut.size&&At()?ft=window.requestAnimationFrame(()=>{Bt()}):(Nt(),ft=null)}function Tt(e,t){const i=ut.get(e);i&&i.isHidden===t.isHidden&&i.hasFallback===t.hasFallback&&i.isConditionallyHidden===t.isConditionallyHidden&&i.hiddenDescription===t.hiddenDescription&&i.conditionalDescription===t.conditionalDescription&&i.fallbackDescription===t.fallbackDescription||(ut.set(e,t),ft||(ft=window.requestAnimationFrame(()=>{Bt()})))}function Dt(){const e=(0,d.select)("core/block-editor");if(!e)return;let t="",i=[];if("function"==typeof e.getBlocks){const l=e.getBlocks();if(Array.isArray(l))if(l!==vt){const e=(e=>{const t=[];if(!Array.isArray(e)||!e.length)return t;const i=[...e];for(;i.length;){const e=i.shift();e&&"object"==typeof e&&(e.clientId&&t.push(e.clientId),Array.isArray(e.innerBlocks)&&e.innerBlocks.length&&i.unshift(...e.innerBlocks))}return t})(l);i=e,t=e.join("|"),vt=l,_t=e}else i=Array.isArray(_t)?_t:[],t=i.join("|")}if(Array.isArray(i)&&i.length||(i=function(e){if(!e)return[];if("function"==typeof e.getClientIdsWithDescendants){const t=e.getClientIdsWithDescendants();if(Array.isArray(t))return t}const t=e.getBlockOrder();if(!Array.isArray(t)||!t.length)return[];const i=[...t],l=[];for(;i.length;){const t=i.pop();if(!t)continue;l.push(t);const r=e.getBlockOrder(t);Array.isArray(r)&&r.length&&r.forEach(e=>i.push(e))}return l}(e),t=i.join("|"),vt=null,_t=i),!i.length)return void((pt.size||ct.size)&&(pt.clear(),ct.clear(),ut.clear(),dt.clear(),bt.clear(),mt.clear(),gt="",_t=[],vt=null));const l=new Set(i);if(t!==gt&&(i.forEach(t=>{if(pt.has(t))return;let i="function"==typeof e.getBlockName?e.getBlockName(t):void 0;if(!i){const l=e.getBlock(t);i=l?l.name:void 0}i&&ve(i)&&(pt.add(t),mt.add(t),bt.delete(t))}),Array.from(pt).filter(e=>!l.has(e)).forEach(e=>{pt.delete(e),ct.delete(e),ut.delete(e),dt.delete(e),bt.delete(e),mt.delete(e)}),gt=t),!mt.size)return;const r=Array.from(mt);mt.clear(),r.forEach(t=>{const i=e.getBlock(t);if(!i||!ve(i.name))return bt.delete(t),ct.delete(t),ut.delete(t),dt.delete(t),void pt.delete(t);const l=nt(i.attributes);if(bt.get(t)===l)return;bt.set(t,l);const r=ct.get(t)||{},a=st(i.attributes),s=a.conditionalDescription||"",n=[];i.attributes.isHidden&&n.push((0,o.__)("Bloc masqué manuellement.","visi-bloc-jlg")),s&&n.push(...s.split("\n"));const c=n.join("\n").trim(),u={...r,isHidden:Boolean(i.attributes.isHidden),hasFallback:Ye(i.attributes),isConditionallyHidden:a.hasConditionalVisibility&&!i.attributes.isHidden,conditionalDescription:s,hiddenDescription:c};ct.set(t,u),Tt(t,u)})}const Rt=g()(Dt,120);function Mt(){Rt()}(0,l.addFilter)("blocks.registerBlockType","visi-bloc-jlg/add-visibility-attributes",function(e,t){return ve(t)?(e.attributes={...e.attributes,isHidden:{type:"boolean",default:!1},deviceVisibility:{type:"string",default:"all"},isSchedulingEnabled:{type:"boolean",default:!1},publishStartDate:{type:"string"},publishEndDate:{type:"string"},publishTimezone:{type:"string",default:Le},visibilityRoles:{type:"array",default:[]},advancedVisibility:{type:"object",default:Re},fallbackEnabled:{type:"boolean",default:!0},fallbackBehavior:{type:"string",default:"inherit"},fallbackCustomText:{type:"string",default:""},fallbackBlockId:{type:"number"},scenarioPreset:{type:"string",default:""}},e):e}),(0,l.addFilter)("editor.BlockEdit","visi-bloc-jlg/with-visibility-controls",xt),(0,l.addFilter)("blocks.getSaveContent.extraProps","visi-bloc-jlg/add-save-classes",function(e,t,i){if(!ve(t.name)||!i)return e;const{deviceVisibility:l}=i,r=[e.className,l&&"all"!==l?`vb-${l}`:""].filter(Boolean).join(" ");return{...e,className:r}}),(0,l.addFilter)("editor.BlockListBlock","visi-bloc-jlg/add-editor-status-badges",(0,r.createHigherOrderComponent)(i=>l=>{const r=l.clientId&&ct.get(l.clientId)||{},a=[];"string"==typeof l.className&&l.className.trim()&&a.push(l.className.trim()),r.isHidden&&a.push("bloc-editeur-cache"),r.hasFallback&&a.push("bloc-editeur-repli"),r.isConditionallyHidden&&a.push("bloc-editeur-conditionnel");const s=Array.from(new Set(a.join(" ").split(/\s+/).filter(Boolean))).join(" "),n=s.includes("bloc-editeur-cache"),c=s.includes("bloc-editeur-repli"),u=s.includes("bloc-editeur-conditionnel"),d="string"==typeof r.hiddenDescription?r.hiddenDescription:"",p="string"==typeof r.conditionalDescription?r.conditionalDescription:"",b="string"==typeof r.fallbackDescription?r.fallbackDescription:"",m={...l,className:s};if(!n&&!c&&!u)return(0,e.createElement)(i,{...m});const g=(0,e.createElement)(i,{...m}),v=t.Children.toArray(g.props.children),_=[];return n&&_.push((0,e.createElement)(ce,{key:"visibloc-hidden-badge",label:(0,o.__)("Bloc masqué","visi-bloc-jlg"),variant:"hidden",screenReaderText:(0,o.__)("Ce bloc est masqué pour les visiteurs du site.","visi-bloc-jlg"),description:d})),u&&_.push((0,e.createElement)(ce,{key:"visibloc-conditional-badge",label:(0,o.__)("Conditions actives","visi-bloc-jlg"),variant:"conditional",screenReaderText:(0,o.__)("Ce bloc applique des conditions de visibilité dynamiques.","visi-bloc-jlg"),description:p})),c&&_.push((0,e.createElement)(ce,{key:"visibloc-fallback-badge",label:(0,o.__)("Repli actif","visi-bloc-jlg"),variant:"fallback",screenReaderText:(0,o.__)("Le contenu de repli est affiché à la place du bloc original.","visi-bloc-jlg"),description:b})),(0,t.cloneElement)(g,g.props,[..._,...v])},"withVisibilityStatusBadges")),(0,l.addFilter)("editor.BlockListBlock.props","visi-bloc-jlg/add-editor-canvas-classes",function(e,t){if(!ve(t.name)||!t.attributes)return e;const{isHidden:i}=t.attributes,l=Ye(t.attributes),r=st(t.attributes).hasConditionalVisibility&&!i,a=[e.className,i?"bloc-editeur-cache":"",l?"bloc-editeur-repli":"",r?"bloc-editeur-conditionnel":""].filter(Boolean).join(" ");return{...e,className:a}});let Lt=At();(0,d.subscribe)(function(){const e=At();Mt(),e&&!Lt&&("function"==typeof Rt.flush?Rt.flush():Dt(),function(){if(!ut.size)return;const e=Array.from(ut.entries());ut.clear(),ft&&(window.cancelAnimationFrame(ft),ft=null),e.forEach(([e,t])=>{Tt(e,t)})}()),e?Nt():Lt&&(yt&&ht&&yt.unobserve(ht),yt&&yt.disconnect(),yt=null,ht=null,wt(!1)),Lt=e})})()})();