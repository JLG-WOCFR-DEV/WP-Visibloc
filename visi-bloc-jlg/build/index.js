(()=>{"use strict";const e=window.React,t=window.wp.element,l=window.wp.hooks,i=window.wp.compose,o=window.wp.blockEditor,n=window.wp.components,a=window.wp.i18n,r=window.wp.date,s=window.wp.data,c=["core/group"],u=e=>Array.isArray(e)?Array.from(new Set(e.map(e=>"string"==typeof e?e.trim():"").filter(Boolean))):[],d=u("object"==typeof VisiBlocData&&null!==VisiBlocData&&Array.isArray(VisiBlocData.supportedBlocks)?VisiBlocData.supportedBlocks:c),m=d.length>0?d:c,b=u((0,l.applyFilters)("visiblocSupportedBlocks",m)),p=b.length>0?b:m,v=e=>p.includes(e),g="function"==typeof r.__experimentalGetSettings?(0,r.__experimentalGetSettings)():{},{formats:y={}}=g||{},_="string"==typeof y.date&&y.date.trim()?y.date:"F j, Y",f="string"==typeof y.time&&y.time.trim()?y.time:"H:i",h="string"==typeof y.datetime&&y.datetime.trim()?y.datetime:`${_} ${f}`.trim(),j=(e=>{if(!e||"object"!=typeof e)return!1;if("boolean"==typeof e.twelveHourTime)return e.twelveHourTime;const{formats:t}=e;if(t&&"object"==typeof t){const{time:e}=t;if("string"==typeof e&&e.trim())return/a(?!\\)/i.test(e)}return!1})(g),E=(()=>{if(!g||"object"!=typeof g)return"UTC";const{timezone:e,timezoneAbbr:t,gmt_offset:l}=g;if(e&&"object"==typeof e){if("string"==typeof e.string&&e.string.trim())return e.string.trim();if("string"==typeof e.abbr&&e.abbr.trim())return e.abbr.trim()}if("string"==typeof e&&e.trim())return e.trim();if("string"==typeof t&&t.trim())return t.trim();return(e=>{if("number"!=typeof e||Number.isNaN(e))return"";if(0===e)return"UTC";const t=e>0?"+":"-",l=Math.abs(e),i=Math.round(60*l),o=Math.floor(i/60),n=i%60;return`UTC${t}${String(o).padStart(2,"0")}:${String(n).padStart(2,"0")}`})(l)||"UTC"})(),C=e=>e?"function"==typeof r.dateI18n?(0,r.dateI18n)(h,e):(0,r.format)(h,e):null,k=()=>(0,r.format)("Y-m-d\\TH:i:s",new Date),w=e=>{if(!e)return null;const t=new Date(e);return Number.isNaN(t.getTime())?null:t},A=[{label:(0,a.__)("Visible sur tous les appareils","visi-bloc-jlg"),value:"all"},{label:(0,a.__)("--- Afficher uniquement sur ---","visi-bloc-jlg"),value:"separator-show",disabled:!0},{label:(0,a.__)("Desktop Uniquement","visi-bloc-jlg"),value:"desktop-only"},{label:(0,a.__)("Tablette Uniquement","visi-bloc-jlg"),value:"tablet-only"},{label:(0,a.__)("Mobile Uniquement","visi-bloc-jlg"),value:"mobile-only"},{label:(0,a.__)("--- Cacher sur ---","visi-bloc-jlg"),value:"separator-hide",disabled:!0},{label:(0,a.__)("Caché sur Desktop","visi-bloc-jlg"),value:"hide-on-desktop"},{label:(0,a.__)("Caché sur Tablette","visi-bloc-jlg"),value:"hide-on-tablet"},{label:(0,a.__)("Caché sur Mobile","visi-bloc-jlg"),value:"hide-on-mobile"}],T=Object.freeze({post_type:{label:(0,a.__)("Type de contenu","visi-bloc-jlg")},taxonomy:{label:(0,a.__)("Taxonomie","visi-bloc-jlg")},template:{label:(0,a.__)("Modèle de page","visi-bloc-jlg")},recurring_schedule:{label:(0,a.__)("Horaire récurrent","visi-bloc-jlg")}}),S=Object.freeze(Object.keys(T)),B=S.map(e=>({value:e,label:T[e].label})),x=Object.freeze({logic:"AND",rules:[]}),D=Object.freeze({frequency:"daily",days:[],startTime:"08:00",endTime:"17:00"}),N=/^([01][0-9]|2[0-3]):([0-5][0-9])$/,V=(e,t=D.startTime)=>{if("string"!=typeof e)return t;const l=e.trim();return N.test(l)?l:t},q=e=>{if("object"!=typeof VisiBlocData||null===VisiBlocData)return[];const t=VisiBlocData[e];return Array.isArray(t)?t:[]},F=(()=>{const e=q("daysOfWeek"),t=new Map;return e.forEach(e=>{e&&"object"==typeof e&&"string"==typeof e.value&&t.set(e.value,e.label||e.value)}),t})(),O=new Set(Array.from(F.keys())),H=()=>`rule-${Math.random().toString(36).slice(2)}-${Date.now()}`,z=e=>S.includes(e)?e:S[0]||"post_type",M=e=>{if(!Array.isArray(e)||!e.length)return"";const t=e.find(e=>e&&void 0!==e.value);if(!t)return"";const l=void 0===t.value||null===t.value?"":t.value;return String(l)},R=e=>{switch(z(e)){case"taxonomy":return(()=>{const e=q("taxonomies").find(e=>e&&"string"==typeof e.slug);return{id:H(),type:"taxonomy",operator:"in",taxonomy:e?e.slug:"",terms:[]}})();case"template":return(()=>{const e=q("templates");return{id:H(),type:"template",operator:"is",value:M(e)}})();case"recurring_schedule":return{id:H(),type:"recurring_schedule",operator:"matches",...D};default:return(()=>{const e=q("postTypes");return{id:H(),type:"post_type",operator:"is",value:M(e)}})()}},$=e=>{if(!e||"object"!=typeof e)return null;const{type:t}=e;if(!S.includes(t))return null;const l={id:"string"==typeof e.id&&e.id?e.id:H(),type:t};return"post_type"===t?(l.operator="is_not"===e.operator?"is_not":"is",l.value="string"==typeof e.value?e.value:"",l):"taxonomy"===t?(l.operator="not_in"===e.operator?"not_in":"in",l.taxonomy="string"==typeof e.taxonomy?e.taxonomy:"",l.terms=Array.isArray(e.terms)?e.terms.map(e=>"string"==typeof e||"number"==typeof e?String(e):"").filter(Boolean):[],l):"template"===t?(l.operator="is_not"===e.operator?"is_not":"is",l.value="string"==typeof e.value?e.value:"",l):(l.operator="matches",l.frequency="weekly"===e.frequency?"weekly":"daily",l.days=Array.isArray(e.days)?Array.from(new Set(e.days.map(e=>"string"==typeof e?e:"").filter(e=>O.has(e)))):[],l.startTime=V(e.startTime,D.startTime),l.endTime=V(e.endTime,D.endTime),l)},L=e=>e&&"object"==typeof e?{logic:"OR"===e.logic?"OR":"AND",rules:Array.isArray(e.rules)?e.rules.map($).filter(Boolean):[]}:{logic:x.logic,rules:[...x.rules]},U=(0,i.createHigherOrderComponent)(l=>i=>{if(!v(i.name))return(0,e.createElement)(l,{...i});const{attributes:r,setAttributes:s,isSelected:c}=i,{isHidden:u,deviceVisibility:d,isSchedulingEnabled:m,publishStartDate:b,publishEndDate:p,visibilityRoles:g,advancedVisibility:y}=r,_=L(y),f=(0,t.useMemo)(()=>z(S[0]),[]),[h,T]=(0,t.useState)(f),x=z(h),N=(0,t.useMemo)(()=>B,[]),O=N.length>0,H=e=>{const t=L({..._}),l=e(t)||t;s({advancedVisibility:L(l)})},M=(e,t)=>{const l=e?[...g,t]:g.filter(e=>e!==t);s({visibilityRoles:l})};let U=(0,a.__)("Aucune programmation.","visi-bloc-jlg");const P=(0,a.sprintf)((0,a.__)("Fuseau horaire : %s","visi-bloc-jlg"),E),I=w(b),G=w(p),J=m&&!!I&&!!G&&G.getTime()<I.getTime();if(m){const e=C(b),t=C(p);
/* translators: 1: Start date, 2: end date. */
U=e&&t?(0,a.sprintf)((0,a.__)("Du %s au %s.","visi-bloc-jlg"),e,t):e?(0,a.sprintf)((0,a.__)("À partir du %s.","visi-bloc-jlg"),e):t?(0,a.sprintf)((0,a.__)("Jusqu'au %s.","visi-bloc-jlg"),t):(0,a.__)("Activée, mais sans date définie.","visi-bloc-jlg"),J&&(U=(0,a.__)("Dates de programmation invalides.","visi-bloc-jlg"))}return(0,e.createElement)(t.Fragment,null,(0,e.createElement)(l,{...i}),c&&(0,e.createElement)(t.Fragment,null,(0,e.createElement)(o.BlockControls,null,(0,e.createElement)(n.ToolbarGroup,null,(0,e.createElement)(n.ToolbarButton,{icon:"visibility",label:(0,a.__)("Rendre visible","visi-bloc-jlg"),onClick:()=>s({isHidden:!1}),isActive:!1===u}),(0,e.createElement)(n.ToolbarButton,{icon:"hidden",label:(0,a.__)("Rendre caché","visi-bloc-jlg"),onClick:()=>s({isHidden:!0}),isActive:!0===u}))),(0,e.createElement)(o.InspectorControls,null,(0,e.createElement)(n.PanelBody,{title:(0,a.__)("Contrôles de Visibilité","visi-bloc-jlg"),initialOpen:!0},(0,e.createElement)(n.SelectControl,{label:(0,a.__)("Visibilité par Appareil","visi-bloc-jlg"),value:d,options:A,onChange:e=>s({deviceVisibility:e})})),(0,e.createElement)(n.PanelBody,{title:(0,a.__)("Programmation","visi-bloc-jlg"),initialOpen:!1,className:"visi-bloc-panel-schedule"},(0,e.createElement)(n.ToggleControl,{label:(0,a.__)("Activer la programmation","visi-bloc-jlg"),checked:m,onChange:()=>s({isSchedulingEnabled:!m})}),m&&(0,e.createElement)("div",null,(0,e.createElement)("p",{style:{fontStyle:"italic",color:"#555"}},U),J&&(0,e.createElement)(n.Notice,{status:"error",isDismissible:!1},(0,a.__)("La date de fin doit être postérieure à la date de début.","visi-bloc-jlg")),(0,e.createElement)("p",{style:{fontStyle:"italic",color:"#555"}},P),(0,e.createElement)(n.CheckboxControl,{label:(0,a.__)("Définir une date de début","visi-bloc-jlg"),checked:!!b,onChange:e=>{s({publishStartDate:e?k():void 0})}}),!!b&&(0,e.createElement)("div",{className:"visi-bloc-datepicker-wrapper"},(0,e.createElement)(n.DateTimePicker,{currentDate:b,onChange:e=>s({publishStartDate:e}),is12Hour:j})),(0,e.createElement)(n.CheckboxControl,{label:(0,a.__)("Définir une date de fin","visi-bloc-jlg"),checked:!!p,onChange:e=>{s({publishEndDate:e?k():void 0})}}),!!p&&(0,e.createElement)("div",{className:"visi-bloc-datepicker-wrapper"},(0,e.createElement)(n.DateTimePicker,{currentDate:p,onChange:e=>s({publishEndDate:e}),is12Hour:j})))),(0,e.createElement)(n.PanelBody,{title:(0,a.__)("Visibilité par Rôle","visi-bloc-jlg"),initialOpen:!1},(0,e.createElement)("p",null,(0,a.__)("N'afficher que pour les rôles sélectionnés. Laisser vide pour afficher à tout le monde.","visi-bloc-jlg")),(0,e.createElement)(n.CheckboxControl,{label:(0,a.__)("Visiteurs Déconnectés","visi-bloc-jlg"),checked:g.includes("logged-out"),onChange:e=>M(e,"logged-out")}),(0,e.createElement)(n.CheckboxControl,{label:(0,a.__)("Utilisateurs Connectés (tous)","visi-bloc-jlg"),checked:g.includes("logged-in"),onChange:e=>M(e,"logged-in")}),(0,e.createElement)("hr",null),Object.entries(VisiBlocData.roles||{}).sort(([,e],[,t])=>String(e).localeCompare(String(t))).map(([t,l])=>(0,e.createElement)(n.CheckboxControl,{key:t,label:l,checked:g.includes(t),onChange:e=>M(e,t)}))),(0,e.createElement)(n.PanelBody,{title:(0,a.__)("Règles de visibilité avancées","visi-bloc-jlg"),initialOpen:!1},(0,e.createElement)(n.SelectControl,{label:(0,a.__)("Logique entre les règles","visi-bloc-jlg"),value:_.logic,options:[{value:"AND",label:(0,a.__)("Toutes les règles doivent être vraies (ET)","visi-bloc-jlg")},{value:"OR",label:(0,a.__)("Au moins une règle doit être vraie (OU)","visi-bloc-jlg")}],onChange:e=>H(t=>({...t,logic:"OR"===e?"OR":"AND"}))}),(0,e.createElement)(n.SelectControl,{label:(0,a.__)("Type de règle à ajouter","visi-bloc-jlg"),value:x,options:N,onChange:e=>T(z(e)),help:(0,a.__)("Sélectionnez le type de règle qui sera prérempli lors de l’ajout.","visi-bloc-jlg"),disabled:!O}),_.rules.map((t,l)=>((t,l)=>{const i=e=>{H(i=>{const o=[...i.rules];return o[l]=$({...t,...e}),{...i,rules:o}})},o=(0,e.createElement)(n.Flex,{align:"center",wrap:!0},(0,e.createElement)(n.FlexBlock,null,(0,e.createElement)(n.SelectControl,{label:(0,a.__)("Type de règle","visi-bloc-jlg"),value:t.type,options:N,onChange:e=>{const i=z(e);H(e=>{const o=[...e.rules],n={...R(i),id:t.id};return o[l]=n,{...e,rules:o}})}})),(0,e.createElement)(n.FlexItem,null,(0,e.createElement)(n.Button,{isDestructive:!0,variant:"tertiary",onClick:()=>{H(e=>{const t=e.rules.filter((e,t)=>t!==l);return{...e,rules:t}})}},(0,a.__)("Supprimer","visi-bloc-jlg"))));if("post_type"===t.type){const l=q("postTypes").map(e=>({value:e.value,label:e.label}));return(0,e.createElement)("div",{key:t.id,className:"visibloc-advanced-rule"},o,(0,e.createElement)(n.SelectControl,{label:(0,a.__)("Condition","visi-bloc-jlg"),value:t.operator,options:[{value:"is",label:(0,a.__)("Est","visi-bloc-jlg")},{value:"is_not",label:(0,a.__)("N’est pas","visi-bloc-jlg")}],onChange:e=>i({operator:e})}),(0,e.createElement)(n.SelectControl,{label:(0,a.__)("Type de contenu","visi-bloc-jlg"),value:t.value,options:l,onChange:e=>i({value:e})}))}if("taxonomy"===t.type){const l=q("taxonomies"),r=l.find(e=>e.slug===t.taxonomy),s=l.map(e=>({value:e.slug,label:e.label})),c=(r&&Array.isArray(r.terms)?r.terms:[]).map(e=>({value:e.value,label:e.label})),u=(e,l)=>{const o=String(l),n=e?[...t.terms,o]:t.terms.filter(e=>e!==o);i({terms:n})};return(0,e.createElement)("div",{key:t.id,className:"visibloc-advanced-rule"},o,(0,e.createElement)(n.SelectControl,{label:(0,a.__)("Taxonomie","visi-bloc-jlg"),value:t.taxonomy,options:s,onChange:e=>i({taxonomy:e,terms:[]})}),(0,e.createElement)(n.SelectControl,{label:(0,a.__)("Condition","visi-bloc-jlg"),value:t.operator,options:[{value:"in",label:(0,a.__)("Inclut au moins un terme","visi-bloc-jlg")},{value:"not_in",label:(0,a.__)("Exclut tous les termes","visi-bloc-jlg")}],onChange:e=>i({operator:e})}),c.length>0?(0,e.createElement)("div",{className:"visibloc-advanced-rule__terms"},c.map(l=>(0,e.createElement)(n.CheckboxControl,{key:l.value,label:l.label,checked:t.terms.includes(l.value),onChange:e=>u(e,l.value)}))):(0,e.createElement)("p",{className:"components-help-text"},(0,a.__)("Aucun terme disponible pour cette taxonomie.","visi-bloc-jlg")))}if("template"===t.type){const l=q("templates").map(e=>({value:e.value,label:e.label}));return(0,e.createElement)("div",{key:t.id,className:"visibloc-advanced-rule"},o,(0,e.createElement)(n.SelectControl,{label:(0,a.__)("Condition","visi-bloc-jlg"),value:t.operator,options:[{value:"is",label:(0,a.__)("Est","visi-bloc-jlg")},{value:"is_not",label:(0,a.__)("N’est pas","visi-bloc-jlg")}],onChange:e=>i({operator:e})}),(0,e.createElement)(n.SelectControl,{label:(0,a.__)("Modèle","visi-bloc-jlg"),value:t.value,options:l,onChange:e=>i({value:e})}))}const r=e=>t=>{const l=t&&t.target?t.target.value:"",o="string"==typeof l?l:"";i({[e]:o})},s=V(t.startTime,D.startTime)===V(t.endTime,D.endTime),c="weekly"===t.frequency&&(!Array.isArray(t.days)||0===t.days.length);return(0,e.createElement)("div",{key:t.id,className:"visibloc-advanced-rule"},o,(0,e.createElement)(n.SelectControl,{label:(0,a.__)("Fréquence","visi-bloc-jlg"),value:t.frequency,options:[{value:"daily",label:(0,a.__)("Quotidien","visi-bloc-jlg")},{value:"weekly",label:(0,a.__)("Hebdomadaire","visi-bloc-jlg")}],onChange:e=>i({frequency:e,days:"weekly"===e?t.days:[]})}),(0,e.createElement)(n.Flex,{gap:"small"},(0,e.createElement)(n.FlexBlock,null,(0,e.createElement)(n.BaseControl,{label:(0,a.__)("Heure de début","visi-bloc-jlg")},(0,e.createElement)("input",{type:"time",value:t.startTime||"",onChange:r("startTime"),className:"components-text-control__input"}))),(0,e.createElement)(n.FlexBlock,null,(0,e.createElement)(n.BaseControl,{label:(0,a.__)("Heure de fin","visi-bloc-jlg")},(0,e.createElement)("input",{type:"time",value:t.endTime||"",onChange:r("endTime"),className:"components-text-control__input"})))),s&&(0,e.createElement)(n.Notice,{status:"warning",isDismissible:!1},(0,a.__)("L’heure de début et la fin sont identiques. Ajustez-les pour activer la règle.","visi-bloc-jlg")),"weekly"===t.frequency&&F.size>0&&(0,e.createElement)("div",{className:"visibloc-advanced-rule__days"},(0,e.createElement)("p",{className:"components-base-control__label"},(0,a.__)("Jours actifs","visi-bloc-jlg")),Array.from(F.entries()).map(([l,o])=>(0,e.createElement)(n.CheckboxControl,{key:l,label:o,checked:t.days.includes(l),onChange:e=>((e,l)=>{const o=e?[...new Set([...t.days,l])]:t.days.filter(e=>e!==l);i({days:o})})(e,l)})),c&&(0,e.createElement)(n.Notice,{status:"warning",isDismissible:!1},(0,a.__)("Sélectionnez au moins un jour pour une fréquence hebdomadaire.","visi-bloc-jlg"))))})(t,l)),(0,e.createElement)(n.Button,{variant:"secondary",disabled:!O,onClick:()=>H(e=>({...e,rules:[...e.rules,R(x)]}))},(0,a.__)("Ajouter une règle","visi-bloc-jlg")),(0,e.createElement)("p",{className:"components-help-text"},(0,a.__)("Ces règles permettent d’affiner la visibilité selon le contexte du contenu, le modèle ou un horaire récurrent.","visi-bloc-jlg"))))))},"withVisibilityControls"),P=new Map,I=new Map;let G=null;function J(){const e=(0,s.select)("core/edit-post");return!!e&&("function"==typeof e.isListViewOpened?e.isListViewOpened():"function"==typeof e.isFeatureActive&&e.isFeatureActive("listView"))}function Y(){if("undefined"==typeof document)return void(G=null);const e=new Map;I.forEach((t,l)=>{const i=document.querySelector(`.block-editor-list-view__block[data-block="${l}"]`);i?t?i.classList.add("bloc-editeur-cache"):i.classList.remove("bloc-editeur-cache"):e.set(l,t)}),I.clear(),e.size&&e.forEach((e,t)=>{I.set(t,e)}),G=I.size&&J()?window.requestAnimationFrame(()=>{Y()}):null}function Q(e,t){I.get(e)!==t&&(I.set(e,t),G||(G=window.requestAnimationFrame(()=>{Y()})))}(0,l.addFilter)("blocks.registerBlockType","visi-bloc-jlg/add-visibility-attributes",function(e,t){return v(t)?(e.attributes={...e.attributes,isHidden:{type:"boolean",default:!1},deviceVisibility:{type:"string",default:"all"},isSchedulingEnabled:{type:"boolean",default:!1},publishStartDate:{type:"string"},publishEndDate:{type:"string"},visibilityRoles:{type:"array",default:[]},advancedVisibility:{type:"object",default:x}},e):e}),(0,l.addFilter)("editor.BlockEdit","visi-bloc-jlg/with-visibility-controls",U),(0,l.addFilter)("blocks.getSaveContent.extraProps","visi-bloc-jlg/add-save-classes",function(e,t,l){if(!v(t.name)||!l)return e;const{deviceVisibility:i}=l,o=[e.className,i&&"all"!==i?`vb-${i}`:""].filter(Boolean).join(" ");return{...e,className:o}}),(0,l.addFilter)("editor.BlockListBlock.props","visi-bloc-jlg/add-editor-canvas-classes",function(e,t){if(!v(t.name)||!t.attributes)return e;const{isHidden:l}=t.attributes,i=[e.className,l?"bloc-editeur-cache":""].filter(Boolean).join(" ");return{...e,className:i}});let W=J();(0,s.subscribe)(function(){const e=J();!function(){const e=(0,s.select)("core/block-editor");if(!e)return;const t=e.getBlockOrder();if(!t.length)return;const l=[...t],i=new Set;for(;l.length;){const t=l.pop(),o=e.getBlock(t);if(o){if(v(o.name)){const e=Boolean(o.attributes.isHidden);P.get(t)!==e&&Q(t,e),P.set(t,e),i.add(t)}o.innerBlocks&&o.innerBlocks.length&&o.innerBlocks.forEach(e=>{e&&e.clientId&&l.push(e.clientId)})}}i.size!==P.size&&Array.from(P.keys()).forEach(e=>{i.has(e)||(P.delete(e),I.delete(e))})}(),e&&!W&&function(){if(!I.size)return;const e=Array.from(I.entries());I.clear(),G&&(window.cancelAnimationFrame(G),G=null),e.forEach(([e,t])=>{Q(e,t)})}(),W=e})})();